1                                                          The SAS System                              13:55 Tuesday, March 13, 2018

NOTE: Copyright (c) 2002-2012 by SAS Institute Inc., Cary, NC, USA. 
NOTE: SAS (r) Proprietary Software 9.4 (TS1M3) 
      Licensed to UNIVERSITY OF SOUTHERN CALIFORNIA-SFA-T&R, Site 70095270.
NOTE: This session is executing on the Linux 3.10.0-514.10.2.el7.x86_64 (LIN X64) platform.



NOTE: Updated analytical products:
      
      SAS/STAT 14.1
      SAS/ETS 14.1
      SAS/OR 14.1
      SAS/IML 14.1
      SAS/QC 14.1

NOTE: Additional host information:

 Linux LIN X64 3.10.0-514.10.2.el7.x86_64 #1 SMP Mon Feb 20 02:37:52 EST 2017 x86_64 Red Hat Enterprise Linux Server release 7.3 
      (Maipo) 

You are running SAS 9. Some SAS 8 files will be automatically converted 
by the V9 engine; others are incompatible.  Please see 
http://support.sas.com/rnd/migration/planning/platform/64bit.html

PROC MIGRATE will preserve current SAS file attributes and is 
recommended for converting all your SAS libraries from any 
SAS 8 release to SAS 9.  For details and examples, please see
http://support.sas.com/rnd/migration/index.html


This message is contained in the SAS news file, and is presented upon
initialization.  Edit the file "news" in the "misc/base" directory to
display site-specific news and information in the program log.
The command line option "-nonews" will prevent this display.




NOTE: SAS initialization used:
      real time           0.25 seconds
      cpu time            0.02 seconds
      
1          /*System Options*/
2          options mprint linesize=150 pagesize=50 compress=yes reuse=no symbolgen ERRORS=0 noquotelenmax validvarname=v7 LRECL=32767;
3          
4          /***********************/
5          /*    User Inputs      */
6          /***********************/
2                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

7          
8          /*
9          1) Edit DMID and Site ID
10         */
11         %LET DMID=C3;
12         %LET SITEID=USC;
13         
14            /*-------------------------------------------------------------------*\
15            ||                                                                   ||
16            ||  DATA PARTNERS                                 DMID      SITEID   ||
17            ||  -----------------------------------------------------------------||
18            ||  Cook County								    C9          CC   	||
19            ||  Loyola Medicine								C9			LM		||
20            ||  Lurie Children's								C9			LC		||
21            ||  Northshore									C9			NS		||
22            ||  Northwestern Medicine						C9			NW		||
23            ||  Rush											C9			RU		||
24            ||  U of Chicago									C9			UC		||
25            ||  U of Illinois								C9			UI		||
26            ||  Alliance Chicago								C9			AC		||
27            ||  ADVANCE      								C10			ADV		||
28            ||  Children's Mercy								C4			CMH    	||
29            ||  Indiana U Regenstief							C4          REG 	||
30            ||  Marshfield Clinic							C4			MCRF	||
31            ||  Med Coll Wisconsin							C4			MCW		||
32            ||  U of Iowa									C4			UI      ||
33            ||  U of Kansas                                  C4          UK		||
34            ||  U of Minnesota AHC 							C4			UMA		||
35            ||  U of Missouri HC								C4			UMO		||
36            ||  U of Nebraska								C4			UN		||
37            ||  UT HSC San Antonio							C4			UTHSCSA ||
38            ||  UT SW Med Ctr								C4			UTSW	||
39            ||  UW Madison									C4			UWM		||
40            ||  Allina Health								C12			AH		||
41            ||  Arizona State U								C12			ASU		||
42            ||  Essentia Health								C12			EH		||
43            ||  Intermountain HC								C12			IHC		||
44            ||  Mayo Clinic									C12			MC		||
45            ||  Ohio State U									C12			OSU		||
46            ||  U of Michigan								C12			UMI		||
47            ||  DUKE											C2			DUKE	||
48            ||  Health Science SC							C2			HSSC	||
49            ||  Meharry										C2			MEH		||
50            ||  UNC											C2			UNC		||
51            ||  Vanderbilt									C2			VAN		||
52            ||  VHAN											C2			VHAN	||
53            ||  NYGC											C8			NYC		||
54            ||  OneFlorida									C13			OF		||
3                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

55            ||  Geisinger									C11			GS		||
56            ||  Johns Hopkins								C11         JHU		||
57            ||  Penn State Med Ctr							C11			PSH		||
58            ||  Temple University 							C11			TU		||
59            ||  UPMC Claims									C11			UPMC2	||
60            ||  UPMC											C11			UPMC 	||
61            ||  Cincinnati Children's						C7			CCHMC	||
62            ||  PEDSnet										C7			CPED	||
63            ||  Denver Health								C5			DH		||
64            ||  Health Partners								C5			HP		||
65            ||  KPCO											C5			KPCO	||
66            ||  KPMA											C5			KPMA    ||
67            ||  KPWA											C5          KPWA    ||
68            ||  KPNC											C5			KPNC	||
69            ||  KPNW											C5			KPNW	||
70            ||  KPSC											C5			KPSC	||
71            ||  Cedars Sinai									C3			CS		||
72            ||  San Mateo Med Ctr						    C3          SM		||
73            ||  UC Davis										C3			UCD		||
74            ||  UC Irvine									C3			UCI		||
75            ||  UCSD											C3			UCSD	||
76            ||  VA-Vinci										C3          VAV		||
77            ||  Baylor SW North								C6			BAY		||
78            ||  Ochsner										C6			OCH		||
79            ||  Pennington/LSU								C6			PLSU	||
80            ||  Tulane										C6			TUL		||
81            ||  Beth Israel									C1			BID		||
82            ||  Boston Children's							C1			BCH		||
83            ||  Boston Medical								C1			BMC		||
84            ||  Grady										C1			GRD		||
85            ||  Morehouse									C1			MHS		||
86            ||  Partners Health								C1			PHS		||
87            ||  UTHealth										C1			UTH		||
88            ||  Wake Forest									C1			WF	    ||
89            ||  UCLA											C3			UCLA    ||
90            ||  Wash U BJC									C1			WU      ||
91            ||  USC										    C3			USC	    ||
92            ||  UCSF     									C3          UCSF    ||
93         	\*-------------------------------------------------------------------*/
94         /*
95         2) Edit this section to reflect your name for each Table/File (or View)
96         */
97         
98         %let ENRTABLE=;			             /*Not needed for this request*/
99         %let DEMTABLE=demographic;
100        %let DISTABLE=;			             /*Not needed for this request*/
101        %let DIATABLE=diagnosis;
102        %let PROCTABLE=;         			 /*Not needed for this request*/
4                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

103        %let ENCTABLE=encounter;
104        %let VITTABLE=;						 /*Not needed for this request*/
105        %let PRESCTABLE=; 					 /*Not needed for this request*/
106        %let LABTABLE=;						 /*Not needed for this request*/
107        %let DEATHTABLE=;					 /*Not needed for this request*/
108        
109        
110        
111        /*
112        3) Edit this section to define the macro parameters;
113        */
114        
115        *Values below the THRESHOLD parameter will be considered as low cell count.;
116        *If left empty, the program will assign a default value of 11;
117        %let THRESHOLD=11;
118        *select Y if you want the attrition table to be populated in the DRNOC folder and report or N if you
119         wish to opt out;
120        %let ATTRITIONTABLE=Y;
121        
122        /*
123        4) Edit this section to reflect locations for the libraries/folders for PCORNET Data
124           and Output folders
125        */
126        /********** FOLDER CONTAINING INPUT DATA FILES AND MSCDM DATA ***************************************/
127        /* IMPORTANT NOTE: end of path separators are needed;                                               */
128        /*   Windows-based platforms:    "\", e.g. "C:\user\sas\" and not "C:\user\sas";                    */
129        /*   Unix-based platforms:      "/", e.g."/home/user/sas/" and not "/home/user/sas";                */
130        /*                                                                                                  */
131        /********** FOLDER CONTAINING INPUT DATA FILES AND MSCDM DATA ***************************************/;
132        /*Data in MSCDM Format*/          libname indata '/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/data/pcornet_1_24_18/';
NOTE: Libref INDATA was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/data/pcornet_1_24_18
133        								
134        /*NDC/ICD9 Codes File Location*/  %LET
134      ! infolder=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/;								
135        /*SAS Output Files*/              libname infolder "&infolder.";
SYMBOLGEN:  Macro variable INFOLDER resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/
NOTE: Libref INFOLDER was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder
136        
137        /*Macro Files Location*/          %let
137      ! sasmacr=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/;
138        
139        /********** FOLDER CONTAINING SUMMARY FILES TO BE EXPORTED TO OPERATION CENTER (DRNOC)*/;
140        /*CSV Output Files*/              %LET
5                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

140      ! DRNOC=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/drnoc/;
141        /*SAS Output Files*/              libname DRNOC "&DRNOC.";
SYMBOLGEN:  Macro variable DRNOC resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/drnoc/
NOTE: Libref DRNOC was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/drnoc
142        
143        /*********** FOLDER CONTAINING FINAL DATASETS TO BE KEPT LOCAL AT THE PARTNER SITE (DMLocal)**********/;
144        /*CSV Output Files*/              %LET
144      ! DMLocal=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/dmlocal/;
145        /*SAS Output Files*/              libname DMLocal "&DMLocal.";
SYMBOLGEN:  Macro variable DMLOCAL resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/dmlocal/
NOTE: Libref DMLOCAL was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/dmlocal
146        
147        
148        /*---------------------------------------------------------------------------------------------------*/
149        /*                                       End of User Inputs                                          */
150        /*---------------------------------------------------------------------------------------------------*/
151        
152        /*****************************************************************************************************/
153        /**************************** PLEASE DO NOT EDIT CODE BELOW THIS LINE ********************************/
154        /*****************************************************************************************************/
155        
156        *Modular program;
157        %include "&sasmacr.pcornet_mp1.sas" / source2;
SYMBOLGEN:  Macro variable SASMACR resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/
NOTE: %INCLUDE (level 1) file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pcornet_mp1.sas 
      is file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pcornet_mp1.sas.
158       +%MACRO MODULARPROGRAM1(REQUESTID=,RUNID=,ENROLGAP=,COVERAGE=,QUERYFROM=,QUERYTO=,QUERYFILE=,
159       +                       INCQUERYFILE=,CONDFILE=,OUTTABLESFILE=,AGESTRAT=,SEX=,HISPANIC=,RACE=,
160       +					   ENROPTION=,AGECALC=,THRESHOLD=,EB2DAYS=,EB2ENCNUMS=,EB2ENCLIST=,
161       +                       RequestName=,QueryName=,KeepDMLocal=Y,DENSTRAT=);
162       +
163       +proc printto log="&DRNOC.&REQUESTID.&RUNID..log" new;
164       +run;
165       +
166       +%LET DMID=%LOWCASE(&DMID.);
167       +%LET SITEID=%LOWCASE(&SITEID.);
168       +%LET REQUESTID=%LOWCASE(&REQUESTID.);
169       +%LET RUNID=%LOWCASE(&RUNID.);
170       +%LET COVERAGE=%UPCASE(&COVERAGE.);
6                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

171       +%LET QUERYFILE=%LOWCASE(&QUERYFILE.);
172       +%LET INCQUERYFILE=%LOWCASE(&INCQUERYFILE.);
173       +%LET CONDFILE=%LOWCASE(&CONDFILE.);
174       +%LET OUTTABLESFILE=%LOWCASE(&OUTTABLESFILE.);
175       +%LET SEX=%UPCASE(&SEX.);
176       +%LET HISPANIC=%UPCASE(&HISPANIC.);
177       +%LET RACE=%UPCASE(&RACE.);
178       +%LET ENROPTION=%UPCASE(&ENROPTION.);
179       +%LET AGECALC=%UPCASE(&AGECALC.);
180       +%LET EB2ENCLIST=%UPCASE(&EB2ENCLIST.);
181       +%LET DENSTRAT=%UPCASE(&DENSTRAT.);
182       +%LET ATTRITIONTABLE=%UPCASE(&ATTRITIONTABLE.);
183       +
184       +%PUT "MODULARPROGRAM1_V2.12";
185       +
186       +%let MPVer=2.12;
187       +%let MPNum=1;
188       +
189       +/*---------------------------------------------------------------------------------------------------*/
190       +/* 0.0 Preprocess user inputs                                                                        */
191       +/*---------------------------------------------------------------------------------------------------*/
192       +
193       +/*Empty work*/
194       +proc datasets NOLIST NOWARN library=WORK;
195       +   delete _:;
196       +quit;
197       +
198       +/*---------------------------------------------------------------------------------------------------*\
199       +|   Program name: Attrition table Tool.                                                               |
200       +|                                                                                                     |
201       +|   Date: 04/02/2013                                                                                  |
202       +|   Version: 1.0                                                                                      |
203       +|                                                                                                     |
204       +|-----------------------------------------------------------------------------------------------------|
205       +|                                                                                                     |
206       +|   For a MP or a task order, a cohort is created by applying a set of inclusion/exclusion criteria   |
207       +|   to a group of members. It is often useful to see how a cohort evolves after successively          |
208       +|   applying these filters. The attrition table tool will enable the requester to summarize this      |
209       +|   information in a single output table.                                                             |
210       +|                                                                                                     |
211       +|-----------------------------------------------------------------------------------------------------|
212       +|                                                                                                     |
213       +|   Program inputs:                                                                                   |
214       +|                  -SAS data file with inclusion/exclusion criteria dummy variables                   |
215       +|                                                                                                     |
216       +|   Program outputs:                                                                                  |
217       +|                  -SAS data file (.SAS7BDAT format) containing the attrition table                   |
218       +|                                                                                                     |
7                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

219       +|   Macro variable definitions:                                                                       |
220       +|   INFILE         = Source data set with inclusion/exclusion criteria dummy variables                |
221       +|   CRITFLAG       = Variable used to identify inclusions/exclusions                                  |
222       +|   CLASSVARS      = Variable used to identify count unit                                             |
223       +|   WHERE          = Variable to identify extra conditions                                            |
224       +|   EXCLUDEDVAR    = Name of the variable used to flag observations as excluded in the INFILE         |
225       +|   OUTFILE        = Name of the attrition table                                                      |
226       +|   CRITDESC       = Title for an inclusion/exclusion in the OUTFILE                                  |
227       +|   CRITNUM        = Inclusion/exclusion number in the OUTFILE                                        |
228       +|   CRITCNTNAME    = Name of the count variable                                                       |
229       +|   ADDITIONALVARS = Additional variables to add to the OUTFILE                                       |
230       +|                                                                                                     |
231       +\*---------------------------------------------------------------------------------------------------*/
232       +
233       +
234       +%macro MS_ATTRITIONTABLE(INFILE=,CRITFLAG=,CLASSVARS=,WHERE=,EXCLUDEDVAR=,OUTFILE=,
235       +                         CRITDESC=,CRITNUM=,CRITCNTNAME=,ADDITIONALVARS=);
236       +
237       +	%macro commonblock(BLOKIN=,BLOCKWHERE=);
238       +
239       +        %let SELECT_COUNTS=.;
240       +
241       +		proc sql noprint;	
242       +			/*Count the number of observations where the criterion applies*/
243       +			select sum(&CRITFLAG.)
244       +			into :SELECT_COUNTS
245       +			from &BLOKIN.
246       +			where &BLOCKWHERE.;
247       +		quit;
248       +
249       +		%if %length(&SELECT_COUNTS.) =0 %then %do;
250       +            %let SELECT_COUNTS=.;
251       +		%end;
252       +
253       +	  	/*Add an empty row into the outfile*/
254       +	  	proc sql noprint;
255       +	  		insert into &OUTFILE. (&CRITCNTNAME.) values(0);	  	
256       +		quit;
257       +
258       +		/*Update the outfile with the criterion counts*/
259       +		data &OUTFILE.;
260       +		set &OUTFILE. end=eof;
261       +		if eof then do;
262       +			&ADDITIONALVARS.;
263       +			CritNum=&CRITNUM.;
264       +			CritDesc=&CRITDESC.;
265       +			&CRITCNTNAME.=max(&SELECT_COUNTS.,0);		
266       +		end;
8                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

267       +		run;
268       +
269       +	%mend commonblock;
270       +
271       +
272       +	%if %upcase(%str("&EXCLUDEDVAR.")) ne %str("") %then %do;
273       +		%if %upcase(%str("&CLASSVARS.")) ne %str("") %then %do;
274       +		    /*Count the number of dimensions in the class variable*/
275       +			%let DIMCNT = %SYSFUNC(COUNTW(&CLASSVARS.));
276       +			%put &DIMCNT;
277       +
278       +			data _dimcnt;
279       +        	format classvars $30.;
280       +			do i = 1 to &DIMCNT.;
281       +        		classvars = compress("'"||compress(scan("&CLASSVARS.",&DIMCNT.))||"'");
282       +				output;
283       +			end;
284       +			drop i;
285       +			run;
286       +
287       +			proc sql noprint;
288       +				select classvars
289       +				into :HKVAR separated by ','
290       +				from _dimcnt;
291       +			quit;
292       +			%put &HKVAR.;
293       +	
294       +			/*To collapse according to class variable*/
295       +			proc means noprint data = &INFILE. nway;
296       +			var &CRITFLAG.;
297       +			class &CLASSVARS.;
298       +			where &where. and not &EXCLUDEDVAR.;
299       +			output out=_tempattrition(drop=_:) max = ;
300       +			run;
301       +
302       +			/*Generate counts*/
303       +			%commonblock(BLOKIN=_tempattrition,BLOCKWHERE=&CRITFLAG.);
304       +
305       +			/*Update of exclusion flag in the infile*/
306       +			data _exculdedkey;
307       +			set _tempattrition(where=(&CRITFLAG.) keep = &CLASSVARS. &CRITFLAG.);
308       +			rename &CRITFLAG. = _&EXCLUDEDVAR.;
309       +			run;
310       +
311       +			data &INFILE.(drop=_&EXCLUDEDVAR.);
312       +   			if 0 then set _exculdedkey;
313       +   			declare hash ht (hashexp:16, dataset:'_exculdedkey');
314       +   			ht.definekey(&HKVAR.);
9                                                                   The SAS System                                       13:55 Tuesday, March 13, 2018

315       +   			ht.definedata(ALL: 'YES');
316       +   			ht.definedone();
317       +
318       +   			do until(eof1);
319       +      			set &INFILE. end=eof1;
320       +      			if ht.find()=0 then do;
321       +         			&EXCLUDEDVAR. = _&EXCLUDEDVAR.;
322       +      			end;
323       +				output;
324       +   			end;
325       +   			stop;
326       +			run;
327       +		%end;
328       +		%else %do;
329       +            /*Generate counts*/
330       +			%commonblock(BLOKIN=&INFILE.,BLOCKWHERE=&where. and &CRITFLAG. and not &EXCLUDEDVAR.);
331       +
332       +			/*Update of exclusion flag in the infile*/
333       +			data &infile.;
334       +			set &infile.;			
335       +			if &where. and &CRITFLAG. then &EXCLUDEDVAR.=1;		
336       +			run;
337       +		%end;
338       +	%end;
339       +	%else %do;
340       +		%if %upcase(%str("&CLASSVARS.")) ne %str("") %then %do;
341       +            /*Count the number of dimensions in the class variable*/
342       +			%let DIMCNT = %SYSFUNC(COUNTW(&CLASSVARS.));
343       +			%put &DIMCNT;
344       +
345       +			data _dimcnt;
346       +        	format classvars $30.;
347       +			do i = 1 to &DIMCNT.;
348       +        		classvars = compress("'"||compress(scan("&CLASSVARS.",&DIMCNT.))||"'");
349       +				output;
350       +			end;
351       +			drop i;
352       +			run;
353       +
354       +			proc sql noprint;
355       +				select classvars
356       +				into :HKVAR separated by ','
357       +				from _dimcnt;
358       +			quit;
359       +			%put &HKVAR.;
360       +	
361       +			/*To collapse according to class variable*/
362       +			proc means noprint data = &INFILE. nway;
10                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

363       +			var &CRITFLAG.;
364       +			class &CLASSVARS.;
365       +			where &where.;
366       +			output out=_tempattrition(drop=_:) max = ;
367       +			run;
368       +
369       +			/*Generate counts*/
370       +			%commonblock(BLOKIN=_tempattrition,BLOCKWHERE=&CRITFLAG.);
371       +		%end;
372       +		%else %do;
373       +		    /*Generate counts*/
374       +			%commonblock(BLOKIN=&INFILE.,BLOCKWHERE=&where. and &CRITFLAG.);
375       +		%end;
376       +	%end;
377       +
378       +%mend MS_ATTRITIONTABLE;
379       +
380       +/*Set default values*/
381       +%MACRO WRAPPER;
382       +	%IF %STR("&AGESTRAT.")=%STR("") %THEN %DO;
383       +		%LET AGESTRAT=00-01 02-04 05-09 10-14 15-18 19-21 22-44 45-64 65-74 75+;
384       +	%END;
385       +	%IF %STR("&ENROLGAP.")=%STR("") %THEN %DO;
386       +		%LET ENROLGAP=0;
387       +	%END;
388       +	%IF %STR("&COVERAGE.")=%STR("") OR (%STR("&COVERAGE.") ne %STR("MD") AND %STR("&COVERAGE.") ne %STR("M") AND %STR("&COVERAGE.") ne
388      !+%STR("D")) %THEN %DO;
389       +		%LET COVERAGE=MD;
390       +	%END;
391       +options nosymbolgen nomprint;
392       +	%IF %STR(&THRESHOLD.) = %STR() or %LENGTH(&THRESHOLD.) = 0. %THEN %DO;
393       +		%LET THRESHOLD=11;
394       +	%END;
395       +options symbolgen mprint;
396       +	%IF %STR(&EB2ENCLIST.) = %STR() or %LENGTH(&EB2ENCLIST.) = 0. %THEN %DO;
397       +		%LET EB2ENCLIST='' 'AV' 'ED' 'EI' 'IP' 'IS' 'OS' 'IC' 'OA' 'NI' 'UN' 'OT';
398       +	%END;
399       +	%IF %STR(&DENSTRAT.) = %STR() or %LENGTH(&DENSTRAT.) = 0. %THEN %DO;
400       +		%LET DENSTRAT='S';
401       +	%END;
402       +%MEND WRAPPER;
403       +%WRAPPER;
404       +
405       +%MACRO WORDNUMARG(VECTOR,OUTNAME); /*Macro to count words in a macro VECTOR*/
406       +	%GLOBAL &OUTNAME.;
407       +	%LET NUMARG=0;
408       +	%DO %WHILE(%QSCAN(&VECTOR,&NUMARG+1,%STR( )) ne %STR());
409       +		%LET NUMARG = %EVAL(&NUMARG+1);
11                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

410       +	%END;
411       +	%LET &OUTNAME.=&NUMARG.;
412       +%MEND WORDNUMARG;
413       +%WORDNUMARG(&AGESTRAT.,NUMAGECAT); /*Age Stratification*/
414       +
415       +%PUT &NUMAGECAT.;
416       +
417       +%global MINAGE;
418       +%global MAXAGE;
419       +
420       +data _null_;
421       +	format AGETHRESH $1000. AGETYP $1000.;
422       +	do i=1 to &NUMAGECAT.;
423       +		_agetyp=compress(scan("&AGESTRAT.",i*2-1),'DWMQY','klu');
424       +
425       +		_agetyp=TRANWRD(UPCASE(_agetyp), 'Y','Years');
426       +		_agetyp=TRANWRD(UPCASE(_agetyp), 'D','Days');
427       +		_agetyp=TRANWRD(UPCASE(_agetyp), 'W','Weeks');
428       +		_agetyp=TRANWRD(UPCASE(_agetyp), 'Q','Quarters');
429       +		_agetyp=TRANWRD(UPCASE(_agetyp), 'M','Months');
430       +
431       +		if _agetyp ne '' then    AGETYP=strip(AGETYP)||" "||strip(_AGETYP);
432       +		else    AGETYP=strip(AGETYP)||' Years';
433       +
434       +		AGETHRESH=strip(AGETHRESH)||" "||compress(scan("&AGESTRAT.",i*2-1),'DWMQY','lu');
435       +		if i=1 then MinAge=input(AgeThresh,best.);
436       +		if i=&NUMAGECAT. then do;
437       +		 	MAXAGE=input(compress(scan("&AGESTRAT.",i*2),'DWMQY','lu'),best.);;
438       +			if MAXAGE=. then MAXAGE=99999;
439       +		end;
440       +		output;
441       +	end;
442       +	call symputx('AGETHRESH',AGETHRESH);
443       +	call symputx('AGETYP',AGETYP);
444       +	call symputx('MINAGE',MINAGE);
445       +	call symputx('MAXAGE',MAXAGE);
446       +run;
447       +
448       +%PUT &AGETHRESH.;
449       +%PUT &AGETYP.;
450       +%PUT &NUMAGECAT.;
451       +%PUT &MINAGE.;
452       +%PUT &MAXAGE.;
453       +
454       +/*Set macro variables for study dates*/
455       +data _NULL_;
456       +	temp=DATETIME();
457       +	call symputx('START',temp);
12                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

458       +	call symputx('STARTDATE',put(datepart(temp),date9.));
459       +	call symputx('STARTTIME',put(timepart(temp),time4.));
460       +run;
461       +
462       +data _null_ ;
463       +	call Symputx('QUERYFROMc',"&QUERYFROM.");
464       +	call Symputx('QUERYTOc',"&QUERYTO.");
465       +	call Symputx('QUERYFROM',put(input("&QUERYFROM" , mmddyy10.),best12.));
466       +	call Symputx('QUERYTO',put(input("&QUERYTO",mmddyy10.),best12.));
467       +run;
468       +
469       +%PUT &QUERYFROM;
470       +%PUT &QUERYTO;
471       +
472       +data _null_;
473       +	call symputx("NUMPER",trim(left(intck("Months",&QUERYFROM.,&QUERYTO.)+1)));
474       +	call symputx("NUMYEARS",trim(left(intck('Years',&QUERYFROM.,&QUERYTO.)+1)));
475       +	call symputx("NUMMONTHS",trim(left(intck('Months',&QUERYFROM.,&QUERYTO.)+1)));
476       +	call symputx("FROMY",trim(left(year(&QUERYFROM.))));
477       +	call symputx("TOY",trim(left(year(&QUERYTO.))));
478       +	call symputx("FROMMO",trim(left(month(&QUERYFROM.))));
479       +run;
480       +
481       +%PUT &NUMPER.;
482       +%PUT &NUMYEARS.;
483       +%PUT &NUMMONTHS.;
484       +%PUT &FROMY.;
485       +%PUT &TOY.;
486       +
487       +data _null_;
488       +	call symputx("FORMOD",trim(left(&FROMMO.-2)));
489       +	if month(&QUERYFROM.) = 1 then call symputx("YEARCHANGE",1);
490       +	else if month(&QUERYFROM.) = 2 then call symputx("YEARCHANGE",0);
491       +	else call symputx("YEARCHANGE",14-month(&QUERYFROM.));
492       +run;
493       +
494       +%PUT &FORMOD.;
495       +%PUT &YEARCHANGE.;
496       +
497       +/*---------------------------------------------------------------------------------------------------*/
498       +/* 0.1 Import query and incidence files                                                              */
499       +/*---------------------------------------------------------------------------------------------------*/
500       +
501       +%let MINCONDFROM=.;
502       +%let MAXCONDTO=.;
503       +%let MINWASHPER=.;
504       +%let USEPEC=0;
505       +
13                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

506       +%MACRO IMPORTFILES(var1,var2,var3);
507       +	%IF %INDEX(%UPCASE("&VAR1."),CPORT) %THEN %DO;
508       +		proc cimport infile="&infolder.&VAR1." library=infolder memtype=data;
509       +		run;
510       +	%END;
511       +
512       +	%LET &VAR2.=%SUBSTR(&VAR1.,1,%INDEX(%UPCASE(&VAR1.),.)-1);
513       +	%LET VAR1=%SUBSTR(&VAR1.,1,%INDEX(%UPCASE(&VAR1.),.)-1);
514       +
515       +	data _&var2.;
516       +	set infolder.&var1.;
517       +	group = compress(trim(left(group)));
518       +	group = translate(group,'_','-',
519       +	                       '_','.',
520       +	                       '_',',',
521       +	                       '_','%',
522       +	                       '_','$',
523       +	                       '_','!',
524       +	                       '_','*',
525       +	                       '_','&',
526       +	                       '_','#',
527       +	                       '_','@');
528       +	keep &var3.;
529       +	run;
530       +%MEND IMPORTFILES;
531       +%IMPORTFILES(&QUERYFILE.,QUERYFILE,Code CodeType WashTyp Group Washper CareSetting Principal EnrDays);
532       +
533       +proc sql noprint;
534       +	select min(WashPer) into :MINWASHPER
535       +	from _QUERYFILE;
536       +quit;
537       +
538       +%MACRO IMPORTFILES2(var1,var2);
539       +	%IF %INDEX(%UPCASE("&VAR1."),CPORT) %THEN %DO;
540       +		proc cimport infile="&infolder.&VAR1." library=infolder memtype=data;
541       +		run;
542       +	%END;
543       +
544       +	%LET &VAR2.=%SUBSTR(&VAR1.,1,%INDEX(%UPCASE(&VAR1.),.)-1 );
545       +	%LET VAR1=%SUBSTR(&VAR1.,1,%INDEX(%UPCASE(&VAR1.),.)-1);
546       +
547       +	data _&var2.;
548       +	set infolder.&var1.;
549       +	run;
550       +%MEND IMPORTFILES2;
551       +
552       +%MACRO WRAPPER();
553       +	%IF %INDEX(%UPCASE("&INCQUERYFILE."),.) %THEN %DO;
14                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

554       +		%IMPORTFILES(&INCQUERYFILE.,INCQUERYFILE,Group Code CodeType CareSetting Principal);
555       +	%END;
556       +	%ELSE %DO;
557       +		data _INCQUERYFILE;
558       +		if 0 then set _QUERYFILE;
559       +		keep Group Code CodeType CareSetting Principal;
560       +		stop;
561       +		run;
562       +	%END;
563       +
564       +	%IF %INDEX(%UPCASE("&CONDFILE."),.) %THEN %DO;
565       +		%IMPORTFILES(&CONDFILE.,CONDFILE,Code CodeType Principal CondFrom CondTo Caresetting Group Inclusion);
566       +
567       +		proc sql noprint;
568       +			select min(condFrom) into :MINCONDFROM
569       +			from _CONDFILE;
570       +			select max(condTo) into :MAXCONDTO
571       +			from _CONDFILE;
572       +		quit;
573       +		%let USEPEC=1;
574       +	%END;
575       +	%ELSE %DO;
576       +		data _CONDFILE;
577       +		if 0 then set _QUERYFILE;
578       +		format Principal $3. CareSetting $40. condfrom condto Inclusion best.;
579       +		condfrom=.;
580       +		condto=.;
581       +		Inclusion=.;
582       +		keep Code CodeType Principal CondFrom CondTo CareSetting Group Inclusion;
583       +		stop;
584       +		run;
585       +	%END;
586       +
587       +	%IF %INDEX(%UPCASE("&OUTTABLESFILE."),.) %THEN %DO;
588       +		%IMPORTFILES2(&OUTTABLESFILE.,OUTTABLESFILE);
589       +	%END;
590       +%MEND WRAPPER;
591       +%WRAPPER();
592       +
593       +%macro ProcessInclude(filename=);
594       +	%if %sysfunc(fileexist(&infolder.&filename.))=0 %then %do;
595       +		%put ERROR: Include file &infolder.&filename. is required but does not exist;
596       +		%abort cancel;
597       +	%end;
598       +	%include "&infolder.&filename.";
599       +%mend ProcessInclude;
600       +
601       +/*Printing input files into a .lst file*/
15                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

602       +%MACRO WRAPPER();
603       +
604       +	options  nodate nonumber;
605       +	Title1 "Input Query File printout";
606       +	proc print data=infolder.&QUERYFILE. noobs;
607       +	run;
608       +
609       +	%IF %UPCASE("&INCQUERYFILE.") ne %STR("") %THEN %DO;
610       +		Title1 "Input IncQuery File printout";
611       +		proc print data=infolder.&INCQUERYFILE. noobs;
612       +		run;
613       +    %END;
614       +    %IF %UPCASE("&CONDFILE.") ne %STR("") %THEN %DO;
615       +		Title1 "Input pre-existing conditon File printout";
616       +		proc print data=infolder.&CONDFILE. noobs;
617       +		run;
618       +    %END;
619       +
620       +	Title1 "";
621       +%MEND WRAPPER;
622       +/*%WRAPPER();*/
623       +
624       +/*Query*/
625       +data _QUERYFILE;
626       +set _QUERYFILE;
627       +code = upcase(compress(code,'. '));
628       +CodeType=upcase(CodeType);
629       +
630       +WashTyp = upcase(WashTyp);
631       +if WashTyp = '' then WashTyp = 'MULT';
632       +if WashPer = .  then WashPer = 0;
633       +
634       +if missing(EnrDays) then EnrDays=0;
635       +run;
636       +
637       +proc sort nodupkey data=_QUERYFILE;
638       +by Group codetype Code CareSetting Principal;
639       +run;
640       +
641       +/*In some cases, we may wish that each query group in the query file be incident to
642       +   a common list of drugs, in this case, the list should only be entered once while leaving the
643       +   group variable empty*/
644       +data _INCQUERYFILE;
645       +set _INCQUERYFILE(rename=(Group=IGroup));
646       +if IGroup = "" then IGroup = "_ALLGROUPS_";
647       +code = upcase(compress(code,'. '));
648       +CodeType=upcase(CodeType);
649       +run;
16                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

650       +
651       +proc sort nodupkey data=_INCQUERYFILE;
652       +by IGroup codetype Code CareSetting Principal;
653       +run;
654       +
655       +/*If codes from the common incident list (_ALLGROUPS_) are the union of all query group codes,
656       +  the following steps avoid duplicating claims*/
657       +proc sql noprint;
658       +create table _querycodes as
659       +/*PART 1: if IGROUP is _ALLGROUPS_ then join the files using CodeType and Code and
660       +     keeping all INCQUERY codes*/
661       +	select quer.group,
662       +       inqu.igroup,
663       +       quer.Code,
664       +       inqu.Code as icode,
665       +       quer.CodeType,
666       +       inqu.CodeType as iCodeType,
667       +	   quer.CareSetting,
668       +	   inqu.CareSetting as iCareSetting,
669       +	   quer.Principal,
670       +	   inqu.Principal as iPrincipal
671       +	from _QUERYFILE as quer right join _INCQUERYFILE as inqu
672       +      on quer.Code = inqu.Code and quer.CodeType = inqu.CodeType and quer.CareSetting = inqu.CareSetting
673       +	  and quer.Principal = inqu.Principal
674       +   where IGroup = "_ALLGROUPS_"
675       +union
676       +/*PART 2: if IGROUP is not _ALLGROUPS_ then join the files using CodeType, Code and
677       +     Group to get all common codes*/
678       +	select quer.group,
679       +       inqu.igroup,
680       +       quer.Code,
681       +       inqu.Code as icode,
682       +       quer.CodeType,
683       +       inqu.CodeType as iCodeType,
684       +	   quer.CareSetting,
685       +	   inqu.CareSetting as iCareSetting,
686       +	   quer.Principal,
687       +	   inqu.Principal as iPrincipal
688       +   from _QUERYFILE as quer join _INCQUERYFILE as inqu
689       +      on quer.Code = inqu.Code and quer.CodeType = inqu.CodeType and quer.CareSetting = inqu.CareSetting
690       +      and quer.Principal = inqu.Principal and quer.Group = inqu.IGroup
691       +   where IGroup ne "_ALLGROUPS_"
692       +union
693       +/*PART 3: Add QUERY only codes*/
694       +(
695       +   select group,
696       +           "" as igroup,
697       +           Code,
17                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

698       +          "" as icode,
699       +           CodeType,
700       +          "" as iCodeType,
701       +		   CareSetting,
702       +		  "" as iCareSetting,
703       +		   Principal,
704       +		  "" as iPrincipal
705       +   from _QUERYFILE
706       +   where (CodeType||Code||Principal||CareSetting) not in
707       +        (select (CodeType||Code||Principal||CareSetting) from _INCQUERYFILE where IGroup = "_ALLGROUPS_")
708       +   except
709       +   select igroup as group,
710       +           "" as igroup,
711       +           Code,
712       +          "" as icode,
713       +           CodeType,
714       +          "" as iCodeType,
715       +		   CareSetting,
716       +		  "" as iCareSetting,
717       +		   Principal,
718       +		  "" as iPrincipal
719       +      from _INCQUERYFILE
720       +)
721       +union
722       +/*PART 4: Add INCQUERY only codes that doesnt apply to _ALLGROUPS_*/
723       +(
724       +   select "" as group,
725       +           igroup,
726       +           "" as Code,
727       +          Code as icode,
728       +           "" as CodeType,
729       +          CodeType as iCodeType,
730       +		   "" as CareSetting,
731       +		   CareSetting as iCareSetting,
732       +		   "" as Principal,
733       +		   Principal as iPrincipal
734       +   from _INCQUERYFILE
735       +   where IGroup ne "_ALLGROUPS_"
736       +   except
737       +   select "" as group,
738       +           group as igroup,
739       +           "" as Code,
740       +          Code as icode,
741       +           "" as CodeType,
742       +          CodeType as iCodeType,
743       +		   "" as CareSetting,
744       +		   CareSetting as iCareSetting,
745       +		   "" as Principal,
18                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

746       +		   Principal as iPrincipal
747       +      from _QUERYFILE
748       +)
749       +   order by Group;
750       +quit;
751       +
752       +data _querycodes;
753       +set _querycodes;
754       +
755       +Query = 0;
756       +Incid = 0;
757       +
758       +if Group ne "" then Query = 1;
759       +if IGroup ne "" then Incid = 1;
760       +
761       +if Code = "" then do;
762       +	Code = iCode;
763       +	CodeType = iCodeType;
764       +	CareSetting = iCareSetting;
765       +	Principal = iPrincipal;
766       +end;
767       +
768       +keep Group IGroup Code CodeType CareSetting Principal Query Incid;
769       +run;
770       +
771       +/*In the following steps, we retrieve the query group settings to be applied in creation
772       +  of episodes loop*/
773       +proc sort nodupkey data=_QUERYFILE
774       +                   out=_querysettings(keep=Group WashTyp WashPer EnrDays);
775       +by Group;
776       +run;
777       +
778       +/*Since a claim can either be query or incident we cannot apply at the retrieval a query group setting,
779       +  we shall apply the most severe washout setting*/
780       +proc sort data = _querysettings(keep=WashTyp WashPer)
781       +          out = _extractsettings;
782       +by WashTyp descending WashPer;
783       +run;
784       +
785       +data _extractsettings;
786       +set _extractsettings;
787       +if _N_ = 1;
788       +run;
789       +
790       +data _querycodes;
791       +set _querycodes;
792       +if _N_ = 1 then set _extractsettings;
793       +run;
19                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

794       +
795       +/*If no INCQUERYFILE or no _ALLGROUPS_,
796       +  keep original query washout*/
797       +%MACRO WRAPPER();
798       +	%LET NB_ALL_GROUPS=0;
799       +	%IF %UPCASE("&INCQUERYFILE.") ne %STR("") %THEN %DO;
800       +		proc sql noprint;
801       +			select count(IGROUP) into :NB_ALL_GROUPS from _INCQUERYFILE
802       +		    where IGROUP="_ALLGROUPS_";
803       +		quit;
804       +    %END;
805       +    %PUT &NB_ALL_GROUPS.;
806       +
807       +    %IF &NB_ALL_GROUPS.=0 %THEN %DO;
808       +		proc sql noprint;
809       +			update _querycodes as qc
810       +		   	set WashPer =
811       +		    	(
812       +		         	select settings.WashPer
813       +		            from _querysettings as settings
814       +		            where qc.Group=settings.Group
815       +		      	)
816       +		    where exists
817       +		    	(
818       +		            select settings.WashPer
819       +		            from _querysettings as settings
820       +		            where qc.Group=settings.Group
821       +		        );
822       +
823       +			update _querycodes as qc
824       +		   	set WashTyp =
825       +		   		(
826       +		      		select settings.WashTyp
827       +		         	from _querysettings as settings
828       +		         	where qc.Group=settings.Group
829       +		   		)
830       +		   	where exists
831       +		      	(
832       +		         	select settings.WashTyp
833       +		            from _querysettings as settings
834       +		            where qc.Group=settings.Group
835       +		      	);
836       +		quit;
837       +	%END;
838       +%MEND WRAPPER;
839       +%WRAPPER;
840       +
841       +data _CONDFILE;
20                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

842       +retain Group codetype Code;
843       +set _CONDFILE;
844       +format WashTyp $4.;
845       +WashTyp='MULT';
846       +code = upcase(compress(code,'. '));
847       +if condFrom=. and CondTo=. then delete;  /*defensive coding - should have one and/or the other*/
848       +if missing(condFrom) then condFrom=0;    /*Default value will ultimately include index date(=0)*/
849       +if missing(CondTo) then CondTo=0;        /*Default value will ultimately include index date(=0)*/
850       +run;
851       +
852       +proc sort nodupkey data=_CONDFILE(keep=Group codetype code Principal condfrom condto
853       +                                       CareSetting WashTyp Inclusion);
854       +by _ALL_; /*the retain included in the previous step makes sure Group codetype Code are in this order*/
855       +run;
856       +
857       +data _diag
858       +     _proc
859       +     _ndc(drop=Principal CareSetting);
860       +length Caresetting $40;
861       +length Principal $3;
862       +set _querycodes(in=a) _condfile(in=b);
863       +
864       +if not a then do;
865       +	Query = 0;
866       +	Incid = 0;
867       +end;
868       +
869       +if b then cond = 1;else cond = 0;
870       +
871       +code = upcase(compress(code,'. '));
872       +length=length(code);
873       +if WashTyp = '' then WashTyp = 'MULT';
874       +if WashPer = .  then WashPer = 0;
875       +
876       +if CondFrom = . then CondFrom = 0;
877       +if CondTo = . then CondTo = 0;
878       +
879       +CodeType=upcase(CodeType);
880       +
881       +if CodeType in:('DX') then do; codetype=compress(codetype,'DX'); output _diag; end;
882       +if CodeType in:('RX') then do; codetype=compress(codetype,'RX'); output _ndc; end;
883       +if CodeType in:('PX') then do;
884       +	codetype=compress(codetype,'PX');
885       +	*Defensive coding;
886       +	if codetype in: ("C2", "C3", "C4", "H3", "HC") then do;
887       +		output _proc;
888       +		codetype= "CH";
889       +		output _proc;
21                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

890       +	end;
891       +	else if codetype in: ("09","10","11") then do;
892       +        output _proc;
893       +    end;
894       +	else if codetype in: ("CH") then do;
895       +		output _proc;
896       +		codetype= "C2";
897       +		output _proc;
898       +		codetype= "C3";
899       +		output _proc;
900       +		codetype= "C4";
901       +		output _proc;
902       +		codetype= "H3";
903       +		output _proc;
904       +		codetype= "HC";
905       +		output _proc;
906       +	end;
907       +end;
908       +run;
909       +
910       +/*Storing all QueryGroup into a macro vector*/
911       +proc sort nodupkey data = _querycodes(where=(Query=1))
912       +                   out = _GroupList(keep=Group);
913       +by Group;
914       +run;
915       +
916       +proc sql noprint;
917       +	select Group
918       +   	into :GROUPVECT separated by ','
919       +   	from _GroupList;
920       +quit;
921       +
922       +%PUT &GROUPVECT.;
923       +
924       +%MACRO CREATEVECT(file);
925       +	%IF %SYSFUNC(exist(_&file.))=1 %THEN %DO;
926       +
927       +		data _&file.;
928       +		set  _&file.;
929       +		OrigCode=code;
930       +		exact=index(code,'*')=0;
931       +		if exact=1 then do;
932       +			code=compress(code,'*');
933       +		end;
934       +		else do;
935       +			WildcardIndex=index(code,'*');
936       +			if code='*' then do;   	                    /*Extract all codes*/
937       +				exact=-2;	
22                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

938       +			end;
939       +			else if WildcardIndex=length(code) then do;   	/*the star is at the end*/
940       +				code=compress(code,'*');
941       +			end;
942       +			else do;                            		/*the star is in a middle position*/
943       +				exact=-1;		
944       +				LengthCodeEnd=length(code)-WildcardIndex;
945       +				CodeEnd=substr(code,WildcardIndex+1,LengthCodeEnd);		
946       +				code=substr(code,1,WildcardIndex-1);
947       +			end;
948       +		end;
949       +		length=length(Code);
950       +		run;		
951       +	%END;
952       +%MEND CREATEVECT;
953       +%CREATEVECT(proc);
954       +%CREATEVECT(diag);
955       +
956       +/*---------------------------------------------------------------------------------------------------*/
957       +/* 1.0 Extract medical (diagnosis and procedures) claims                                             */
958       +/*---------------------------------------------------------------------------------------------------*/
959       +
960       +%MACRO GETMEDS();
961       +	%global prefilename;
962       +
963       +	proc contents data=_proc noprint out=_tilt_ ;
964       +
965       +	data _null_ ;
966       +	set _tilt_ ;
967       +	call symputx('pnobs',trim(left(put(nobs,15.)))) ;
968       +	run;
969       +
970       +   	%PUT &pnobs.;
971       +   	%IF %EVAL(&pnobs.>0) %THEN %DO;
972       +
973       +*Pre-extract for better performance;
974       +	%global atLeastOneStar;
975       +	%global PX09list;
976       +	%global PX10list;
977       +	%global PX11list;
978       +	%global PXCHlist;
979       +	%global PXC2list;
980       +	%global PXC3list;
981       +	%global PXC4list;
982       +	%global PXH3list;
983       +	%global PXHClist;	
984       +	%global PXLClist;
985       +	%global PXNDlist;
23                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

986       +	%global PXRElist;
987       +
988       +
989       +	%let atLeastOneStar=0;
990       +	%let PX09list="";
991       +	%let PX10list="";
992       +	%let PX11list="";
993       +	%let PXCHlist="";
994       +	%let PXC2list="";
995       +	%let PXC3list="";
996       +	%let PXC4list="";
997       +	%let PXH3list="";
998       +	%let PXHClist="";	
999       +	%let PXLClist="";
1000      +	%let PXNDlist="";
1001      +	%let PXRElist="";
1002      +
1003      +	data _list_;
1004      +	set _proc;
1005      +    format code2 $8.;
1006      +    if code = "*" then call symputx("atLeastOneStar",1);
1007      +    if CodeType in:('09','10','11','CH','C2','C3','C4','H3','HC','LC','ND','RE') then do;
1007     !+code2="'"||strip(substr(compress(code,'.'),1,3))||"'";end;
1008      +	keep code2 CodeType;
1009      +	run;
1010      +
1011      +%if &atLeastOneStar.=0 %then %do;
1012      +	proc sql noprint;
1013      +	select distinct(substr(Code2,1,5)) into: PX09list separated by ","
1014      +	from _list_
1015      +	where CodeType = "09";
1016      +	select distinct(substr(Code2,1,5)) into: PX10list separated by ","
1017      +	from _list_
1018      +	where CodeType = "10";
1019      +	select distinct(substr(Code2,1,5)) into: PX11list separated by ","
1020      +	from _list_
1021      +	where CodeType = "11";		
1022      +	select distinct(substr(Code2,1,5)) into: PXCHlist separated by ","
1023      +	from _list_
1024      +	where CodeType = "CH";	
1025      +	select distinct(substr(Code2,1,5)) into: PXC2list separated by ","
1026      +	from _list_
1027      +	where CodeType = "C2";
1028      +	select distinct(substr(Code2,1,5)) into: PXC3list separated by ","
1029      +	from _list_
1030      +	where CodeType = "C3";
1031      +	select distinct(substr(Code2,1,5)) into: PXC4list separated by ","
1032      +	from _list_
24                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1033      +	where CodeType = "C4";
1034      +	select distinct(substr(Code2,1,5)) into: PXH3list separated by ","
1035      +	from _list_
1036      +	where CodeType = "H3";	
1037      +	select distinct(substr(Code2,1,5)) into: PXHClist separated by ","
1038      +	from _list_
1039      +	where CodeType = "HC";	
1040      +	select distinct(substr(Code2,1,5)) into: PXLClist separated by ","
1041      +	from _list_
1042      +	where CodeType = "LC";
1043      +	select distinct(substr(Code2,1,5)) into: PXNDlist separated by ","
1044      +	from _list_
1045      +	where CodeType = "ND";
1046      +	select distinct(substr(Code2,1,5)) into: PXRElist separated by ","
1047      +	from _list_
1048      +	where CodeType = "RE";
1049      +	quit;
1050      +	
1051      +	%put &PX09list. &PX10list. &PX11list. &PXCHlist. &PXC2list. &PXC3list.;
1052      +	%put &PXC4list. &PXH3list. &PXHClist. &PXLClist. &PXNDlist. &PXRElist.;
1053      +
1054      +	data _pretableproc;
1055      +	set indata.&proctable.;
1056      +	where (PX_type="09" and upcase(px) in:(&PX09list.)) or
1057      +          (PX_type="10" and upcase(px) in:(&PX10list.)) or
1058      +          (PX_type="11" and upcase(px) in:(&PX11list.)) or
1059      +          (PX_type="CH" and upcase(px) in:(&PXCHlist.)) or
1060      +		  (PX_type="C2" and upcase(px) in:(&PXC2list.)) or
1061      +          (PX_type="C3" and upcase(px) in:(&PXC3list.)) or
1062      +          (PX_type="C4" and upcase(px) in:(&PXC4list.)) or
1063      +          (PX_type="H3" and upcase(px) in:(&PXH3list.)) or
1064      +          (PX_type="HC" and upcase(px) in:(&PXHClist.)) or
1065      +          (PX_type="LC" and upcase(px) in:(&PXLClist.)) or
1066      +          (PX_type="ND" and upcase(px) in:(&PXNDlist.)) or
1067      +          (PX_type="RE" and upcase(px) in:(&PXRElist.)) or
1068      +          (PX_type not in:('09','10','11','CH','C2','C3','C4','H3','HC','LC','ND','RE') );
1069      +		  px=upcase(px);
1070      +    run;
1071      +	%let prefilename=_pretableproc;
1072      +%end;
1073      +%else %do;
1074      +	%let prefilename=indata.&proctable.;
1075      +%end;
1076      +%put &prefilename.;
1077      +
1078      +
1079      +		PROC SQL Noprint;
1080      +   			Create Table _procedures as
25                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1081      +   			Select  prctb.PatId,
1082      +          			coalesce(prctb.PX_Date, prctb.Admit_Date) as Admit_Date,
1083      +					prctb.Enc_Type,
1084      +					upcase(compress(prctb.PX,'. ')) as Code format $18.,
1085      +					proclist.Group,
1086      +					proclist.IGroup,
1087      +					proclist.CodeType,
1088      +					proclist.CareSetting,
1089      +					proclist.Principal,
1090      +					proclist.Query,
1091      +					proclist.Incid,
1092      +					proclist.WashTyp,
1093      +					proclist.WashPer,
1094      +					proclist.Inclusion,
1095      +					proclist.CondFrom,
1096      +					proclist.CondTo,					
1097      +					proclist.Cond,
1098      +					1 as Dispense_Sup,
1099      +					1 as Dispense_Amt,
1100      +					1 as proc,
1101      +					'S' as PDX format $2.
1102      +   			From  &prefilename. as prctb,
1103      +             	 _proc as proclist
1104      +      		Where (
1105      +				  (proclist.exact=-2) or
1106      +				  (prctb.PX_type = proclist.codetype and proclist.exact=-1 and substr(upcase(compress(prctb.PX,'.')),1,proclist.length) = proclist.code
1106     !+ and
1107      +				   substr(upcase(compress(prctb.PX,'.')),proclist.WildcardIndex+1,proclist.LengthCodeEnd) = proclist.CodeEnd) or
1108      +				  (prctb.PX_type = proclist.codetype and proclist.exact=0  and substr(upcase(compress(prctb.PX,'.')),1,proclist.length) =
1108     !+proclist.Code) or
1109      +				  (prctb.PX_type = proclist.codetype and proclist.exact=1  and upcase(compress(prctb.PX,'.'))=proclist.code)
1110      +				  )         		
1111      +      			  and calculated Admit_Date >= &QUERYFROM. - proclist.WashPer + proclist.CondFrom  - (proclist.washtyp='MIN')*999999;
1112      +      			  /*The 999999 is to extend the washout period long enough in the case where washtyp = 'MIN'*/
1113      +		quit;
1114      +
1115      +		proc datasets library=work nolist nowarn;
1116      +		delete _pretableproc;
1117      +		quit;
1118      +
1119      +	%END;
1120      +
1121      +	proc contents data=_diag noprint out=_tilt_ ;
1122      +
1123      +	data _null_ ;
1124      +	set _tilt_ ;
1125      +	call symputx('dnobs',trim(left(put(nobs,15.)))) ;
1126      +	run;
26                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1127      +
1128      +   	%PUT &dnobs.;
1129      +   	%IF %EVAL(&dnobs.>0) %THEN %DO;
1130      +
1131      +
1132      +*Pre-extract for better performance;
1133      +	%global atLeastOneStar;
1134      +	%global DX09list;
1135      +	%global DX10list;
1136      +	%global DXSMlist;
1137      +
1138      +	%let DX09list="";
1139      +	%let DX10list="";
1140      +	%let DXSMlist="";
1141      +
1142      +	%let atLeastOneStar=0;
1143      +	data _list_;
1144      +	set _diag;
1145      +    format code2 $8.;
1146      +    if code = "*" then call symputx("atLeastOneStar",1);
1147      +         if CodeType = "09" then do;code2="'"||strip(substr(compress(code,'.'),1,3))||"'";end;
1148      +    else if CodeType = "10" then do;code2="'"||strip(substr(compress(code,'.'),1,3))||"'";end;
1149      +    else if CodeType = "SM" then do;code2="'"||strip(substr(compress(code,'.'),1,3))||"'";end;
1150      +	code2=upcase(code2);
1151      +	keep code2 CodeType;
1152      +	run;
1153      +
1154      +%if &atLeastOneStar.=0 %then %do;
1155      +	proc sql noprint;
1156      +	select distinct(substr(Code2,1,5)) into: DX09list separated by ","
1157      +	from _list_
1158      +	where CodeType = "09";
1159      +	select distinct(substr(Code2,1,5)) into: DX10list separated by ","
1160      +	from _list_
1161      +	where CodeType = "10";
1162      +	select distinct(substr(Code2,1,5)) into: DXSMlist separated by ","
1163      +	from _list_
1164      +	where CodeType = "SM";
1165      +	quit;
1166      +	%put &DX09list. &DX10list. &DXSMlist. ;
1167      +
1168      +	data _pretable;
1169      +	set indata.&diatable.;
1170      +	where (DX_type="09" and upcase(dx) in:(&DX09list.)) or
1171      +	      (DX_type="10" and upcase(dx) in:(&DX10list.)) or
1172      +		  (DX_type="SM" and upcase(dx) in:(&DXSMlist.)) or
1173      +          (DX_type not in("09","10","SM"));
1174      +	dx=upcase(dx);
27                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1175      +    run;
1176      +	%let prefilename=_pretable;
1177      +%end;
1178      +%else %do;
1179      +	%let prefilename=indata.&diatable.;
1180      +%end;
1181      +%put &prefilename.;
1182      +
1183      +		PROC SQL Noprint;
1184      +			Create Table _Diagnosis as
1185      +			Select  diagtb.PatId,
1186      +       			    diagtb.Admit_Date,
1187      +					diagtb.Enc_Type,
1188      +					diagtb.pdx,
1189      +					upcase(compress(diagtb.DX,'. ')) as Code format $18., 					
1190      +					diaglist.Group,
1191      +					diaglist.IGroup,
1192      +					diaglist.CodeType,
1193      +					diaglist.CareSetting,
1194      +					diaglist.Principal,
1195      +					diaglist.Query,
1196      +					diaglist.Incid,
1197      +					diaglist.WashTyp,
1198      +					diaglist.WashPer,
1199      +					diaglist.Inclusion,
1200      +					diaglist.CondFrom,
1201      +					diaglist.CondTo,					
1202      +					diaglist.Cond,
1203      +					1 as Dispense_Sup,
1204      +					1 as Dispense_Amt,
1205      +					-1 as proc
1206      +   			From &prefilename. as diagtb,
1207      +             	 _diag as diaglist
1208      +   			Where
1209      +   				  (
1210      +				  (diaglist.exact=-2) or
1211      +          		  (diagtb.DX_type = diaglist.codetype and diaglist.exact=-1 and substr(upcase(compress(diagtb.DX,'.')),1,diaglist.length) =
1211     !+diaglist.code and
1212      +				   substr(upcase(compress(diagtb.DX,'.')),diaglist.WildcardIndex+1,diaglist.LengthCodeEnd) = diaglist.CodeEnd) or
1213      +	      		  (diagtb.DX_type = diaglist.codetype and diaglist.exact=0  and substr(upcase(compress(diagtb.DX,'.')),1,diaglist.length) =
1213     !+diaglist.Code) or
1214      +          		  (diagtb.DX_type = diaglist.codetype and diaglist.exact=1  and upcase(compress(diagtb.DX,'.'))=diaglist.code)
1215      +         		  )
1216      +         		  and diagtb.Admit_Date >= &QUERYFROM. - diaglist.WashPer + diaglist.CondFrom - (diaglist.washtyp='MIN')*999999;
1217      +   				  /*The 999999 is to extend the washout period long enough in the case where washtyp = 'MIN'*/
1218      +		quit;
1219      +
1220      +		proc sort nodupkey data = _Diagnosis;
28                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1221      +		by _all_;
1222      +		run;
1223      +	%END;
1224      +
1225      +   	%IF %EVAL(&pnobs.> 0 and &dnobs.>0) %THEN %DO;
1226      +		data _MasterQueryfile;
1227      +		* Force length to avoid w.a.r.n.i.n.g.s.;
1228      +		length Code $18;
1229      +		length PDX $2;
1230      +		set _procedures _diagnosis;
1231      +		Clm = _N_;
1232      +		run;
1233      +
1234      +		proc datasets library = work nolist nowarn;
1235      +		delete _procedures _diagnosis;
1236      +		quit;
1237      +   	%END;
1238      +   	%IF %EVAL(&pnobs.> 0 and &dnobs.=0) %THEN %DO;
1239      +		data _MasterQueryfile;
1240      +		set _procedures;
1241      +		Clm = _N_;
1242      +		run;
1243      +		proc datasets library = work nolist nowarn;
1244      +		delete _procedures;
1245      +		quit;
1246      +   	%END;
1247      +   	%IF %EVAL(&pnobs.=0 and &dnobs.>0) %THEN %DO;	
1248      +		data _MasterQueryfile;
1249      +		set _diagnosis;
1250      +		Clm = _N_;
1251      +		run;
1252      +		proc datasets library = work nolist nowarn;
1253      +		delete _diagnosis;
1254      +		quit;
1255      +	%END;
1256      +%MEND GETMEDS;
1257      +%GETMEDS();
1258      +
1259      +/*---------------------------------------------------------------------------------------------------*/
1260      +/* 2.0 ENVELOPE                                                                                      */
1261      +/*---------------------------------------------------------------------------------------------------*/
1262      +
1263      +   /*****************************************************************/
1264      +   /*    Reduce diagnosis table according to selected care setting  */
1265      +   /*     after having reclassified as inpatient all selected claims*/
1266      +   /*     within admission and discharge dates of an inpatient      */
1267      +   /*     stay, when necessary                                      */
1268      +   /*****************************************************************/
29                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1269      +
1270      +%MACRO ENVEL();
1271      +
1272      +   	%IF %SYSFUNC(exist(_MasterQueryfile))=1 %THEN %DO;
1273      +		proc contents data=_MasterQueryfile noprint out=_tilt_ ;
1274      +
1275      +		data _null_ ;
1276      +		set _tilt_ ;
1277      +		call symputx('nobs1',trim(left(put(nobs,15.)))) ;
1278      +		run;
1279      +   	%END;
1280      +   	%ELSE %DO;
1281      +		data _null_ ;
1282      +		call symputx('nobs1',input('0',15.)) ;
1283      +		run;
1284      +   	%END;
1285      +
1286      +   	%LET SOME=0;
1287      +
1288      +	proc sort nodupkey data=_diag
1289      +	                   out=_diagCS(keep=caresetting);
1290      +	by caresetting;
1291      +	run;
1292      +
1293      +	proc sort nodupkey data=_proc
1294      +	                   out=_procCS(keep=caresetting);
1295      +	by caresetting;
1296      +	run;
1297      +	
1298      +	data _null_;
1299      +	set _procCS _diagCS;       	
1300      +	caresetting=upcase(compress(caresetting,"'"));
1301      +
1302      +	/*first determine whether the "all care settings" option was always chosen*/
1303      +	if caresetting ne '' and not(indexw(caresetting,'OA') &
1304      +	                            indexw(caresetting,'IP') &
1305      +	                            indexw(caresetting,'ED') &
1306      +								indexw(caresetting,'EI') &
1307      +	                            indexw(caresetting,'AV') &
1308      +	                            indexw(caresetting,'IS') &
1309      +	                            indexw(caresetting,'OS') &
1310      +	                            indexw(caresetting,'IC') )
1311      +		then call symputx('SOME',input('1',1.));   /*this will trigger the envelope to run*/
1312      +	else caresetting='';
1313      +	run;
1314      +
1315      +   	%PUT &SOME.;
1316      +   	%PUT %EVAL(&SOME.=1);
30                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1317      +
1318      +   	%IF %EVAL(&nobs1.>0 and &SOME.=1) %THEN %DO;
1319      +
1320      +		/*Reclassification as inpatient all selected claims within admission and discharge dates
1321      +		  of an inpatient stay*/
1322      +		/*Get Unique Admit_Date-Discharge_Date combinations*/
1323      +		proc sort nodupkey data=indata.&ENCTABLE.(keep=PatId Admit_Date Discharge_Date Enc_Type where=(Enc_Type='IP'))
1324      +		                   out=_IPdates(keep=PatId Admit_Date Discharge_Date);
1325      +		by PatId Admit_Date Discharge_Date;
1326      +		run;
1327      +		
1328      +		proc sql noprint;
1329      +			create table _datematch as
1330      +			Select claimtb.Clm
1331      +			From _MasterQueryFile as claimtb,
1332      +			     _IPDates as datetb
1333      +			Where claimtb.Enc_Type not in('IP') and
1334      +				  claimtb.PatId = datetb.PatId and
1335      +			      datetb.Admit_Date <= claimtb.Admit_Date <=  max(datetb.Admit_Date,datetb.Discharge_Date);
1336      +		quit;
1337      +
1338      +		proc sort nodupkey data = _datematch(keep=Clm);
1339      +		by Clm;
1340      +		run;
1341      +
1342      +		/*For each record in Diagnosis matching an inpatient day date, recode encounter type as inpatient*/
1343      +		data _MasterQueryFile(drop=Enc_Type);
1344      +		merge _MasterQueryFile(in=a) _datematch(in=b);
1345      +		by Clm;
1346      +		Enc_Type2=Enc_Type;
1347      +		if b then do;
1348      +			if upcase(Enc_Type) not in('IP') then pdx='S';
1349      +		  	Enc_Type2='IP';
1350      +		end;
1351      +		run;
1352      +
1353      +		proc datasets library = work nowarn nolist;
1354      +		modify _MasterQueryFile;
1355      +		rename Enc_Type2=Enc_Type;
1356      +		quit;
1357      +
1358      +		proc datasets library = work nolist nowarn;
1359      +		delete _IPDates;
1360      +		quit;
1361      +   	%END;
1362      +   	%IF %SYSFUNC(exist(_MasterQueryfile))=1 %THEN %DO;
1363      +
1364      +		/*Filter claims with matching Enc_Type and Principal status*/
31                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1365      +		data _MasterQueryFile(drop=Enc_Type2 clm principal caresetting numarg i Enc_Type PDX code codetype);
1366      +		set _MasterQueryFile;
1367      +		format Enc_Type2 $2.;
1368      +		/*case where all care setting are wanted and necessarily that principal=NO*/
1369      +		if caresetting = '' then output;
1370      +		else do;
1371      +			Numarg=length(compress(caresetting," '"))/2;
1372      +			do i=1 to Numarg;
1373      +				Enc_Type2=compress(scan(caresetting,i),"'");
1374      +				if Enc_Type2 = Enc_Type then do;
1375      +					if upcase(principal)='NO' then output;
1376      +					if upcase(principal)='YES' and upcase(PDX)='P' and upcase(Enc_Type2) in('IP','ED','EI') then output;
1377      +				end;
1378      +			end;
1379      +		end;
1380      +		run;
1381      +   	%END;
1382      +%MEND ENVEL;
1383      +%ENVEL();
1384      +
1385      +/*---------------------------------------------------------------------------------------------------*/
1386      +/* 3.0 Extract drug claims                                                                           */
1387      +/*---------------------------------------------------------------------------------------------------*/
1388      +
1389      +%MACRO GETDRUGS();
1390      +
1391      +   	%LET ISCode1=0;
1392      +   	%LET ISCode9=0;
1393      +   	%LET ISCode11=0;
1394      +
1395      +	data _null_;
1396      +	set _ndc;
1397      +	if length=1 then call symputx("ISCode1",1);
1398      +	if length=9 then call symputx("ISCode9",1);
1399      +	if length=11 then call symputx("ISCode11",1);
1400      +	run;
1401      +
1402      +	%PUT &ISCode9;
1403      +	%PUT &ISCode11;
1404      +
1405      +   	/*Extract 9 and/or 11 digit Codes claims*/
1406      +   	%MACRO WRAPPER;
1407      +    	%IF %EVAL(&ISCode1.>0) %THEN %DO;
1408      +			proc sql noprint;
1409      +			create table _drugs as
1410      +			select  CodeList.*,
1411      +			   	    Dispensing.Patid,
1412      +			   		Dispensing.Dispense_Date as Admit_Date,
32                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1413      +			   		Dispensing.Dispense_Sup,
1414      +			   		Dispensing.Dispense_Amt,
1415      +			   		0 as Proc
1416      +			from _ndc as CodeList,
1417      +			     indata.&DISTABLE. as Dispensing
1418      +			where /*substr(Dispensing.ndc,1,9) = CodeList.code and*/ Dispensing.Dispense_Date >=
1419      +			           &QUERYFROM. - CodeList.WashPer + CodeList.CondFrom -
1420      +			           (upcase(CodeList.washtyp)='MIN')*999999
1421      +			           and Dispensing.Dispense_Sup>0;
1422      +			quit;
1423      +      	%END;
1424      +    	%IF %EVAL(&ISCode9.>0) %THEN %DO;
1425      +			proc sql noprint;
1426      +			create table _predrugs as
1427      +			select  CodeList.*,
1428      +			   	    Dispensing.Patid,
1429      +			   		Dispensing.Dispense_Date as Admit_Date,
1430      +			   		Dispensing.Dispense_Sup,
1431      +			   		Dispensing.Dispense_Amt,
1432      +			   		0 as Proc
1433      +			from _ndc as CodeList,
1434      +			     indata.&DISTABLE. as Dispensing
1435      +			where substr(Dispensing.ndc,1,9) = CodeList.code and Dispensing.Dispense_Date >=
1436      +			           &QUERYFROM. - CodeList.WashPer + CodeList.CondFrom -
1437      +			           (upcase(CodeList.washtyp)='MIN')*999999
1438      +			           and Dispensing.Dispense_Sup>0;
1439      +			quit;
1440      +
1441      +			proc datasets library=work nolist nowarn;
1442      +			append base=_drugs data=_predrugs FORCE;
1443      +			delete _predrugs;
1444      +			quit;
1445      +      	%END;
1446      +      	%IF %EVAL(&ISCode11.>0) %THEN %DO;
1447      +			proc sql noprint;
1448      +			create table _predrugs as
1449      +			select  CodeList.*,
1450      +			   		Dispensing.Patid,
1451      +			   		Dispensing.Dispense_Date as Admit_Date,
1452      +			   		Dispensing.Dispense_Sup,
1453      +			   		Dispensing.Dispense_Amt,
1454      +			   		0 as Proc
1455      +			from _ndc as CodeList,
1456      +			     indata.&DISTABLE. as Dispensing
1457      +			where substr(Dispensing.ndc,1,11) = CodeList.code and Dispensing.Dispense_Date >=
1458      +			         &QUERYFROM. - CodeList.WashPer  + CodeList.CondFrom -
1459      +			         (upcase(CodeList.washtyp)='MIN')*999999
1460      +			         and Dispensing.Dispense_Sup>0;
33                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1461      +			quit;
1462      +
1463      +			proc datasets library=work nolist nowarn;
1464      +			append base=_drugs data=_predrugs FORCE;
1465      +			delete _predrugs;
1466      +			quit;
1467      +      	%END;
1468      +   	%MEND WRAPPER;
1469      +   	%WRAPPER;
1470      +%MEND GETDRUGS;
1471      +%GETDRUGS();
1472      +
1473      +%MACRO WRAPPER;
1474      +   	%IF %SYSFUNC(exist(_MasterQueryFile))=1 and %SYSFUNC(exist(_Drugs))=1 %THEN %DO;
1475      +		data _MasterQueryFile;
1476      +		set _MasterQueryFile _drugs(drop=code codetype);
1477      +		run;
1478      +
1479      +		proc datasets library = work nolist nowarn;
1480      +		delete _drugs;
1481      +		quit;
1482      +   	%END;
1483      +   	%IF %SYSFUNC(exist(_MasterQueryFile))=0 and %SYSFUNC(exist(_Drugs))=1 %THEN %DO;
1484      +		data _MasterQueryFile;
1485      +		set _drugs(drop=code codetype);
1486      +		run;
1487      +
1488      +		proc datasets library = work nolist nowarn;
1489      +		delete _drugs;
1490      +		quit;
1491      +   	%END;
1492      +%MEND WRAPPER;
1493      +%WRAPPER;
1494      +
1495      +/*Verify if at least one claim was extracted from the CDM databases*/
1496      +%macro wrapper();
1497      +	%if %sysfunc(exist(_MasterQueryFile))=0 %then %do;
1498      +		%put ERROR: No members meet cohort inclusion/exclusion criteria for all groups;
1499      +		%abort cancel;
1500      +	%end;	
1501      +%mend wrapper;
1502      +%wrapper;
1503      +
1504      +/*---------------------------------------------------------------------------------------------------*/
1505      +/*    3.1 Enrollment and demographic data                                                            */
1506      +/*---------------------------------------------------------------------------------------------------*/
1507      +
1508      +%macro wrapper();
34                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1509      +    %global ALTENR;
1510      +
1511      +    %IF %UPCASE("&ENROPTION.") eq %STR("EB1") %THEN %DO;
1512      +        proc sql noprint;		
1513      +			Create Table _EncEnr as
1514      +			Select 	distinct PatId,					
1515      +            		&QUERYFROM. + min(&MINCONDFROM.,&MINWASHPER.,0) as Enr_Start_Date format=MMDDYY10.,
1516      +					&QUERYTO. + max(&MAXCONDTO.,0) as Enr_End_Date format=MMDDYY10.
1517      +        	from indata.&ENCTABLE.
1518      +			where &QUERYFROM. <= Admit_Date <= &QUERYTO.;
1519      +        quit;
1520      +
1521      +        %let ALTENR = _EncEnr;
1522      +    %END;
1523      +	%ELSE %IF %UPCASE("&ENROPTION.") eq %STR("EB2") %THEN %DO;
1524      +		*Restrict encounters to Admit_Date within query period and applicable encounter types;
1525      +		data _EncExtract;
1526      +		set indata.&ENCTABLE.;
1527      +		where Enc_Type in (&EB2ENCLIST.) and &QUERYFROM. <= Admit_Date <= &QUERYTO.;
1528      +		keep PatId Admit_Date Enc_Type;
1529      +		run;
1530      +
1531      +		*Select min and max Admit_date per within the query period and count number of days and enc_type;
1532      +		proc sql noprint;		
1533      +		create table _EncSummary as
1534      +			Select distinct PatId,
1535      +				   min(Admit_Date) as MinDate format mmddyy10.,
1536      +				   max(Admit_Date) as MaxDate format mmddyy10.,
1537      +				   max(Admit_Date) - min(Admit_Date) as NumDays,
1538      +				   count(Enc_Type) as NumEnc
1539      +	        from _EncExtract
1540      +			group by PatId;			
1541      +		quit;
1542      +
1543      +		*Restrict to patients meeting the minimum number of enc_types and
1544      +		 the minimum number of days first and last encounter;
1545      + 		proc sql noprint;		
1546      +			Create Table _EncEnr as
1547      +			Select 	distinct PatId,					
1548      +            		&QUERYFROM. + min(&MINCONDFROM.,&MINWASHPER.,0) as Enr_Start_Date format=MMDDYY10.,
1549      +					&QUERYTO. + max(&MAXCONDTO.,0)  as Enr_End_Date format=MMDDYY10.
1550      +        	from _EncSummary
1551      +			where NumDays>=&EB2DAYS. and NumEnc>=&EB2ENCNUMS.;
1552      +        quit;
1553      +
1554      +        %let ALTENR = _EncEnr;
1555      +	%END;
1556      +	%ELSE %DO;		
35                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1557      +        %let ALTENR = %QKCMPRES(indata.&ENRTABLE.);
1558      +	%END;
1559      +%mend;
1560      +%wrapper;
1561      +%put &ALTENR.;
1562      +
1563      +proc sql noprint;
1564      +   	Create Table _DenomInt as
1565      +   	Select  Demogs.PatId,
1566      +           	Demogs.Birth_Date,
1567      +           	Demogs.sex,
1568      +		   	Demogs.Hispanic format=$2.,
1569      +		   	Demogs.Race format=$2.,
1570      +           	Enrol.Enr_Start_Date as Enr_Start format=MMDDYY10.,
1571      +           	Enrol.Enr_End_Date as Enr_End format=MMDDYY10.,
1572      +			1 as MedCov,
1573      +			1 as DrugCov
1574      +   	From &ALTENR. as Enrol
1575      +         right join indata.&DEMTABLE. as Demogs
1576      +	On Demogs.PatId=Enrol.PatId
1577      +   	Where Demogs.Birth_Date ne . and not missing(Demogs.PatId)
1578      +   	order by Patid, Enr_Start, Enr_end;
1579      +quit;
1580      +
1581      +%macro wrapper();
1582      +	data _DenomInt;
1583      +	length Hispanic $2. Race $2. Sex $2.;
1584      +	set  _DenomInt(where=(Enr_End >= Enr_Start));
1585      +	by PatId;
1586      +	format MinAgeDate MaxAgeDate mmddyy10.;
1587      +
1588      +	/*Defensive coding*/
1589      +	if Race in('1') then Race = '01';
1590      +	if Race in('2') then Race = '02';
1591      +	if Race in('3') then Race = '03';
1592      +	if Race in('4') then Race = '04';
1593      +	if Race in('5') then Race = '05';
1594      +	if Race in('6') then Race = '06';
1595      +	if Race in('7') then Race = '07';
1596      +
1597      +	if Sex not in (&SEX. 'XX') then Sex="XX";
1598      +	if Hispanic not in (&HISPANIC. 'XX') then Hispanic="XX";
1599      +	if Race not in (&RACE. 'XX') then Race="XX";
1600      +
1601      +	MinAgeDate = intnx(scan("&AGETYP.",1),birth_date,&MINAGE.,'sameday');
1602      +
1603      +	QToAge = intck('YEAR',birth_date,&QUERYTO.,'C');
1604      +
36                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1605      +	if &MAXAGE.=99999 then MaxAgeDate=intnx('Years',birth_date,110,'sameday');
1606      +	else MaxAgeDate=intnx(scan("&AGETYP.",&NUMAGECAT.),birth_date,&MAXAGE.+1,'sameday')-1;
1607      +
1608      +	*Change episode if maximum allowable gap is reached or if changes occur in benefit coverage;
1609      +	%IF %UPCASE("&COVERAGE.") eq %STR("MD") %THEN %DO;
1610      +		if Enr_Start-lag(Enr_end)-1 > &ENROLGAP. or MedCov ne lag(MedCov) or DrugCov ne lag(DrugCov) then episode=episode+1;
1611      +	%END;
1612      +	%IF %UPCASE("&COVERAGE.") eq %STR("M") %THEN %DO;
1613      +		if Enr_Start-lag(Enr_end)-1 > &ENROLGAP. or MedCov ne lag(MedCov) then episode=episode+1;
1614      +	%END;
1615      +	%IF %UPCASE("&COVERAGE.") eq %STR("D") %THEN %DO; 	
1616      +		if Enr_Start-lag(Enr_end)-1 > &ENROLGAP. or DrugCov ne lag(DrugCov) then episode=episode+1;
1617      +	%END;
1618      +	if first.Patid then episode=1;
1619      +	retain episode;
1620      +	run;
1621      +%mend wrapper;
1622      +%wrapper();
1623      +
1624      +/*---------------------------------------------------------------------------------------------------*/
1625      +/* 4.0 Process eligibility data                                                                      */
1626      +/*---------------------------------------------------------------------------------------------------*/
1627      +
1628      +/*Reconciliation of elig episodes*/
1629      +proc means data=_DenomInt nway noprint;
1630      +var Enr_Start Enr_end;
1631      +class PatId episode;
1632      +id Birth_Date sex MinAgeDate MaxAgeDate QToAge Race Hispanic MedCov DrugCov;
1633      +output out=_DenomInt(drop=_:) min(Enr_Start)= max(Enr_end)=;
1634      +run;
1635      +
1636      +data _DenomInt;
1637      +set _DenomInt;
1638      +TopCount = 0;
1639      +if Enr_End >= &QUERYFROM. and Enr_Start <= &QUERYTO. then TopCount = 1;
1640      +
1641      +AgeCount = 0;
1642      +if TopCount and (MaxAgeDate >= Enr_Start and MinAgeDate <= Enr_End) then AgeCount = 1;
1643      +run;
1644      +
1645      +proc sql noprint;
1646      +	create table _Coverage as
1647      +	select PatId,
1648      +		   MedCov,
1649      +	       DrugCov,
1650      +		   max(MedCov+DrugCov) as MaxNumCov
1651      +	from _DenomInt
1652      +	where TopCount=1
37                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1653      +	group by PatId;
1654      +quit;
1655      +
1656      +proc means data=_Coverage nway noprint;
1657      +var MedCov DrugCov;
1658      +class PatId;
1659      +where MaxNumCov < 2;
1660      +output out=_Coverage(drop=_:) min=;
1661      +run;
1662      +
1663      +data _Coverage;
1664      +set _Coverage;
1665      +*Flag that indicates if a patient has at least one episode with both Drug and Medical coverage or
1666      + if he always has the same coverage pattern for all episodes;
1667      +PatHasBothCovOROneCovPatternDum=1;
1668      +*This case means that we have at leat one episode without MedCov and at least one without DrugCov;
1669      +if MedCov=0 and DrugCov=0 then PatHasBothCovOROneCovPatternDum=0;	
1670      +run;
1671      +
1672      +data _DenomInt;
1673      +merge _DenomInt _Coverage(in=b keep=PatId PatHasBothCovOROneCovPatternDum);
1674      +by PatId;
1675      +if not b then PatHasBothCovOROneCovPatternDum=1;
1676      +MedCovDum=MedCov;
1677      +DrugCovDum=DrugCov;
1678      +Member=1;
1679      +run;
1680      +
1681      +%MACRO WRAPPER;
1682      +   	%IF %UPCASE("&COVERAGE.") eq %STR("MD") or %UPCASE("&COVERAGE.") eq %STR("DM") %THEN %DO;
1683      +   		data _DenomInt;
1684      +	  	set _DenomInt;
1685      +	  	if PatHasBothCovOROneCovPatternDum=0 then do;
1686      +	  		MedCovDum=1;
1687      +			DrugCovDum=1;
1688      +	  	end;
1689      +	  	run;
1690      +   	%END;
1691      +   	%IF %UPCASE("&COVERAGE.") eq %STR("M") %THEN %DO;
1692      +    	data _DenomInt;
1693      +	  	set _DenomInt;	
1694      +	  	PatHasBothCovOROneCovPatternDum=1;
1695      +	  	DrugCovDum=1;	
1696      +	  	run;
1697      +   	%END;
1698      +   	%IF %UPCASE("&COVERAGE.") eq %STR("D") %THEN %DO;
1699      +      	data _DenomInt;
1700      +	  	set _DenomInt;	
38                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1701      +	  	PatHasBothCovOROneCovPatternDum=1;
1702      +	  	MedCovDum=1;	
1703      +	  	run;
1704      +   	%END;
1705      +%MEND WRAPPER;
1706      +%WRAPPER;
1707      +
1708      +proc sql noprint;
1709      +	create table _waterfall_
1710      +	(
1711      +		CritNum num format=best.,
1712      +		CritDesc char(200) format=$200.,
1713      +		CritCnt num format=best.
1714      +	);
1715      +quit;
1716      +
1717      +%MS_ATTRITIONTABLE(INFILE=_DenomInt,CRITFLAG=Member,CLASSVARS=PatId,WHERE=1,EXCLUDEDVAR=,
1718      +                   OUTFILE=_waterfall_,
1719      +                   CRITDESC="Initial Patient Count - Patients with non-missing DOB or PATID",
1720      +                   CRITNUM=1,
1721      +                   CRITCNTNAME=CritCnt,
1722      +                   ADDITIONALVARS=
1723      +);
1724      +
1725      +%MS_ATTRITIONTABLE(INFILE=_DenomInt,CRITFLAG=TopCount,CLASSVARS=PatId,WHERE=TopCount=1,EXCLUDEDVAR=,
1726      +                   OUTFILE=_waterfall_,
1727      +                   CRITDESC="Inclusion - Patients meet the enrollment criteria within the query period (&QUERYFROMc. - &QUERYTOc.)",
1728      +                   CRITNUM=2,
1729      +                   CRITCNTNAME=CritCnt,
1730      +                   ADDITIONALVARS=
1731      +);
1732      +
1733      +%MS_ATTRITIONTABLE(INFILE=_DenomInt,CRITFLAG=AgeCount,CLASSVARS=PatId,WHERE=TopCount=1 and DrugCovDum=1 and MedCovDum=1 and
1733     !+PatHasBothCovOROneCovPatternDum=1,EXCLUDEDVAR=,
1734      +                   OUTFILE=_waterfall_,
1735      +                   CRITDESC="Inclusion - Patients fall within the specified age groups (AgeGroups = &AGESTRAT.) for any encounter within
1735     !+the query period (&QUERYFROMc. - &QUERYTOc.)",
1736      +                   CRITNUM=3,
1737      +                   CRITCNTNAME=CritCnt,
1738      +                   ADDITIONALVARS=
1739      +);
1740      +
1741      +proc sql noprint;
1742      +	create table _waterfall as
1743      +	select grp.Group,
1744      +	       wat.CritNum,
1745      +		   wat.CritDesc,
1746      +		   wat.CritCnt
39                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1747      +	   from _waterfall_ as wat,
1748      +	        _grouplist as grp;
1749      +quit;
1750      +
1751      +%macro wrapper;
1752      +	data _DenomInt DenomIntForReport;
1753      +   	set _DenomInt(where=(DrugCovDum=1 and MedCovDum=1 and PatHasBothCovOROneCovPatternDum=1));
1754      +
1755      +	if enr_end < MinAgeDate or QToAge < 0 then delete;
1756      +
1757      +	LastAgeGroup =&NUMAGECAT.;
1758      +	do i=&NUMAGECAT. to 1 by -1;
1759      +	  	Threshdate=intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday');
1760      +	  	if Threshdate <= min(&QUERYTO.,Enr_end)  then do;
1761      +	     	LastAgeGroup =i;
1762      +	     	FirstAgeGroup=i;
1763      +	     	if Threshdate >  max(&QUERYFROM.,Enr_Start) then do;
1764      +	        	do j=i-1 to 1 by -1;
1765      +	           		if  intnx(scan("&AGETYP.",j),birth_date,scan("&AGETHRESH.",j),'sameday') <= max(&QUERYFROM.,Enr_Start) then do;
1766      +	              		FirstAgeGroup=j;
1767      +	              		leave;
1768      +	           		end;
1769      +	        	end;
1770      +	     	end;
1771      +			leave;
1772      +	  	end;
1773      +	end;
1774      +
1775      +	/*Should delete from denom where age at end is outside*/
1776      +	QToAgeGroup = &NUMAGECAT.;
1777      +	do i=&NUMAGECAT. to 1 by -1;
1778      +		Threshdate=intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday');
1779      +		if Threshdate <= &QUERYTO. then do;
1780      +	   		QToAgeGroup = i;
1781      +	   		leave;
1782      +		end;
1783      +	end;
1784      +	%if %UPCASE("&AGECALC.") eq %STR("F") %then %do;
1785      +		if &MINAGE. <= QToAge <= &MAXAGE.;
1786      +	%end;
1787      +
1788      +	rename episode=EligEpisode;
1789      +	drop i j Threshdate TopCount AgeCount DrugCov MedCov DrugCovDum MedCovDum PatHasBothCovOROneCovPatternDum;
1790      +	run;
1791      +%mend wrapper;
1792      +%wrapper;
1793      +
1794      +
40                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1795      +proc datasets library=work nowarn nolist;
1796      +change _MasterQueryfile=_MasterQueryfile_;
1797      +quit;
1798      +
1799      +proc sql noprint;
1800      +	create table _MasterQueryfile as
1801      +	Select mast.*
1802      +	from _MasterQueryfile_ as mast,
1803      +	     _denomint as enrol
1804      +	where mast.PatId = enrol.PatId and enrol.Enr_Start <= mast.Admit_Date <= enrol.Enr_End;
1805      +quit;
1806      +
1807      +proc datasets library=work nowarn nolist;
1808      +delete _MasterQueryfile_;
1809      +quit;
1810      +
1811      +/*---------------------------------------------------------------------------------------------------*/
1812      +/* 5.0 Create FDATE table                                                                            */
1813      +/*---------------------------------------------------------------------------------------------------*/
1814      +
1815      +/*Find Min date per QueryGroup Date*/
1816      +proc means noprint data =_MasterQueryfile nway;
1817      +var Admit_Date;
1818      +Class PatId Group;
1819      +where &QUERYFROM. <= Admit_Date <= &QUERYTO. and Query=1;  /*keeping only Admit_Dates that are index dates candidates*/
1820      +output out=_FDateTable(drop=_:) min = MinDt;
1821      +run;
1822      +
1823      +proc sql noprint;
1824      +create table _condcoverage0 as
1825      +	Select  fdats.*,
1826      +       		claims.Admit_Date,
1827      +       		claims.WashPer,			
1828      +			claims.CondFrom,
1829      +			claims.CondTo,
1830      +			claims.inclusion
1831      +   from _MasterQueryfile as claims,
1832      +        _FDateTable as fdats
1833      +   where claims.cond=1 and fdats.PatId = claims.PatID and fdats.Group=claims.Group and
1834      +         claims.Admit_Date >= fdats.MinDt + claims.CondFrom
1835      +   order by PatId, group, Admit_Date;
1836      +quit;
1837      +
1838      +proc sort nodupkey data = _condcoverage0(rename=Admit_Date=Cdate);
1839      +by PatId Group inclusion CondFrom CondTo Cdate;
1840      +run;
1841      +
1842      +/*Create QueryGroup Date Variables*/
41                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1843      +proc transpose data = _FDateTable
1844      +               out = _FDateTable(drop=_NAME_);
1845      +id Group;
1846      +var MinDt;
1847      +by PatId;
1848      +run;
1849      +
1850      +proc transpose data=_querysettings out=_Groups(drop=_NAME_);
1851      +id Group;
1852      +run;
1853      +
1854      +data _Groups;
1855      +set _Groups;
1856      +if _N_ = 0;
1857      +run;
1858      +
1859      +data _FDateTable;
1860      +set _FDateTable;
1861      +if _N_=0 then set _Groups;
1862      +format MinFdt MMDDYY10. MaxFdt MMDDYY10.;
1863      +MinFdt = min(&GROUPVECT.,.);
1864      +MaxFdt = max(&GROUPVECT.,.);
1865      +run;
1866      +
1867      +/*Reduce enrollment to study patients*/
1868      +data _Enrollment(keep=PatId Enr_Start Enr_End sex Hispanic Race birth_date MinAgeDate MaxAgeDate QToAge);
1869      +if 0 then set _FDateTable;
1870      +declare hash ht (hashexp:16, dataset:'_FDateTable');
1871      +ht.definekey('PatId');
1872      +ht.definedata(ALL: 'YES');
1873      +ht.definedone();
1874      +
1875      +do until(eof1);
1876      +	set _DenomInt end=eof1;
1877      +	if ht.find()=0 then do;
1878      +		output _Enrollment;
1879      +	end;
1880      +end;
1881      +
1882      +stop;
1883      +run;
1884      +
1885      +%LET I=1;
1886      +
1887      +/*---------------------------------------------------------------------------------------------------*/
1888      +/* 6.0 For each query drug and patient, assess prevalent vs. incident, retrieve                      */
1889      +/*     dispensings during query period to compute usage by patient and query drug.                   */
1890      +/*---------------------------------------------------------------------------------------------------*/
42                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1891      +%global NQUERYGROUP;
1892      +%MACRO LOOPTHROUGH(); /*Loop for each query drug*/
1893      +
1894      +	data _null_;
1895      +	set _GroupList end=fin;
1896      +	if fin then call symputx('NQUERYGROUP',_n_);
1897      +	run;
1898      +
1899      +   	%PUT &NQUERYGROUP.;
1900      +
1901      +   	%DO i = 1 %TO &NQUERYGROUP.;
1902      +
1903      +		data _null_;
1904      +		set _GroupList;
1905      +		if _n_ = &i. then call symputx('ITGROUP',strip(Group));
1906      +		run;
1907      +
1908      +		%PUT &ITGROUP;
1909      +
1910      +		data _loopsettings;
1911      +		set _querysettings(where=(Group in("&ITGROUP.")));
1912      +		drop Group;
1913      +		run;
1914      +
1915      +		%LET INCLREQD=0;  /*No INCLUSION for this QUERYGROUP*/
1916      +		%LET EXCLREQD=0;  /*No EXCLUSION for this QUERYGROUP*/
1917      +
1918      +		data _LoopCondFile;
1919      +		set _condfile;
1920      +		if Group = "&ITGROUP.";
1921      +		if Inclusion=1 then call symputx('INCLREQD',1);
1922      +		if Inclusion=0 then call symputx('EXCLREQD',1);
1923      +		run;
1924      +
1925      +		%PUT &INCLREQD. &EXCLREQD.;
1926      +
1927      +		/*For each query drug get index date for each Pat Id*/
1928      +		data _SDFDateTable(keep=PatId WashTyp WashPer EnrDays);
1929      +		set _FDateTable;
1930      +		if _N_ = 1 then set _loopsettings;
1931      +		if &ITGROUP.;
1932      +		run;
1933      +
1934      +		/*Check for index date minus washout days for dispensings of query drugs
1935      +		and identify dispensings of query drug between index date and end of query period*/
1936      +		data _Quantity;
1937      +		if 0 then set _SDFDateTable;
1938      +		declare hash ht (hashexp:16, dataset:'_SDFDateTable');
43                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1939      +		ht.definekey('PatId');
1940      +		ht.definedata(ALL: 'YES');
1941      +		ht.definedone();
1942      +
1943      +		do until(eof1);
1944      +			set _MasterQueryfile(where=((Group in("&ITGROUP.") or
1945      +			            		         IGroup in("&ITGROUP.","_ALLGROUPS_")) and
1946      +			              				 (query or incid))) end=eof1;
1947      +			if ht.find()=0 then do;
1948      +				InQuery = 0;
1949      +			 	if Group in("&ITGROUP.") and &QUERYFROM. <= Admit_Date <= &QUERYTO. then InQuery = 1;
1950      +			 	output _Quantity;
1951      +			end;
1952      +		end;
1953      +		stop;
1954      +		run;
1955      +
1956      +		proc sort data = _Quantity out=_IEpisode;
1957      +		by PatId Admit_Date descending InQuery;
1958      +		run;
1959      +
1960      +		proc sort nodupkey data = _IEpisode;
1961      +		by PatId Admit_Date;
1962      +		run;
1963      +
1964      +		/*create independent treatment episodes*/
1965      +		data _IEpisode;
1966      +		set _IEpisode(keep=PatId WashPer WashTyp InQuery Admit_Date);
1967      +		by PatId;
1968      +		format lAdmit_Date mmddyy10. indexdt mmddyy10.;
1969      +
1970      +		lAdmit_Date = lag(Admit_Date);
1971      +		if first.PatId then do;
1972      +			lAdmit_Date = .;
1973      +			episode=0;
1974      +			indexdt=.;
1975      +		end;
1976      +		else diff = Admit_Date - lAdmit_Date - 1;
1977      +
1978      +		if WashTyp in('MIN') then do;
1979      +			if InQuery and diff = . then do;
1980      +				indexdt=Admit_Date;
1981      +				episode=episode+1;
1982      +				output;
1983      +			end;
1984      +		end;
1985      +
1986      +		if WashTyp in('MULT','SING') then do;
44                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

1987      +			if InQuery and (diff = . or diff >= WashPer) then do;
1988      +				indexdt=Admit_Date;
1989      +				episode=episode+1;
1990      +				output;
1991      +			end;
1992      +		end;
1993      +
1994      +		retain episode;
1995      +		drop InQuery lAdmit_Date diff;
1996      +		run;
1997      +
1998      +		/*Defensive coding*/
1999      +		Proc SQL Noprint;
2000      +			Create Table _CleanAdmit_Dates as
2001      +			Select  IDates.PatId,
2002      +					IDates.WashPer,
2003      +					IDates.WashTyp,
2004      +					IDates.Admit_Date,
2005      +					IDates.Indexdt,
2006      +					(IDates.Admit_Date - enrol.Enr_Start) as EnrNumDays
2007      +			From _IEpisode as IDates,
2008      +				 _Enrollment as enrol
2009      +			Where IDates.PatId = enrol.PatId and enrol.Enr_Start <= IDates.Admit_Date <= enrol.Enr_End
2010      +			Order by PatId, Admit_Date;
2011      +		quit;
2012      +
2013      +		/*---------------------------------------------------------------------------------------------------*/
2014      +		/*    6.1 If two or more records for a dispensing date of the same drug, take the max Dispense_Sup and Dispense_Amt*/
2015      +		/*---------------------------------------------------------------------------------------------------*/
2016      +
2017      +		proc means noprint data = _Quantity nway;
2018      +		var Dispense_Amt Dispense_Sup;
2019      +		class PatId Admit_Date;
2020      +		id Group WashTyp EnrDays;
2021      +		where InQuery;
2022      +		output out=_Quantity_(drop=_:) sum(Dispense_Amt Dispense_Sup) = Dispense_Amt Dispense_Sup
2023      +		                               N(Dispense_Amt) = NumDipensing;
2024      +		run;
2025      +
2026      +		/*claims must be within eligibility*/
2027      +		proc sql noprint;
2028      +			create table _Quantity as
2029      +			Select  qnt.*,
2030      +					enrol.MinAgeDate,
2031      +					enrol.MaxAgeDate,
2032      +					enrol.QToAge,
2033      +					(qnt.Admit_Date - enrol.Enr_Start) as EnrNumDays	
2034      +					from _Quantity_ as qnt,
45                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2035      +						 _Enrollment as enrol
2036      +			Where qnt.PatId = enrol.PatId and enrol.Enr_Start <= qnt.Admit_Date <= enrol.Enr_End
2037      +			Order by PatId, Admit_Date;
2038      +		Quit;
2039      +
2040      +		/*Assessing NoClaimsBef status at start of episode only*/
2041      +		/*The WNumDays variable is in a and b, however, for common will have the same value*/
2042      +		%MACRO WRAPPER;
2043      +			data _MasterTable_;
2044      +			merge _Quantity(in=a) _CleanAdmit_Dates(in=b);
2045      +			by PatId Admit_Date;
2046      +			if a;
2047      +			Dispense_Amt = floor(Dispense_Amt);
2048      +			label Dispense_Amt="Dispense_Amt";
2049      +			label Dispense_Sup="Dispense_Sup";
2050      +
2051      +			NoClaimsBef = 0;
2052      +			if b then NoClaimsBef = 1;
2053      +			Enr = 0;
2054      +			if EnrNumDays>=0 and EnrNumDays >= EnrDays then Enr = 1;
2055      +
2056      +			Wash = 0;
2057      +			if EnrNumDays>=0 and EnrNumDays >= WashPer then Wash = 1;	* In case Washper is greater than EnrDays;
2058      +
2059      +			RxYear = Year(Admit_Date);
2060      +			RxMonth = Month(Admit_Date);
2061      +
2062      +			GClaim = 1;
2063      +
2064      +			QueryEnrDum = 0;
2065      +			if Enr then QueryEnrDum = 1;
2066      +
2067      +			QueryWashDum = 0;
2068      +			if QueryEnrDum and Wash then QueryWashDum = 1;
2069      +
2070      +			IncQueryDum = 0;
2071      +			if QueryEnrDum and QueryWashDum and NoClaimsBef then IncQueryDum = 1;
2072      +
2073      +			%IF %UPCASE("&AGECALC.") eq %STR("I") %THEN %DO;
2074      +				if MinAgeDate <= Admit_Date <= MaxAgeDate;
2075      +			%END;
2076      +			%IF %UPCASE("&AGECALC.") eq %STR("F") %THEN %DO;
2077      +				if &MINAGE. <= QToAge <= &MAXAGE.;
2078      +			%END;
2079      +			run;
2080      +		%MEND WRAPPER;
2081      +		%WRAPPER;
2082      +
46                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2083      +		%MS_ATTRITIONTABLE(INFILE=_MasterTable_,CRITFLAG=GClaim,CLASSVARS=PatId,WHERE=1,EXCLUDEDVAR=,
2084      +				           OUTFILE=_waterfall,
2085      +				           CRITDESC="Inclusion - Patients must have at least one &ITGROUP. encounter within the query period (&QUERYFROMc. -
2085     !+&QUERYTOc.)",
2086      +				           CRITNUM=4,
2087      +				           CRITCNTNAME=CritCnt,
2088      +				           ADDITIONALVARS=Group="&ITGROUP."
2089      +		);
2090      +
2091      +		/*Merge claims with valid pre-existing condition periods*/
2092      +		data _condcoverageloop;
2093      +		set _condcoverage0;
2094      +		where Group in("&ITGROUP.");
2095      +		run;
2096      +
2097      +		proc sql noprint;
2098      +			create table _MasterTable as
2099      +			Select  claims.*,
2100      +					pdates.CondFrom,
2101      +					pdates.CondTo,
2102      +					pdates.CDate,					
2103      +					pdates.Inclusion
2104      +			from _MasterTable_ as claims left join
2105      +				 _condcoverageloop as pdates
2106      +			on claims.PatId = pdates.PatId
2107      +			order PatId, Admit_Date, CDate;
2108      +		quit;
2109      +
2110      +		proc datasets library=work nolist nowarn;
2111      +		delete _MasterTable_;
2112      +		quit;
2113      +
2114      +		/*Identify claims overlapping pre-existing condition period*/
2115      +		data _MasterTable;
2116      +		set _MasterTable;
2117      +
2118      +		PIncCondDum = 0;
2119      +		PExcCondDum = 1;
2120      +
2121      +		/*If no inclusion are required for this group, we set the default HadCond=1*/
2122      +		if &INCLREQD.=1 then HadCond = 0;
2123      +		else do;
2124      +			HadCond = 1;  /*only exclusions are required or no pre-existing conditions at all*/
2125      +			PIncCondDum = 1;
2126      +		end;
2127      +
2128      +		if cdate ne . then do;
2129      +			if Admit_Date + CondFrom <= CDate <= Admit_Date + CondTo then do;
47                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2130      +				if inclusion=1 then do;
2131      +					HadCond = 1;
2132      +				    PIncCondDum = 1;
2133      +				end;
2134      +				else do;
2135      +				    HadCond = 2;
2136      +					PExcCondDum = 0;
2137      +				end;
2138      +			end;
2139      +		end;
2140      +		run;
2141      +
2142      +		%MACRO WRAPPER;
2143      +			%IF &EXCLREQD. = 1 %THEN %DO;
2144      +				proc sort nodupkey data=_LoopCondFile;
2145      +				by CondFrom CondTo;
2146      +				where inclusion=0;
2147      +				run;
2148      +
2149      +				data _LoopCondFile;
2150      +				set _LoopCondFile end=fin;
2151      +				where inclusion=0;
2152      +				ExclNum=_N_;
2153      +				if fin then call symputx("NumExcl",ExclNum);
2154      +				run;
2155      +
2156      +		    	%PUT &NumExcl.;
2157      +
2158      +				proc sql noprint;
2159      +				create table _ExclEligFlags as
2160      +				Select  claims.Patid,
2161      +						claims.Admit_Date,
2162      +						edates.Enr_Start,
2163      +						edates.Enr_End,
2164      +						lookup.CondFrom,
2165      +						lookup.CondTo,
2166      +						lookup.ExclNum
2167      +				from _LoopCondFile as lookup,
2168      +					 _MasterTable as claims,
2169      +					 _Enrollment as edates
2170      +				where claims.PatId = edates.PatId;
2171      +				quit;
2172      +
2173      +				data _ExclEligFlags;
2174      +				set _ExclEligFlags;
2175      +				meet=1;
2176      +				/*Enrollment episode completely overlaps this exclusion period*/
2177      +				if Enr_Start <= Admit_Date + CondFrom and Enr_end >= Admit_Date + CondTo then output;
48                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2178      +				keep Patid Admit_Date ExclNum meet;
2179      +				run;
2180      +
2181      +				proc means data=_ExclEligFlags nway noprint;
2182      +				var meet;
2183      +				class PatId Admit_Date ExclNum;
2184      +				output out=_ExclEligFlags(drop=_:) max=;
2185      +				run;
2186      +
2187      +				proc means data=_ExclEligFlags nway noprint;
2188      +				var meet;
2189      +				class PatId Admit_Date;
2190      +				output out=_ExclEligFlags(drop=_:) sum=NumExclCritmeet;
2191      +				run;
2192      +
2193      +				/*Members who meet the eligibility criteria for all of the exclusion period*/
2194      +				data _ExclEligFlags;
2195      +				set _ExclEligFlags;
2196      +				where  NumExclCritmeet=&NumExcl.;
2197      +				keep PatId Admit_Date;
2198      +				run;
2199      +			%END;
2200      +		 	%ELSE %DO;
2201      +				data _ExclEligFlags;
2202      +				set _MasterTable(obs=1 keep=Patid Admit_Date);
2203      +				if _N_<0;
2204      +				run;
2205      +			%END;
2206      +		%MEND WRAPPER;
2207      +		%WRAPPER;
2208      +
2209      +		proc sort data = _MasterTable;
2210      +		by PatId Admit_Date descending HadCond;
2211      +		run;
2212      +
2213      +		proc sort nodupkey data = _MasterTable;
2214      +		by PatId Admit_Date;
2215      +		run;
2216      +
2217      +		data _MasterTable;
2218      +		merge _MasterTable(in=a) _ExclEligFlags(in=b);
2219      +		by  PatId Admit_Date;
2220      +		if a;
2221      +
2222      +		if  &EXCLREQD. = 1 then ExclCritmeet=0;
2223      +		else ExclCritmeet=1;
2224      +
2225      +		if b then ExclCritmeet=1;
49                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2226      +		run;
2227      +
2228      +		/*
2229      +		Note:  At this step (_MasterTable) and for each unique Admit_Date, we know if the patient meets or doesn`t meet
2230      +		       the INCL/ESCL criteria. Specifically,
2231      +		       - HadCond = 2 means that FROM THIS Admit_Date, the member has one or more claim meeting
2232      +		                   the EXCLUSION criteria (from this Admit_Date)
2233      +		       - HadCond = 1 means that FROM THIS Admit_Date, the member has one or more claim meeting
2234      +		                   the INCLUSION criteria, but has no claim meeting the EXCLUSION criteria
2235      +		   	   - HadCond = 0 means that FROM THIS Admit_Date, the member has no claim for neither
2236      +		                   INCLUSIONS or EXCLUSIONS
2237      +		*/
2238      +
2239      +		data _MasterTable;
2240      +		set _MasterTable;
2241      +		/*HadCond = 2 if any exclusion,
2242      +		  HadCond = 1 Only inclusions,
2243      +		  HadCond = 0 if no inclusion nor exclusions*/
2244      +		if NoClaimsBef = 1 and Wash=1 and Enr = 1 and HadCond = 1 and ExclCritmeet = 1 then incident = 1;
2245      +		else incident = 0;
2246      +
2247      +		ExclEligDum = 0;
2248      +		if (QueryEnrDum and QueryWashDum and IncQueryDum) and ExclCritmeet then ExclEligDum = 1;
2249      +
2250      +		ExcCondDum = 0;
2251      +		if (QueryEnrDum and QueryWashDum and IncQueryDum and ExclEligDum) and PExcCondDum then ExcCondDum = 1;
2252      +
2253      +		IncCondDum = 0;
2254      +		if (QueryEnrDum and QueryWashDum and IncQueryDum and ExclEligDum and ExcCondDum) and PIncCondDum then IncCondDum = 1;		
2255      +
2256      +		run;		
2257      +
2258      +		%IF %EVAL(&USEPEC.=1) %THEN %DO;
2259      +			%let NUMGROUPCONDS=0;
2260      +			proc sql noprint;
2261      +			select count(*) into :NUMGROUPCONDS
2262      +			from _condfile
2263      +			where Group="&ITGROUP.";
2264      +			quit;
2265      +
2266      +			%IF %EVAL(&NUMGROUPCONDS.>0) %THEN %DO;
2267      +			%MS_ATTRITIONTABLE(INFILE=_MasterTable,CRITFLAG=ExcCondDum,CLASSVARS=PatId,WHERE=Group="&ITGROUP.",EXCLUDEDVAR=,
2268      +					           OUTFILE=_waterfall,
2269      +					           CRITDESC="Inclusion  Patients must not have at least one &ITGROUP. satisfying the exclusion conditions",
2270      +					           CRITNUM=5,
2271      +					           CRITCNTNAME=CritCnt,
2272      +					           ADDITIONALVARS=Group="&ITGROUP."
2273      +			);
50                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2274      +
2275      +			%MS_ATTRITIONTABLE(INFILE=_MasterTable,CRITFLAG=IncCondDum,CLASSVARS=PatId,WHERE=Group="&ITGROUP.",EXCLUDEDVAR=,
2276      +					           OUTFILE=_waterfall,
2277      +					           CRITDESC="Inclusion  Patients must have at least one &ITGROUP. satisfying the inclusion conditions",
2278      +					           CRITNUM=6,
2279      +					           CRITCNTNAME=CritCnt,
2280      +					           ADDITIONALVARS=Group="&ITGROUP."
2281      +			);
2282      +			%END;
2283      +		%END;
2284      +
2285      +
2286      +		/*FHadCondDt defined as the first Query claim to
2287      +		  respect the pre-existing condition criterion*/
2288      +		proc means noprint data = _MasterTable nway;
2289      +		var Admit_Date;
2290      +		class PatId;
2291      +		where HadCond = 1 and ExclCritmeet = 1;
2292      +		output out=_FHadCondDt(drop=_:) min=FHadCondDt;
2293      +		run;
2294      +
2295      +		/*keeping only claims thereafter*/
2296      +		data _MasterTable;
2297      +		if 0 then set _FHadCondDt;
2298      +		declare hash ht (hashexp:16,dataset:"_FHadCondDt");
2299      +		ht.definekey('PatId');
2300      +		ht.definedata(ALL:'YES');
2301      +		ht.definedone();
2302      +
2303      +		do until(eof1);
2304      +			set _MasterTable end=eof1;
2305      +			if ht.find()=0 then do;
2306      +				if Admit_Date >= FHadCondDt then output;
2307      +			end;
2308      +		end;
2309      +
2310      +		stop;
2311      +		run;
2312      +
2313      +		/*Get first incident index date*/
2314      +		proc means noprint data = _MasterTable nway;
2315      +		var Admit_Date;
2316      +		Class PatId;
2317      +		where incident = 1;
2318      +		output out=_FIncDt(drop=_:) min=FIncDt;
2319      +		run;
2320      +
2321      +		data _MasterTable;
51                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2322      +		if 0 then set _FIncDt;
2323      +		declare hash ht (hashexp:16,dataset:"_FIncDt");
2324      +		ht.definekey('PatId');
2325      +		ht.definedata(ALL:'YES');
2326      +		ht.definedone();
2327      +
2328      +		do until(eof1);
2329      +			set _MasterTable end=eof1;
2330      +			if ht.find() ne 0 then do;
2331      +				call missing(FIncDt);
2332      +			end;
2333      +			output;
2334      +		end;
2335      +		stop;
2336      +		run;
2337      +
2338      +		data _premaster1
2339      +		     _premaster2;
2340      +		set _MasterTable;
2341      +
2342      +		if WashTyp = "SING" and Incident=1 then output _premaster1;
2343      +		else output _premaster2;
2344      +		run;
2345      +
2346      +		proc sort data = _premaster1;
2347      +		by Group PatId Admit_Date;
2348      +		run;
2349      +
2350      +		data _premaster1;
2351      +		set _premaster1;
2352      +		by Group PatId;
2353      +		if not first.PatID then Incident=0;
2354      +		run;
2355      +
2356      +		data _MasterTable;
2357      +		set _premaster1
2358      +		    _premaster2;
2359      +		run;
2360      +
2361      +		%IF &I.=1 %THEN %DO;
2362      +			data DMLocal.&REQUESTID.&RUNID._MasterTable;
2363      +			set _MasterTable;
2364      +			run;
2365      +		%END;
2366      +		%ELSE %DO;
2367      +			proc append base = DMLocal.&REQUESTID.&RUNID._MasterTable
2368      +						data = _MasterTable force;
2369      +			run;
52                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2370      +		%END;
2371      +	%END;
2372      +%MEND LOOPTHROUGH;
2373      +%LOOPTHROUGH();
2374      +
2375      +proc sort data = _waterfall;
2376      +by Group CritNum;
2377      +run;
2378      +options nosymbolgen nomprint;
2379      +
2380      +data DMLOCAL.&REQUESTID.&RUNID._AttritionTable
2381      +	 %if %UPCASE("&ATTRITIONTABLE.") eq %STR("Y") %then %do;DRNOC.&REQUESTID.&RUNID._AttritionTable %end;
2382      +;
2383      +set _Waterfall;
2384      +by group;
2385      +
2386      +Excluded = lag(CritCnt) - CritCnt;
2387      +if first.group then Excluded = .;
2388      +
2389      +*Apply threshold;
2390      +if 0 < CritCnt < &THRESHOLD. then CritCnt = .T;
2391      +if 0 < Excluded < &THRESHOLD. then Excluded = .T;
2392      +
2393      +rename CritCnt = Remaining;
2394      +run;
2395      +options symbolgen mprint;
2396      +
2397      +%LET I=1;
2398      +
2399      +%MACRO DENOMLOOP();
2400      +
2401      +	data _null_;
2402      +	set _GroupList end=fin;
2403      +	if fin then call symputx('NQUERYGROUP',_n_);
2404      +	run;
2405      +
2406      +   	%PUT &NQUERYGROUP.;
2407      +
2408      +   	%DO i = 1 %TO &NQUERYGROUP.;
2409      +
2410      +		data _null_;
2411      +		set _GroupList;
2412      +		if _n_ = &I. then do;
2413      +			call symputx('ITGROUP',strip(Group));
2414      +		end;
2415      +		run;
2416      +
2417      +      	%PUT &ITGROUP;
53                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2418      +
2419      +		data _null_;
2420      +		set _querysettings;
2421      +		if Group = "&ITGROUP." then do;
2422      +			call symputx('GROUPWASHOUT',WashPer);
2423      +		  	call symputx('GROUPWASHTYP',strip(WashTyp));
2424      +		  	call symputx('GROUPENRDAYS',EnrDays);
2425      +		end;
2426      +		run;
2427      +
2428      +      	%PUT &GROUPWASHOUT. &GROUPWASHTYP. &GROUPENRDAYS.;      	
2429      +		      	
2430      +      	%LET INCLREQD=0;  /*No INCLUSION for this QUERYGROUP*/
2431      +      	%LET EXCLREQD=0;  /*No EXCLUSION for this QUERYGROUP*/
2432      +
2433      +		data _LoopCondFile;
2434      +		set _condfile;
2435      +
2436      +		if Group = "&ITGROUP.";
2437      +		
2438      +		if Inclusion=1 then call symputx('INCLREQD',1);
2439      +		if Inclusion=0 then call symputx('EXCLREQD',1);
2440      +
2441      +		run;
2442      +
2443      +      	%PUT &INCLREQD. &EXCLREQD.;
2444      +
2445      +      	%MACRO WRAPPER();
2446      +      		/*If pre-existing conditions are required need to select members with pre-existing conditions*/
2447      +         	%IF %EVAL(&INCLREQD.>0 or &EXCLREQD.>0) %THEN %DO;
2448      +            	%IF &INCLREQD. = 1 %THEN %DO;
2449      +					proc sort nodupkey data = _masterqueryfile
2450      +					                   out = _cond(keep=PatId Admit_Date CondFrom CondTo);
2451      +					by PatId Admit_Date CondFrom CondTo;
2452      +					where cond and Group in("&ITGROUP.") and Inclusion = 1;
2453      +					run;
2454      +
2455      +					/*Must re-define enrollment episodes to scan only when members meeting the pre-existing
2456      +					  condition requirement*/
2457      +					proc sql noprint;
2458      +						Create table _denomint2 as
2459      +						Select  enrol.*,
2460      +					       		claims.Admit_Date,
2461      +					       		claims.CondFrom,
2462      +					       		claims.CondTo,
2463      +					       		max(claims.Admit_Date - claims.CondTo,enrol.Enr_Start) as PDate format mmddyy10.,
2464      +					       		min(claims.Admit_Date - claims.CondFrom,enrol.Enr_End) as EDate format mmddyy10.
2465      +					   from _Denomint as enrol,
54                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2466      +					        _cond as claims
2467      +					   where enrol.PatId = claims.PatId and enrol.Enr_Start <= claims.Admit_Date - claims.CondFrom and
2468      +					         enrol.Enr_End >= claims.Admit_Date - claims.CondTo
2469      +					   order PatId, EligEPisode, PDate;
2470      +					quit;
2471      +
2472      +					/*for a same elig record, identify overlapping PDate - EDate intervals*/
2473      +					data _MDenomint;
2474      +					set _denomint2;
2475      +					by PatId EligEpisode;
2476      +					format lEDate mmddyy10.;
2477      +
2478      +					lEDate = lag(EDate);
2479      +
2480      +					diff=PDate-lEDate-1;
2481      +
2482      +					if first.EligEpisode then do;
2483      +						lPDate=.;
2484      +						diff=.;
2485      +						PEpisode=1;
2486      +					end;
2487      +					else do;
2488      +					  	if diff > 0 then do;
2489      +					    	PEpisode = PEpisode + 1;
2490      +					  	end;
2491      +					end;
2492      +					retain Pepisode;
2493      +					run;
2494      +
2495      +					proc means data=_MDenomint nway noprint;
2496      +					var PDate EDate;
2497      +					class Patid EligEpisode PEpisode;
2498      +					id Enr_Start Enr_end Birth_Date MinAgeDate MaxAgeDate sex QToAgeGroup Race Hispanic;
2499      +					output out=_MDenomint(drop=_:) min(PDate)=  max(EDate)=;
2500      +					run;
2501      +            	%END;
2502      +            	%ELSE %DO;
2503      +					data _MDenomInt;
2504      +					set _DenomInt(where=(enr_end >= &QUERYFROM. and enr_start <= &QUERYTO.));
2505      +					format PDate EDate mmddyy10.;
2506      +					PDate = max(Enr_Start,&QUERYFROM.);
2507      +					EDate = min(Enr_End,&QUERYTO.);
2508      +					PEpisode = EligEpisode;
2509      +					keep PatId PDate EDate Enr_Start Enr_end Birth_Date MinAgeDate MaxAgeDate sex EligEpisode PEpisode QToAgeGroup Race Hispanic;
2510      +					run;
2511      +            	%END;
2512      +            	%IF &EXCLREQD. = 1 %THEN %DO;
2513      +					proc sort nodupkey data=_LoopCondFile;
55                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2514      +					by CondFrom CondTo;
2515      +					where inclusion=0;
2516      +					run;
2517      +
2518      +					data _LoopCondFile;
2519      +					set _LoopCondFile end=fin;
2520      +					where inclusion=0;
2521      +					ExclNum=_N_;
2522      +					if fin then call symputx("NumExcl",ExclNum);
2523      +					run;
2524      +
2525      +               		%PUT &NumExcl.;
2526      +
2527      +					proc sql noprint;
2528      +					create table _MDenomint_ as
2529      +						Select  pdates.*,
2530      +					       		lookup.CondFrom,
2531      +					       		lookup.CondTo,
2532      +					       		lookup.ExclNum
2533      +					   from _LoopCondFile as lookup,
2534      +					        _MDenomint as pdates
2535      +					   order by PatId, EligEpisode, PEpisode, ExclNum;
2536      +					quit;
2537      +
2538      +					data _MDenomint;
2539      +					set _MDenomint_;
2540      +					format MaxPDate MinEDate mmddyy10.;
2541      +
2542      +					if CondFrom < 0 then MaxPdate = Enr_Start - CondFrom;
2543      +					else MaxPDate = PDate;
2544      +
2545      +					if CondTo > 0 then MinEDate = Enr_End - CondTo;
2546      +					else MinEDate = EDate;
2547      +
2548      +					/*check if above remain consistent*/
2549      +					PDate = max(PDate,MaxPdate);
2550      +					EDate = min(EDate,MinEDate);
2551      +
2552      +					run;
2553      +
2554      +					proc means data=_MDenomint nway noprint;
2555      +					var PDate EDate;
2556      +					class Patid EligEpisode PEpisode;
2557      +					id Enr_Start Enr_end Birth_Date MinAgeDate MaxAgeDate sex QToAgeGroup Race Hispanic;
2558      +					output out=_MDenomint(drop=_: where=(PDate<=EDate)) min(PDate)=  max(EDate)=;
2559      +					run;
2560      +
2561      +					/*go get exclusion claims*/
56                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2562      +					proc sort nodupkey data = _masterqueryfile
2563      +					                   out = _cond(keep=PatId Admit_Date CondFrom CondTo);
2564      +					by PatId Admit_Date CondFrom CondTo;
2565      +					where cond and Group in("&ITGROUP.") and Inclusion = 0;
2566      +					run;
2567      +
2568      +					data _cond;
2569      +					set _cond;
2570      +					format ExcPdate ExcEdate mmddyy10.;
2571      +
2572      +					ExcPdate = Admit_Date - CondTo;
2573      +					ExcEdate = Admit_Date - CondFrom;
2574      +					run;
2575      +
2576      +					proc sort data = _cond;
2577      +					by PatId ExcPdate;
2578      +					run;
2579      +
2580      +					data _cond;
2581      +					set _cond;
2582      +					by Patid;
2583      +					
2584      +					lExcEdate = lag(ExcEdate);
2585      +					diff = ExcPDate - lExcEdate - 1;
2586      +
2587      +					if first.PatId then do;
2588      +					  	lExcEdate = .;
2589      +					  	diff = .;
2590      +					  	ExcEpisode = 1;
2591      +					end;
2592      +					else do;
2593      +					  	if diff > 0 then ExcEpisode = ExcEpisode + 1;
2594      +					end;
2595      +
2596      +					retain ExcEpisode;
2597      +					run;
2598      +
2599      +					proc means noprint data = _cond nway;
2600      +					var ExcPdate ExcEdate;
2601      +					class PatId ExcEpisode;
2602      +					output out=_cond(drop=_: ExcEpisode) min(ExcPdate)= max(ExcEdate)=;
2603      +					run;
2604      +
2605      +					/*left join here with _MDenomint (watch out for multiple merge)*/
2606      +					proc sql noprint;
2607      +					create table _MDenomint_ as
2608      +						Select  pdates.*,
2609      +					       		exdates.ExcPdate,
57                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2610      +					       		exdates.ExcEdate
2611      +					   from _MDenomint as pdates left join
2612      +					        _cond as exdates
2613      +					   on pdates.PatId = exdates.PatId;
2614      +					quit;
2615      +
2616      +					data _MDenomint(where=(PDate<=EDate));
2617      +					set _MDenomint_;
2618      +
2619      +					if (ExcPDate <= PDate and  PDate <= ExcEDate <= EDate) then do;
2620      +					  	PDate = ExcEDate + 1;
2621      +					  	EDate = EDate;
2622      +					  	output;
2623      +					end;
2624      +					else if ExcPDate > PDate and ExcEDate < EDate then do;
2625      +					  	PDate = PDate;
2626      +					  	EDate = ExcPDate - 1;
2627      +					  	output;
2628      +
2629      +					  	PDate = ExcEDate + 1;
2630      +					  	EDate = EDate;
2631      +					  	output;
2632      +					end;
2633      +					else if ExcPDate <= EDate and ExcEDate >= EDate then do;
2634      +					  	PDate = PDate;
2635      +					  	EDate = ExcPDate-1;
2636      +					  	output;
2637      +					end;
2638      +					else output;
2639      +					run;
2640      +
2641      +					proc sort data = _MDenomint;
2642      +					by PatId PDate;
2643      +					run;
2644      +
2645      +					data _MDenomint;
2646      +					set _MDenomint;
2647      +					by PatId;
2648      +
2649      +					lEDate = lag(EDate);
2650      +					diff = PDate - lEDate- 1;
2651      +
2652      +					if first.PatID then do;
2653      +					  	lEDate = .;
2654      +					  	diff = .;
2655      +					  	PEpisode = 1;
2656      +					end;
2657      +					else do;
58                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2658      +					  	if diff > 0  then PEpisode = PEpisode + 1;
2659      +					end;
2660      +
2661      +					retain PEpisode;
2662      +					run;
2663      +
2664      +					proc means noprint data = _MDenomint nway;
2665      +					var PDate EDate;
2666      +					class PatId EligEpisode PEpisode;
2667      +					id Enr_Start Enr_end Birth_Date MinAgeDate MaxAgeDate sex QToAgeGroup Race Hispanic;
2668      +					output out=_MDenomint(drop=_:) min(PDate)= max(EDate)=;
2669      +					run;
2670      +
2671      +            	%END;
2672      +
2673      +				data _MDenomInt;
2674      +				set _MDenomInt(where=(enr_end >= &QUERYFROM. and enr_start <= &QUERYTO.));
2675      +
2676      +				Enr_End = min(Enr_End,EDate);
2677      +				
2678      +				if enr_end < MinAgeDate then delete;
2679      +
2680      +				LastAgeGroup=&NUMAGECAT.;
2681      +				do i=&NUMAGECAT. to 1 by -1;
2682      +					Threshdate=intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday');
2683      +					if Threshdate<= min(&QUERYTO.,Enr_end) then do;
2684      +						LastAgeGroup =i;
2685      +						FirstAgeGroup=i;
2686      +						if Threshdate > max(&QUERYFROM.,Enr_Start)  then do;
2687      +							do j=i-1 to 1 by -1;
2688      +								if intnx(scan("&AGETYP.",j),birth_date,scan("&AGETHRESH.",j),'sameday') <=
2689      +								max(&QUERYFROM.,Enr_Start) then do;
2690      +									FirstAgeGroup=j;
2691      +									leave;
2692      +								end;
2693      +							end;
2694      +						end;
2695      +						leave;
2696      +					end;
2697      +				end;
2698      +				drop i j threshdate;
2699      +				run;
2700      +         	%END; /*end for either inclusion or exclusion*/
2701      +         	%ELSE %DO;
2702      +				data _MDenomInt;
2703      +				set _DenomInt(where=(enr_end >= &QUERYFROM. and enr_start <= &QUERYTO.));
2704      +				format PDate mmddyy10.;
2705      +				PDate = .;
59                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2706      +				PEpisode=1;
2707      +				run;
2708      +         	%END;
2709      +      	%MEND WRAPPER;
2710      +      	%WRAPPER();
2711      +
2712      +		/*Creating Claims Dates Listing - One record per date per QueryGroup*/
2713      +		proc sort nodupkey data= _MasterQueryfile out=_Claims(keep=PatId Admit_Date Group);
2714      +		by PatId Admit_Date;
2715      +		where (Group in("&ITGROUP.") or IGroup in("&ITGROUP.","_ALLGROUPS_")) and (Query or Incid);
2716      +		run;
2717      +
2718      +		/*list for pre-cleaning*/
2719      +		proc sort nodupkey data=_Claims out=_ClaimList(keep=patid);
2720      +		by PatId;
2721      +		run;
2722      +
2723      +		/*Creating Dates*/
2724      +		data _AllMember;
2725      +		merge _MDenomInt(in=a) _ClaimList(in=b);  /*Sorted*/
2726      +		by PatId;
2727      +		if a;
2728      +		withclaims = 0;
2729      +		if a and b then withclaims=1;
2730      +		format QueryStartDate mmddyy10.;
2731      +
2732      +		/*Minimum date the patient can have an HOI*/
2733      +		QueryStartDate=Max(&QUERYFROM.,MinAgeDate,enr_start,PDate);
2734      +
2735      +		/*Enr_Start must be independent of MinAgeDate*/
2736      +		Enr_Start=Max(&QUERYFROM.-Max(&GROUPWASHOUT.,&GROUPENRDAYS.),enr_start,PDate-Max(&GROUPWASHOUT.,&GROUPENRDAYS.));
2737      +
2738      +		enr_end=min(&QUERYTO.,enr_end,MaxAgeDate);
2739      +		if enr_end >= enr_start;
2740      +
2741      +		keep PatId EligEpisode PEpisode birth_date sex MinAgeDate MaxAgeDate Enr_Start Enr_End
2742      +		     LastAgeGroup FirstAgeGroup PDate withclaims QueryStartDate QToAgeGroup Race Hispanic;
2743      +		run;
2744      +
2745      +		/*RECAP:
2746      +		    *Elig episodes now have been resized not to exceed this querygroup washout period
2747      +		       prior to the patients
2748      +		    *Starting to be at risk of having and event;
2749      +		    *adding birth_dates and sex to claims and keeping claims within eligibility*/
2750      +		Proc SQL Noprint;
2751      +			Create Table _Claims2 as
2752      +			Select Enrol.*,
2753      +		      	   claims.Admit_Date,
60                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2754      +		           claims.Group
2755      +		   	From _AllMember as Enrol,
2756      +		        _Claims as claims
2757      +		   	Where Enrol.withclaims=1 and Enrol.PatId=claims.PatId and Enrol.enr_Start <= claims.Admit_Date <= Enrol.enr_end
2758      +		   	order Patid, EligEpisode, PEpisode, Admit_Date; /*remove claims outside of period BEFORE AND AFTER*/
2759      +		quit;
2760      +
2761      +		/*Depile to create begin and end intervals (what if more than 1 enroll episode,
2762      +		        will have duplicate claim when incident respective to own, should be ok)*/
2763      +		data _DenomToLoop;
2764      +		set  _AllMember(in=a keep=Patid EligEpisode Pepisode Enr_Start Sex birth_date MinAgeDate MaxAgeDate QueryStartDate
2765      +		           				  FirstAgeGroup LastAgeGroup QToAgeGroup Race Hispanic rename=Enr_Start=Admit_Date)
2766      +		    _Claims2(keep=Patid EligEpisode Pepisode Admit_Date Sex birth_date MinAgeDate MaxAgeDate QueryStartDate FirstAgeGroup
2767      +		                  LastAgeGroup Group Enr_Start QToAgeGroup Race Hispanic)
2768      +		    _AllMember(in=b keep=Patid EligEpisode Pepisode Enr_End Sex birth_date MinAgeDate MaxAgeDate QueryStartDate
2769      +		           				 FirstAgeGroup LastAgeGroup Enr_Start QToAgeGroup Race Hispanic rename=Enr_End=Admit_Date);
2770      +		by Patid EligEpisode Pepisode Admit_Date;
2771      +
2772      +		if a then do;
2773      +			Group="BEGINELIG";
2774      +			Enr_Start=Admit_Date;
2775      +		end;
2776      +		if b then Group="ENDELIG";
2777      +		run;
2778      +
2779      +		/*Creating HOI Free episodes from gapless Enrolment sequences*/
2780      +		data _FindEpisodes;
2781      +		set _DenomToLoop;
2782      +		by PatId EligEpisode PEpisode;
2783      +
2784      +		/*compute length of HOI free period*/
2785      +		lAdmit_Date=lag(Admit_Date);
2786      +		lGroup=lag(Group);
2787      +		if first.PEpisode then do;
2788      +		  	lAdmit_Date=.;
2789      +		  	lGroup=.;
2790      +		end;
2791      +		if lAdmit_Date ne . then diff=Admit_Date-lAdmit_Date+1;
2792      +
2793      +		/*Compute StartDate and EndDate of  HOI free period*/
2794      +		format lAdmit_Date StartDate EndDate mmddyy10.;
2795      +		StartDate=lAdmit_Date+1-(lGroup eq "BEGINELIG");
2796      +		EndDate=Admit_Date;  /*Admit_Date can be either a QueryGroup Incid/HOI claim or the end of elig sequence*/
2797      +
2798      +		/*Minimum date the patient can have an HOI in this new broken down period*/
2799      +		QueryStartDate=Max(QueryStartDate,StartDate);
2800      +
2801      +		/*Patient must meet age criteria*/
61                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2802      +		if MinAgeDate <= EndDate and MaxAgeDate >= StartDate;
2803      +
2804      +		/*removes first record of episode*/
2805      +		if diff ne .;
2806      +
2807      +		/*Keeping episodes overlapping the Study Period - left truncated in the event of a INICD claim*/
2808      +		if EndDate >= &QUERYFROM. and StartDate <= &QUERYTO.;
2809      +
2810      +		if QueryStartDate <= EndDate;
2811      +
2812      +		/*Time increments*/
2813      +		FirstPer=intck("Months",&QUERYFROM.,QueryStartDate)+1;
2814      +		LastPer=intck("Months",&QUERYFROM.,EndDate)+1;
2815      +
2816      +		keep Patid birth_date sex StartDate QueryStartDate EndDate Enr_Start first: last: QToAgeGroup Race Hispanic;
2817      +
2818      +		/*RECALL:
2819      +		  *StartDate=Start Date of the HOI Free continuous elig period (can includes washout time
2820      +		      that may fall outside Study Period);
2821      +		  *QueryStartDate= Start Date of the HOI Free episode overlapping the Query Period
2822      +		      (for patient days calcs);
2823      +		  *EndDate=End Date of the HOI Free episode*/
2824      +
2825      +		run;
2826      +
2827      +		/*Determine the date at which the patient can no longer be eligible*/
2828      +		%MACRO WRAPPER;
2829      +			%IF %STR("&GROUPWASHTYP.")=%STR("SING") %THEN %DO;
2830      +				proc means noprint data = DMLocal.&REQUESTID.&RUNID._MasterTable nway;
2831      +				var Admit_Date;
2832      +				class PatId;
2833      +				where (Group in("&ITGROUP.")) and (Incident);
2834      +				output out=_TermDtTable(drop=_:) min=TermDt;
2835      +				run;
2836      +			%END;
2837      +			%ELSE %DO;
2838      +				proc means noprint data = _MasterQueryfile nway;
2839      +				var Admit_Date;
2840      +				class PatId;
2841      +				where (Group in("&ITGROUP.") or IGroup in("&ITGROUP.","_ALLGROUPS_")) and (Query or Incid);
2842      +				output out=_TermDtTable(drop=_:) min=TermDt;
2843      +				run;
2844      +			%END;
2845      +		%MEND WRAPPER;
2846      +		%WRAPPER;
2847      +
2848      +		/*Output for sex*/
2849      +		%if %index(&DENSTRAT.,'S') > 0 %then %do;
62                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2850      +			data _Patient_days_M _Patient_days_F _Patient_days_A _Patient_days_XX;
2851      +			merge _FindEpisodes(in=a) _TermDtTable;
2852      +			by Patid;
2853      +			if a;
2854      +			washtyp="&GROUPWASHTYP.";
2855      +			if upcase(sex)='M' then output _Patient_days_M;
2856      +			else if upcase(sex)='F' then output _Patient_days_F;
2857      +			else if upcase(sex)='A' then output _Patient_days_A;	
2858      +			else if upcase(sex)='XX' then output _Patient_days_XX;
2859      +			else do;
2860      +				Sex = "XX";
2861      +			   	output _Patient_days_XX;
2862      +			end;
2863      +			run;
2864      +		%end;
2865      +
2866      +		/*Output for hispanic*/
2867      +		%if %index(&DENSTRAT.,'H') > 0 %then %do;
2868      +			data _Patient_days_H_Y
2869      +			 _Patient_days_H_N
2870      +			 _Patient_days_H_R
2871      +			 _Patient_days_H_UN
2872      +			 _Patient_days_H_OT
2873      +			 _Patient_days_H_NI
2874      +			 _Patient_days_H_XX;
2875      +			merge _FindEpisodes(in=a) _TermDtTable;
2876      +			by Patid;
2877      +			if a;
2878      +			washtyp="&GROUPWASHTYP.";
2879      +			if upcase(Hispanic)='Y' then output _Patient_days_H_Y;
2880      +			else if upcase(Hispanic)='N' then output _Patient_days_H_N;
2881      +			else if upcase(Hispanic)='R' then output _Patient_days_H_R;
2882      +			else if upcase(Hispanic)='UN' then output _Patient_days_H_UN;
2883      +			else if upcase(Hispanic)='OT' then output _Patient_days_H_OT;
2884      +			else if upcase(Hispanic)='NI' then output _Patient_days_H_NI;
2885      +			else if upcase(Hispanic)='XX' then output _Patient_days_H_XX;
2886      +			else do;
2887      +				Hispanic = "XX";
2888      +			   	output _Patient_days_H_XX;
2889      +			end;
2890      +			run;
2891      +		%end;
2892      +
2893      +		/*Output for race*/
2894      +		%if %index(&DENSTRAT.,'R') > 0 %then %do;
2895      +			data _Patient_days_R_01
2896      +			 _Patient_days_R_02
2897      +			 _Patient_days_R_03
63                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2898      +			 _Patient_days_R_04
2899      +			 _Patient_days_R_05
2900      +			 _Patient_days_R_06
2901      +			 _Patient_days_R_07
2902      +			 _Patient_days_R_UN
2903      +			 _Patient_days_R_OT
2904      +			 _Patient_days_R_NI
2905      +			 _Patient_days_R_XX;
2906      +			merge _FindEpisodes(in=a) _TermDtTable;
2907      +			by Patid;
2908      +			if a;
2909      +			washtyp="&GROUPWASHTYP.";
2910      +			if Race in('1','01') then output _Patient_days_R_01;
2911      +			else if Race in('2','02') then output _Patient_days_R_02;
2912      +			else if Race in('3','03') then output _Patient_days_R_03;
2913      +			else if Race in('4','04') then output _Patient_days_R_04;
2914      +			else if Race in('5','05') then output _Patient_days_R_05;
2915      +			else if Race in('6','06') then output _Patient_days_R_06;
2916      +			else if Race in('7','07') then output _Patient_days_R_07;
2917      +			else if upcase(Race) in('UN') then output _Patient_days_R_UN;
2918      +			else if upcase(Race) in('OT') then output _Patient_days_R_OT;
2919      +			else if upcase(Race) in('NI') then output _Patient_days_R_NI;
2920      +			else if upcase(Race) in('XX') then output _Patient_days_R_XX;
2921      +			else do;
2922      +			   	Race = "XX";
2923      +			   	output _Patient_days_R_XX;
2924      +			end;
2925      +			run;
2926      +		%end;
2927      +
2928      +		/*Output for sex and race*/
2929      +		%if %index(&DENSTRAT.,'SR') > 0 %then %do;
2930      +			data
2931      +	   		 _Patient_days_S_M_R_01
2932      +			 _Patient_days_S_M_R_02
2933      +			 _Patient_days_S_M_R_03
2934      +			 _Patient_days_S_M_R_04
2935      +			 _Patient_days_S_M_R_05
2936      +			 _Patient_days_S_M_R_06
2937      +			 _Patient_days_S_M_R_07
2938      +			 _Patient_days_S_M_R_UN
2939      +			 _Patient_days_S_M_R_OT
2940      +			 _Patient_days_S_M_R_NI
2941      +			 _Patient_days_S_M_R_XX
2942      +
2943      +			 _Patient_days_S_F_R_01
2944      +			 _Patient_days_S_F_R_02
2945      +			 _Patient_days_S_F_R_03
64                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2946      +			 _Patient_days_S_F_R_04
2947      +			 _Patient_days_S_F_R_05
2948      +			 _Patient_days_S_F_R_06
2949      +			 _Patient_days_S_F_R_07
2950      +			 _Patient_days_S_F_R_UN
2951      +			 _Patient_days_S_F_R_OT
2952      +			 _Patient_days_S_F_R_NI
2953      +			 _Patient_days_S_F_R_XX
2954      +
2955      +			 _Patient_days_S_A_R_01
2956      +			 _Patient_days_S_A_R_02
2957      +			 _Patient_days_S_A_R_03
2958      +			 _Patient_days_S_A_R_04
2959      +			 _Patient_days_S_A_R_05
2960      +			 _Patient_days_S_A_R_06
2961      +			 _Patient_days_S_A_R_07
2962      +			 _Patient_days_S_A_R_UN
2963      +			 _Patient_days_S_A_R_OT
2964      +			 _Patient_days_S_A_R_NI
2965      +			 _Patient_days_S_A_R_XX
2966      +
2967      +			 _Patient_days_S_XX_R_01
2968      +			 _Patient_days_S_XX_R_02
2969      +			 _Patient_days_S_XX_R_03
2970      +			 _Patient_days_S_XX_R_04
2971      +			 _Patient_days_S_XX_R_05
2972      +			 _Patient_days_S_XX_R_06
2973      +			 _Patient_days_S_XX_R_07
2974      +			 _Patient_days_S_XX_R_UN
2975      +			 _Patient_days_S_XX_R_OT
2976      +			 _Patient_days_S_XX_R_NI
2977      +			 _Patient_days_S_XX_R_XX
2978      +			;
2979      +			merge _FindEpisodes(in=a) _TermDtTable;
2980      +			by Patid;
2981      +			if a;
2982      +			washtyp="&GROUPWASHTYP.";
2983      +			
2984      +			if upcase(sex)='M' then do;
2985      +				if Race in('1','01') then output _Patient_days_S_M_R_01;
2986      +				else if Race in('2','02') then output _Patient_days_S_M_R_02;
2987      +				else if Race in('3','03') then output _Patient_days_S_M_R_03;
2988      +				else if Race in('4','04') then output _Patient_days_S_M_R_04;
2989      +				else if Race in('5','05') then output _Patient_days_S_M_R_05;
2990      +				else if Race in('6','06') then output _Patient_days_S_M_R_06;
2991      +				else if Race in('7','07') then output _Patient_days_S_M_R_07;
2992      +				else if upcase(Race) in('UN') then output _Patient_days_S_M_R_UN;
2993      +				else if upcase(Race) in('OT') then output _Patient_days_S_M_R_OT;
65                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

2994      +				else if upcase(Race) in('NI') then output _Patient_days_S_M_R_NI;
2995      +				else if upcase(Race) in('XX') then output _Patient_days_S_M_R_XX;
2996      +				else do;
2997      +				   	Race = "XX";
2998      +				   	output _Patient_days_S_M_R_XX;
2999      +				end;
3000      +			end;
3001      +			else if upcase(sex)='F' then do;
3002      +				if Race in('1','01') then output _Patient_days_S_F_R_01;
3003      +				else if Race in('2','02') then output _Patient_days_S_F_R_02;
3004      +				else if Race in('3','03') then output _Patient_days_S_F_R_03;
3005      +				else if Race in('4','04') then output _Patient_days_S_F_R_04;
3006      +				else if Race in('5','05') then output _Patient_days_S_F_R_05;
3007      +				else if Race in('6','06') then output _Patient_days_S_F_R_06;
3008      +				else if Race in('7','07') then output _Patient_days_S_F_R_07;
3009      +				else if upcase(Race) in('UN') then output _Patient_days_S_F_R_UN;
3010      +				else if upcase(Race) in('OT') then output _Patient_days_S_F_R_OT;
3011      +				else if upcase(Race) in('NI') then output _Patient_days_S_F_R_NI;
3012      +				else if upcase(Race) in('XX') then output _Patient_days_S_F_R_XX;
3013      +				else do;
3014      +				   	Race = "XX";
3015      +				   	output _Patient_days_S_F_R_XX;
3016      +				end;
3017      +			end;
3018      +			else if upcase(sex)='A' then do;
3019      +				if Race in('1','01') then output _Patient_days_S_A_R_01;
3020      +				else if Race in('2','02') then output _Patient_days_S_A_R_02;
3021      +				else if Race in('3','03') then output _Patient_days_S_A_R_03;
3022      +				else if Race in('4','04') then output _Patient_days_S_A_R_04;
3023      +				else if Race in('5','05') then output _Patient_days_S_A_R_05;
3024      +				else if Race in('6','06') then output _Patient_days_S_A_R_06;
3025      +				else if Race in('7','07') then output _Patient_days_S_A_R_07;
3026      +				else if upcase(Race) in('UN') then output _Patient_days_S_A_R_UN;
3027      +				else if upcase(Race) in('OT') then output _Patient_days_S_A_R_OT;
3028      +				else if upcase(Race) in('NI') then output _Patient_days_S_A_R_NI;
3029      +				else if upcase(Race) in('XX') then output _Patient_days_S_A_R_XX;
3030      +				else do;
3031      +				   	Race = "XX";
3032      +				   	output _Patient_days_S_A_R_XX;
3033      +				end;
3034      +			end;
3035      +			else do;
3036      +				Sex = "XX";
3037      +				if Race in('1','01') then output _Patient_days_S_XX_R_01;
3038      +				else if Race in('2','02') then output _Patient_days_S_XX_R_02;
3039      +				else if Race in('3','03') then output _Patient_days_S_XX_R_03;
3040      +				else if Race in('4','04') then output _Patient_days_S_XX_R_04;
3041      +				else if Race in('5','05') then output _Patient_days_S_XX_R_05;
66                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3042      +				else if Race in('6','06') then output _Patient_days_S_XX_R_06;
3043      +				else if Race in('7','07') then output _Patient_days_S_XX_R_07;
3044      +				else if upcase(Race) in('UN') then output _Patient_days_S_XX_R_UN;
3045      +				else if upcase(Race) in('OT') then output _Patient_days_S_XX_R_OT;
3046      +				else if upcase(Race) in('NI') then output _Patient_days_S_XX_R_NI;
3047      +				else if upcase(Race) in('XX') then output _Patient_days_S_XX_R_XX;
3048      +				else do;
3049      +				   	Race = "XX";
3050      +				   	output _Patient_days_S_XX_R_XX;
3051      +				end;
3052      +			end;
3053      +			run;
3054      +		%end;
3055      +
3056      +		/*Output for sex and hispanic*/
3057      +		%if %index(&DENSTRAT.,'SH') > 0 %then %do;
3058      +			data
3059      +	   		 _Patient_days_S_M_H_Y
3060      +			 _Patient_days_S_M_H_N
3061      +			 _Patient_days_S_M_H_R
3062      +			 _Patient_days_S_M_H_UN
3063      +			 _Patient_days_S_M_H_OT
3064      +			 _Patient_days_S_M_H_NI
3065      +			 _Patient_days_S_M_H_XX
3066      +			
3067      +			 _Patient_days_S_F_H_Y
3068      +			 _Patient_days_S_F_H_N
3069      +			 _Patient_days_S_F_H_R
3070      +			 _Patient_days_S_F_H_UN
3071      +			 _Patient_days_S_F_H_OT
3072      +			 _Patient_days_S_F_H_NI
3073      +			 _Patient_days_S_F_H_XX
3074      +			
3075      +			 _Patient_days_S_A_H_Y
3076      +			 _Patient_days_S_A_H_N
3077      +			 _Patient_days_S_A_H_R
3078      +			 _Patient_days_S_A_H_UN
3079      +			 _Patient_days_S_A_H_OT
3080      +			 _Patient_days_S_A_H_NI
3081      +			 _Patient_days_S_A_H_XX
3082      +			
3083      +			 _Patient_days_S_XX_H_Y
3084      +			 _Patient_days_S_XX_H_N
3085      +			 _Patient_days_S_XX_H_R
3086      +			 _Patient_days_S_XX_H_UN
3087      +			 _Patient_days_S_XX_H_OT
3088      +			 _Patient_days_S_XX_H_NI
3089      +			 _Patient_days_S_XX_H_XX
67                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3090      +			;
3091      +			merge _FindEpisodes(in=a) _TermDtTable;
3092      +			by Patid;
3093      +			if a;
3094      +			washtyp="&GROUPWASHTYP.";
3095      +			
3096      +			if upcase(sex)='M' then do;
3097      +				if upcase(Hispanic)='Y' then output _Patient_days_S_M_H_Y;
3098      +				else if upcase(Hispanic)='N' then output _Patient_days_S_M_H_N;
3099      +				else if upcase(Hispanic)='R' then output _Patient_days_S_M_H_R;
3100      +				else if upcase(Hispanic)='UN' then output _Patient_days_S_M_H_UN;
3101      +				else if upcase(Hispanic)='OT' then output _Patient_days_S_M_H_OT;
3102      +				else if upcase(Hispanic)='NI' then output _Patient_days_S_M_H_NI;
3103      +				else if upcase(Hispanic)='XX' then output _Patient_days_S_M_H_XX;
3104      +				else do;
3105      +					Hispanic = "XX";
3106      +				   	output _Patient_days_S_M_H_XX;
3107      +				end;
3108      +			end;
3109      +			else if upcase(sex)='F' then do;
3110      +				if upcase(Hispanic)='Y' then output _Patient_days_S_F_H_Y;
3111      +				else if upcase(Hispanic)='N' then output _Patient_days_S_F_H_N;
3112      +				else if upcase(Hispanic)='R' then output _Patient_days_S_F_H_R;
3113      +				else if upcase(Hispanic)='UN' then output _Patient_days_S_F_H_UN;
3114      +				else if upcase(Hispanic)='OT' then output _Patient_days_S_F_H_OT;
3115      +				else if upcase(Hispanic)='NI' then output _Patient_days_S_F_H_NI;
3116      +				else if upcase(Hispanic)='XX' then output _Patient_days_S_F_H_XX;
3117      +				else do;
3118      +					Hispanic = "XX";
3119      +				   	output _Patient_days_S_F_H_XX;
3120      +				end;
3121      +			end;
3122      +			else if upcase(sex)='A' then do;
3123      +				if upcase(Hispanic)='Y' then output _Patient_days_S_A_H_Y;
3124      +				else if upcase(Hispanic)='N' then output _Patient_days_S_A_H_N;
3125      +				else if upcase(Hispanic)='R' then output _Patient_days_S_A_H_R;
3126      +				else if upcase(Hispanic)='UN' then output _Patient_days_S_A_H_UN;
3127      +				else if upcase(Hispanic)='OT' then output _Patient_days_S_A_H_OT;
3128      +				else if upcase(Hispanic)='NI' then output _Patient_days_S_A_H_NI;
3129      +				else if upcase(Hispanic)='XX' then output _Patient_days_S_A_H_XX;
3130      +				else do;
3131      +					Hispanic = "XX";
3132      +				   	output _Patient_days_S_A_H_XX;
3133      +				end;
3134      +			end;
3135      +			else do;
3136      +				Sex = "XX";
3137      +				if upcase(Hispanic)='Y' then output _Patient_days_S_XX_H_Y;
68                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3138      +				else if upcase(Hispanic)='N' then output _Patient_days_S_XX_H_N;
3139      +				else if upcase(Hispanic)='R' then output _Patient_days_S_XX_H_R;
3140      +				else if upcase(Hispanic)='UN' then output _Patient_days_S_XX_H_UN;
3141      +				else if upcase(Hispanic)='OT' then output _Patient_days_S_XX_H_OT;
3142      +				else if upcase(Hispanic)='NI' then output _Patient_days_S_XX_H_NI;
3143      +				else if upcase(Hispanic)='XX' then output _Patient_days_S_XX_H_XX;
3144      +				else do;
3145      +					Hispanic = "XX";
3146      +				   	output _Patient_days_S_XX_H_XX;
3147      +				end;
3148      +			end;
3149      +			run;
3150      +		%end;
3151      +
3152      +		/*Output for hispanic and race*/
3153      +		%if %index(&DENSTRAT.,'HR') > 0 %then %do;
3154      +			data
3155      +	   		 _Patient_days_H_Y_R_01
3156      +			 _Patient_days_H_Y_R_02
3157      +			 _Patient_days_H_Y_R_03
3158      +			 _Patient_days_H_Y_R_04
3159      +			 _Patient_days_H_Y_R_05
3160      +			 _Patient_days_H_Y_R_06
3161      +			 _Patient_days_H_Y_R_07
3162      +			 _Patient_days_H_Y_R_UN
3163      +			 _Patient_days_H_Y_R_OT
3164      +			 _Patient_days_H_Y_R_NI
3165      +			 _Patient_days_H_Y_R_XX
3166      +
3167      +			 _Patient_days_H_N_R_01
3168      +			 _Patient_days_H_N_R_02
3169      +			 _Patient_days_H_N_R_03
3170      +			 _Patient_days_H_N_R_04
3171      +			 _Patient_days_H_N_R_05
3172      +			 _Patient_days_H_N_R_06
3173      +			 _Patient_days_H_N_R_07
3174      +			 _Patient_days_H_N_R_UN
3175      +			 _Patient_days_H_N_R_OT
3176      +			 _Patient_days_H_N_R_NI
3177      +			 _Patient_days_H_N_R_XX
3178      +
3179      +			 _Patient_days_H_R_R_01
3180      +			 _Patient_days_H_R_R_02
3181      +			 _Patient_days_H_R_R_03
3182      +			 _Patient_days_H_R_R_04
3183      +			 _Patient_days_H_R_R_05
3184      +			 _Patient_days_H_R_R_06
3185      +			 _Patient_days_H_R_R_07
69                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3186      +			 _Patient_days_H_R_R_UN
3187      +			 _Patient_days_H_R_R_OT
3188      +			 _Patient_days_H_R_R_NI
3189      +			 _Patient_days_H_R_R_XX
3190      +
3191      +			 _Patient_days_H_UN_R_01
3192      +			 _Patient_days_H_UN_R_02
3193      +			 _Patient_days_H_UN_R_03
3194      +			 _Patient_days_H_UN_R_04
3195      +			 _Patient_days_H_UN_R_05
3196      +			 _Patient_days_H_UN_R_06
3197      +			 _Patient_days_H_UN_R_07
3198      +			 _Patient_days_H_UN_R_UN
3199      +			 _Patient_days_H_UN_R_OT
3200      +			 _Patient_days_H_UN_R_NI
3201      +			 _Patient_days_H_UN_R_XX
3202      +
3203      +			 _Patient_days_H_OT_R_01
3204      +			 _Patient_days_H_OT_R_02
3205      +			 _Patient_days_H_OT_R_03
3206      +			 _Patient_days_H_OT_R_04
3207      +			 _Patient_days_H_OT_R_05
3208      +			 _Patient_days_H_OT_R_06
3209      +			 _Patient_days_H_OT_R_07
3210      +			 _Patient_days_H_OT_R_UN
3211      +			 _Patient_days_H_OT_R_OT
3212      +			 _Patient_days_H_OT_R_NI
3213      +			 _Patient_days_H_OT_R_XX
3214      +
3215      +			 _Patient_days_H_NI_R_01
3216      +			 _Patient_days_H_NI_R_02
3217      +			 _Patient_days_H_NI_R_03
3218      +			 _Patient_days_H_NI_R_04
3219      +			 _Patient_days_H_NI_R_05
3220      +			 _Patient_days_H_NI_R_06
3221      +			 _Patient_days_H_NI_R_07
3222      +			 _Patient_days_H_NI_R_UN
3223      +			 _Patient_days_H_NI_R_OT
3224      +			 _Patient_days_H_NI_R_NI
3225      +			 _Patient_days_H_NI_R_XX
3226      +
3227      +			 _Patient_days_H_XX_R_01
3228      +			 _Patient_days_H_XX_R_02
3229      +			 _Patient_days_H_XX_R_03
3230      +			 _Patient_days_H_XX_R_04
3231      +			 _Patient_days_H_XX_R_05
3232      +			 _Patient_days_H_XX_R_06
3233      +			 _Patient_days_H_XX_R_07
70                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3234      +			 _Patient_days_H_XX_R_UN
3235      +			 _Patient_days_H_XX_R_OT
3236      +			 _Patient_days_H_XX_R_NI
3237      +			 _Patient_days_H_XX_R_XX
3238      +			;
3239      +			merge _FindEpisodes(in=a) _TermDtTable;
3240      +			by Patid;
3241      +			if a;
3242      +			washtyp="&GROUPWASHTYP.";
3243      +			
3244      +			if upcase(hispanic)='Y' then do;
3245      +				if Race in('1','01') then output _Patient_days_H_Y_R_01;
3246      +				else if Race in('2','02') then output _Patient_days_H_Y_R_02;
3247      +				else if Race in('3','03') then output _Patient_days_H_Y_R_03;
3248      +				else if Race in('4','04') then output _Patient_days_H_Y_R_04;
3249      +				else if Race in('5','05') then output _Patient_days_H_Y_R_05;
3250      +				else if Race in('6','06') then output _Patient_days_H_Y_R_06;
3251      +				else if Race in('7','07') then output _Patient_days_H_Y_R_07;
3252      +				else if upcase(Race) in('UN') then output _Patient_days_H_Y_R_UN;
3253      +				else if upcase(Race) in('OT') then output _Patient_days_H_Y_R_OT;
3254      +				else if upcase(Race) in('NI') then output _Patient_days_H_Y_R_NI;
3255      +				else if upcase(Race) in('XX') then output _Patient_days_H_Y_R_XX;
3256      +				else do;
3257      +				   	Race = "XX";
3258      +				   	output _Patient_days_H_Y_R_XX;
3259      +				end;
3260      +			end;
3261      +			else if upcase(hispanic)='N' then do;
3262      +				if Race in('1','01') then output _Patient_days_H_N_R_01;
3263      +				else if Race in('2','02') then output _Patient_days_H_N_R_02;
3264      +				else if Race in('3','03') then output _Patient_days_H_N_R_03;
3265      +				else if Race in('4','04') then output _Patient_days_H_N_R_04;
3266      +				else if Race in('5','05') then output _Patient_days_H_N_R_05;
3267      +				else if Race in('6','06') then output _Patient_days_H_N_R_06;
3268      +				else if Race in('7','07') then output _Patient_days_H_N_R_07;
3269      +				else if upcase(Race) in('UN') then output _Patient_days_H_N_R_UN;
3270      +				else if upcase(Race) in('OT') then output _Patient_days_H_N_R_OT;
3271      +				else if upcase(Race) in('NI') then output _Patient_days_H_N_R_NI;
3272      +				else if upcase(Race) in('XX') then output _Patient_days_H_N_R_XX;
3273      +				else do;
3274      +				   	Race = "XX";
3275      +				   	output _Patient_days_H_N_R_XX;
3276      +				end;
3277      +			end;
3278      +			else if upcase(hispanic)='R' then do;
3279      +				if Race in('1','01') then output _Patient_days_H_R_R_01;
3280      +				else if Race in('2','02') then output _Patient_days_H_R_R_02;
3281      +				else if Race in('3','03') then output _Patient_days_H_R_R_03;
71                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3282      +				else if Race in('4','04') then output _Patient_days_H_R_R_04;
3283      +				else if Race in('5','05') then output _Patient_days_H_R_R_05;
3284      +				else if Race in('6','06') then output _Patient_days_H_R_R_06;
3285      +				else if Race in('7','07') then output _Patient_days_H_R_R_07;
3286      +				else if upcase(Race) in('UN') then output _Patient_days_H_R_R_UN;
3287      +				else if upcase(Race) in('OT') then output _Patient_days_H_R_R_OT;
3288      +				else if upcase(Race) in('NI') then output _Patient_days_H_R_R_NI;
3289      +				else if upcase(Race) in('XX') then output _Patient_days_H_R_R_XX;
3290      +				else do;
3291      +				   	Race = "XX";
3292      +				   	output _Patient_days_H_R_R_XX;
3293      +				end;
3294      +			end;
3295      +			else if upcase(hispanic)='UN' then do;
3296      +				if Race in('1','01') then output _Patient_days_H_UN_R_01;
3297      +				else if Race in('2','02') then output _Patient_days_H_UN_R_02;
3298      +				else if Race in('3','03') then output _Patient_days_H_UN_R_03;
3299      +				else if Race in('4','04') then output _Patient_days_H_UN_R_04;
3300      +				else if Race in('5','05') then output _Patient_days_H_UN_R_05;
3301      +				else if Race in('6','06') then output _Patient_days_H_UN_R_06;
3302      +				else if Race in('7','07') then output _Patient_days_H_UN_R_07;
3303      +				else if upcase(Race) in('UN') then output _Patient_days_H_UN_R_UN;
3304      +				else if upcase(Race) in('OT') then output _Patient_days_H_UN_R_OT;
3305      +				else if upcase(Race) in('NI') then output _Patient_days_H_UN_R_NI;
3306      +				else if upcase(Race) in('XX') then output _Patient_days_H_UN_R_XX;
3307      +				else do;
3308      +				   	Race = "XX";
3309      +				   	output _Patient_days_H_UN_R_XX;
3310      +				end;
3311      +			end;
3312      +			else if upcase(hispanic)='OT' then do;
3313      +				if Race in('1','01') then output _Patient_days_H_OT_R_01;
3314      +				else if Race in('2','02') then output _Patient_days_H_OT_R_02;
3315      +				else if Race in('3','03') then output _Patient_days_H_OT_R_03;
3316      +				else if Race in('4','04') then output _Patient_days_H_OT_R_04;
3317      +				else if Race in('5','05') then output _Patient_days_H_OT_R_05;
3318      +				else if Race in('6','06') then output _Patient_days_H_OT_R_06;
3319      +				else if Race in('7','07') then output _Patient_days_H_OT_R_07;
3320      +				else if upcase(Race) in('UN') then output _Patient_days_H_OT_R_UN;
3321      +				else if upcase(Race) in('OT') then output _Patient_days_H_OT_R_OT;
3322      +				else if upcase(Race) in('NI') then output _Patient_days_H_OT_R_NI;
3323      +				else if upcase(Race) in('XX') then output _Patient_days_H_OT_R_XX;
3324      +				else do;
3325      +				   	Race = "XX";
3326      +				   	output _Patient_days_H_OT_R_XX;
3327      +				end;
3328      +			end;
3329      +			else if upcase(hispanic)='NI' then do;
72                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3330      +				if Race in('1','01') then output _Patient_days_H_NI_R_01;
3331      +				else if Race in('2','02') then output _Patient_days_H_NI_R_02;
3332      +				else if Race in('3','03') then output _Patient_days_H_NI_R_03;
3333      +				else if Race in('4','04') then output _Patient_days_H_NI_R_04;
3334      +				else if Race in('5','05') then output _Patient_days_H_NI_R_05;
3335      +				else if Race in('6','06') then output _Patient_days_H_NI_R_06;
3336      +				else if Race in('7','07') then output _Patient_days_H_NI_R_07;
3337      +				else if upcase(Race) in('UN') then output _Patient_days_H_NI_R_UN;
3338      +				else if upcase(Race) in('OT') then output _Patient_days_H_NI_R_OT;
3339      +				else if upcase(Race) in('NI') then output _Patient_days_H_NI_R_NI;
3340      +				else if upcase(Race) in('XX') then output _Patient_days_H_NI_R_XX;
3341      +				else do;
3342      +				   	Race = "XX";
3343      +				   	output _Patient_days_H_NI_R_XX;
3344      +				end;
3345      +			end;
3346      +			else do;
3347      +				hispanic = "XX";
3348      +				if Race in('1','01') then output _Patient_days_H_XX_R_01;
3349      +				else if Race in('2','02') then output _Patient_days_H_XX_R_02;
3350      +				else if Race in('3','03') then output _Patient_days_H_XX_R_03;
3351      +				else if Race in('4','04') then output _Patient_days_H_XX_R_04;
3352      +				else if Race in('5','05') then output _Patient_days_H_XX_R_05;
3353      +				else if Race in('6','06') then output _Patient_days_H_XX_R_06;
3354      +				else if Race in('7','07') then output _Patient_days_H_XX_R_07;
3355      +				else if upcase(Race) in('UN') then output _Patient_days_H_XX_R_UN;
3356      +				else if upcase(Race) in('OT') then output _Patient_days_H_XX_R_OT;
3357      +				else if upcase(Race) in('NI') then output _Patient_days_H_XX_R_NI;
3358      +				else if upcase(Race) in('XX') then output _Patient_days_H_XX_R_XX;
3359      +				else do;
3360      +				   	Race = "XX";
3361      +				   	output _Patient_days_H_XX_R_XX;
3362      +				end;
3363      +			end;
3364      +			run;
3365      +		%end;
3366      +
3367      +		%MACRO ACCUMDENOM(suf=);
3368      +
3369      +			/*Here we will accumulate patients and patient-days to obtain up to 3 records at the end
3370      +			  which will constitute the denominators for the modular program*/
3371      +			data _Patient_days_&suf. (keep=PatId birth_date Sex Hispanic Race StartDate EndDate QueryStartDate Prev: Inc:)
3372      +				 _Patient_days_&suf._list (keep=PatId incident);
3373      +			set _Patient_days_&suf. end=eof;
3374      +			by Patid;
3375      +
3376      +/*---------------------------------------------------------------------------------------------------*/
3377      +/* - - - NAMING CONVENTION OF ARRAYS:                                                                */
73                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3378      +/*              prefix _ means temporary vector                                                      */
3379      +/*              prefix Inc = incident                                                                */
3380      +/*              prefix Prev = prevalence                                                             */
3381      +/*                                                                                                   */
3382      +/*              Suffix AG  = Age group stratification                                                */
3383      +/*              Suffix Per = period stratification (e.g., weekly, monthly, quarterly)                */
3384      +/*              Suffix Y = year stratification                                                       */
3385      +/*                                                                                                   */
3386      +/*              When "Days" is not included in name = we`re counting "members"                       */
3387      +/*              When "Days" is included in name = we`re counting "members-days";                     */
3388      +/*---------------------------------------------------------------------------------------------------*/
3389      +
3390      +			/*Age Groups*/
3391      +			array _IncAg(*) _IncAg1-_IncAg&NUMAGECAT. ;
3392      +			array _PrevAg(*) _PrevAg1-_PrevAg&NUMAGECAT.;
3393      +
3394      +			array PrevAg(*) PrevAg1-PrevAg&NUMAGECAT.;
3395      +			array PrevDaysAg(*) PrevDaysAg1-PrevDaysAg&NUMAGECAT.;
3396      +
3397      +			array IncAg(*) IncAg1-IncAg&NUMAGECAT.;
3398      +			array IncDaysAg(*) IncDaysAg1-IncDaysAg&NUMAGECAT.;
3399      +
3400      +			/*Periodicity*/
3401      +			array _PrevPer(*) _PrevPer1-_PrevPer&NUMPER.;
3402      +			array _IncPer(*) _IncPer1-_IncPer&NUMPER. ;
3403      +
3404      +			array PrevPer(*) PrevPer1-PrevPer&NUMPER.;
3405      +			array PrevDaysPer(*) PrevDaysPer1-PrevDaysPer&NUMPER.;
3406      +
3407      +			array IncPer(*) IncPer1-IncPer&NUMPER.;
3408      +			array IncDaysPer(*) IncDaysPer1-IncDaysPer&NUMPER.;
3409      +
3410      +			/*Year*/
3411      +			array _PrevY(*) _PrevY&FROMY.-_PrevY&TOY. ;
3412      +			array _IncY(*) _IncY&FROMY.-_IncY&TOY. ;
3413      +
3414      +			array PrevY(*) PrevY&FROMY.-PrevY&TOY.;
3415      +			array PrevDaysY(*) PrevDaysY&FROMY.-PrevDaysY&TOY.;
3416      +
3417      +			array IncY(*) IncY&FROMY.-IncY&TOY.;
3418      +			array IncDaysY(*) IncDaysY&FROMY.-IncDaysY&TOY.;
3419      +
3420      +			if first.patid then do;
3421      +				call missing(of _Inc:);
3422      +			  	call missing(of _Prev:);
3423      +				incident=0;
3424      +			end;
3425      +
74                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3426      +			do i=FirstAgeGroup to LastAgeGroup;
3427      +				format StartAgeDate EndAgeDate mmddyy10. ;
3428      +
3429      +				/*Compute Strata Start/End date*/
3430      +				StartAgeDate=intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday');
3431      +				if i<&NUMAGECAT. then
3432      +				 	EndAgeDate=intnx(scan("&AGETYP.",i+1),birth_date,scan("&AGETHRESH.",i+1),'sameday') - 1;
3433      +				else if &MAXAGE.=99999 then EndAgeDate=intnx("years",birth_date,110,'sameday');
3434      +				else EndAgeDate=intnx(scan("&AGETYP.",&NUMAGECAT.),birth_date,&MAXAGE.+1,'sameday')-1;
3435      +				
3436      +				if EndDate<StartAgeDate then leave;  /*this agecat outside this cont Elig*/
3437      +
3438      +				if QueryStartDate<=EndAgeDate then do;
3439      +
3440      +				 	/*Prevalence*/
3441      +				 	NumDays=min(EndAgeDate,EndDate)-max(QueryStartDate,StartAgeDate)+1;
3442      +					
3443      +					%if %UPCASE("&AGECALC.") eq %STR("I") %then %do;
3444      +				 		_PrevAg(i)=1;
3445      +				 		PrevDaysAg(i)=sum(NumDays,PrevDaysAg(i));
3446      +					%end;
3447      +					%if %UPCASE("&AGECALC.") eq %STR("F") %then %do;
3448      +				 		_PrevAg(QToAgeGroup)=1;
3449      +				 		PrevDaysAg(QToAgeGroup)=sum(NumDays,PrevDaysAg(QToAgeGroup));
3450      +					%end;
3451      +
3452      +				 	/*Incidence*/
3453      +				 	NumWashOutDays=min(EndAgeDate,EndDate)-StartDate;
3454      +				 	NumEnrDays=min(EndAgeDate,EndDate)-Enr_Start;
3455      +				 	if NumWashOutDays >= &GROUPWASHOUT. and NumEnrDays >= &GROUPENRDAYS. then do;
3456      +				    	if WashTyp in('MULT') then do;
3457      +							%if %UPCASE("&AGECALC.") eq %STR("I") %then %do;
3458      +				       			_IncAg(i)=1;
3459      +								incident=1;
3460      +				       			IncDaysag(i)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysAg(i));
3461      +							%end;
3462      +							%if %UPCASE("&AGECALC.") eq %STR("F") %then %do;
3463      +				       			_IncAg(QToAgeGroup)=1;
3464      +								incident=1;
3465      +				       			IncDaysag(QToAgeGroup)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysAg(QToAgeGroup))
3465     !+;
3466      +							%end;
3467      +				    	end;
3468      +				   		else if TermDt eq . or (TermDt ne . and StartDate<=TermDt) then do;  /*WashTyp='Min' or 'Sing'*/
3469      +							%if %UPCASE("&AGECALC.") eq %STR("I") %then %do;
3470      +					       		_IncAg(i)=1;
3471      +								incident=1;
3472      +					       		IncDaysag(i)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysAg(i));
75                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3473      +							%end;
3474      +							%if %UPCASE("&AGECALC.") eq %STR("F") %then %do;
3475      +					       		_IncAg(QToAgeGroup)=1;
3476      +								incident=1;
3477      +					       		IncDaysag(QToAgeGroup)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysAg(QToAgeGroup))
3477     !+;
3478      +							%end;
3479      +				    	end;
3480      +				 	end;
3481      +				end;
3482      +			end;
3483      +
3484      +			do i=FirstPer to LastPer;
3485      +				format StartPerDate EndPerDate mmddyy10.;
3486      +
3487      +				/*Here the use of the modulo operator has been chosen to avoid having to call
3488      +				the intnx() function to
3489      +				track year change as it was too much time consuming when this was tested in a synthetic
3490      +				real-life size problem*/
3491      +
3492      +				/*Year*/
3493      +				if mod(i,12)=&YEARCHANGE. or  i=FirstPer then do;
3494      +					year=int(&FROMY.+(i+&FORMOD.)/12);
3495      +					j=year-&FROMY.+1;
3496      +
3497      +					/*Prevalence*/
3498      +					_PrevY(j)=1;
3499      +					/*number of query days overlapping this year*/
3500      +					NumDays= min(mdy(12,31,year),EndDate)-max(QueryStartDate,mdy(1,1,year))+1;
3501      +					PrevDaysY(j) = sum(NumDays,PrevDaysY(j));
3502      +
3503      +					/*Incidence*/
3504      +					NumWashOutDays=min(mdy(12,31,year),EndDate)-StartDate;
3505      +					NumEnrDays=min(mdy(12,31,year),EndDate)-Enr_Start;
3506      +					if NumWashOutDays >= &GROUPWASHOUT. and NumEnrDays >= &GROUPENRDAYS. then do;
3507      +						if WashTyp in('MULT') then do;
3508      +						   	_IncY(j)=1;
3509      +							incident=1;
3510      +						   	IncDaysY(j)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysY(j));
3511      +						end;
3512      +						else if TermDt eq . or (TermDt ne . and StartDate<=TermDt) then do;  /*WashTyp='Min' or 'Sing'*/
3513      +						   	_IncY(j)=1;
3514      +							incident=1;
3515      +						   	IncDaysY(j)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysY(j));
3516      +						end;
3517      +					end;
3518      +			 	end;
3519      +
76                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3520      +				/*Year/Month*/
3521      +				/*Compute Strata Start/End date*/
3522      +				if i=FirstPer then StartPerdate=mdy(mod(i+&FORMOD.,12)+1,1,int(&FROMY.+(i+&FORMOD.)/12));
3523      +				else StartPerdate=EndPerDate+1;
3524      +				EndPerdate=mdy(mod(i+&FORMOD.+1,12)+1,1,int(&FROMY.+(i+&FORMOD.+1)/12))-1;
3525      +
3526      +				if EndDate<StartPerDate then leave;
3527      +
3528      +				/*Is there an overlap with this strata?*/
3529      +				if QueryStartDate<=EndPerDate then do;
3530      +
3531      +				 	/*Prevalence*/
3532      +				 	_PrevPer(i)=1;
3533      +				 	NumDays=min(EndPerDate,EndDate)-max(QueryStartDate,StartPerDate)+1;
3534      +				 	PrevDaysPer(i)=sum(NumDays,PrevDaysPer(i));
3535      +
3536      +				 	/*Incidence*/
3537      +				 	NumWashOutDays=min(EndPerDate,EndDate)-StartDate;
3538      +				 	NumEnrDays=min(EndPerDate,EndDate)-Enr_Start;
3539      +				 	if NumWashOutDays >= &GROUPWASHOUT. and NumEnrDays >= &GROUPENRDAYS. then do;
3540      +				    	if WashTyp in('MULT') then do;
3541      +				       		_IncPer(i)=1;
3542      +							incident=1;
3543      +				       		IncDaysPer(i)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysPer(i));
3544      +				    	end;
3545      +					    else if TermDt eq . or (TermDt ne . and StartDate<=TermDt) then do;  /*WashTyp='Min' or 'Sing'*/
3546      +					    	_IncPer(i)=1;
3547      +							incident=1;
3548      +					       	IncDaysPer(i)=sum(min(NumWashOutDays-&GROUPWASHOUT. +1,NumDays,NumEnrDays-&GROUPENRDAYS. +1),IncDaysPer(i));
3549      +					    end;
3550      +					end;			
3551      +				end;
3552      +			end;
3553      +			
3554      +			if last.patid then do;
3555      +			  	PrevALL=sum(PrevALL,max(of _PrevY:,.));
3556      +			  	IncALL=sum(IncALL,max(of _IncY:,.));
3557      +
3558      +			  	do i=FirstAgeGroup to LastAgeGroup;
3559      +			     	PrevAg(i)=sum(PrevAg(i),_PrevAg(i));
3560      +			     	IncAg(i)=sum(IncAg(i),_IncAg(i));
3561      +					*If enrollment based on encounter, override days with counts;
3562      +					%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2") %then %do;
3563      +       					PrevDaysAg(i)=PrevAg(i);
3564      +			     		IncDaysAg(i)=IncAg(i);
3565      +					%end;
3566      +			  	end;
3567      +			  	do i = 1 to &NUMYEARS.;
77                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3568      +			     	PrevY(i)=sum(PrevY(i),_PrevY(i));
3569      +			     	IncY(i)=sum(IncY(i),_IncY(i));
3570      +					*If enrollment based on encounter, override days with counts;
3571      +					%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3572      +       					PrevDaysY(i)=PrevY(i);
3573      +			     		IncDaysY(i)=IncY(i);
3574      +					%end;
3575      +			  	end;
3576      +			  	do i = 1 to &NUMPER.;
3577      +			     	PrevPer(i)=sum(PrevPer(i),_PrevPer(i));
3578      +			     	IncPer(i)=sum(IncPer(i),_IncPer(i));
3579      +					*If enrollment based on encounter, override days with counts;
3580      +					%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3581      +       					PrevDaysPer(i)=PrevPer(i);
3582      +			     		IncDaysPer(i)=IncPer(i);
3583      +					%end;
3584      +			  	end;
3585      +			end;
3586      +
3587      +			if eof then output _Patient_days_&suf.;
3588      +			output _Patient_days_&suf._list;
3589      +
3590      +			retain _Inc: _Prev:  Inc: Prev:;			
3591      +			run;
3592      +      	%MEND ACCUMDENOM;
3593      +		%if %index(&DENSTRAT.,'S') > 0 %then %do;
3594      +			%ACCUMDENOM(suf=M);
3595      +			%ACCUMDENOM(suf=F);
3596      +			%ACCUMDENOM(suf=A);
3597      +			%ACCUMDENOM(suf=XX);
3598      +		%end;
3599      +
3600      +		%if %index(&DENSTRAT.,'H') > 0 %then %do;
3601      +			%ACCUMDENOM(suf=H_Y);
3602      +			%ACCUMDENOM(suf=H_N);
3603      +			%ACCUMDENOM(suf=H_R);
3604      +			%ACCUMDENOM(suf=H_UN);
3605      +			%ACCUMDENOM(suf=H_OT);
3606      +			%ACCUMDENOM(suf=H_NI);
3607      +			%ACCUMDENOM(suf=H_XX);
3608      +		%end;
3609      +
3610      +		%if %index(&DENSTRAT.,'R') > 0 %then %do;
3611      +			%ACCUMDENOM(suf=R_01);
3612      +			%ACCUMDENOM(suf=R_02);
3613      +			%ACCUMDENOM(suf=R_03);
3614      +			%ACCUMDENOM(suf=R_04);
3615      +			%ACCUMDENOM(suf=R_05);
78                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3616      +			%ACCUMDENOM(suf=R_06);
3617      +			%ACCUMDENOM(suf=R_07);
3618      +			%ACCUMDENOM(suf=R_UN);
3619      +			%ACCUMDENOM(suf=R_OT);
3620      +			%ACCUMDENOM(suf=R_NI);
3621      +			%ACCUMDENOM(suf=R_XX);
3622      +		%end;
3623      +
3624      +		%if %index(&DENSTRAT.,'SR') > 0 %then %do;
3625      +			%ACCUMDENOM(suf=S_M_R_01);
3626      +			%ACCUMDENOM(suf=S_M_R_02);
3627      +			%ACCUMDENOM(suf=S_M_R_03);
3628      +			%ACCUMDENOM(suf=S_M_R_04);
3629      +			%ACCUMDENOM(suf=S_M_R_05);
3630      +			%ACCUMDENOM(suf=S_M_R_06);
3631      +			%ACCUMDENOM(suf=S_M_R_07);
3632      +			%ACCUMDENOM(suf=S_M_R_UN);
3633      +			%ACCUMDENOM(suf=S_M_R_OT);
3634      +			%ACCUMDENOM(suf=S_M_R_NI);
3635      +			%ACCUMDENOM(suf=S_M_R_XX);
3636      +			%ACCUMDENOM(suf=S_F_R_01);
3637      +			%ACCUMDENOM(suf=S_F_R_02);
3638      +			%ACCUMDENOM(suf=S_F_R_03);
3639      +			%ACCUMDENOM(suf=S_F_R_04);
3640      +			%ACCUMDENOM(suf=S_F_R_05);
3641      +			%ACCUMDENOM(suf=S_F_R_06);
3642      +			%ACCUMDENOM(suf=S_F_R_07);
3643      +			%ACCUMDENOM(suf=S_F_R_UN);
3644      +			%ACCUMDENOM(suf=S_F_R_OT);
3645      +			%ACCUMDENOM(suf=S_F_R_NI);
3646      +			%ACCUMDENOM(suf=S_F_R_XX);
3647      +			%ACCUMDENOM(suf=S_A_R_01);
3648      +			%ACCUMDENOM(suf=S_A_R_02);
3649      +			%ACCUMDENOM(suf=S_A_R_03);
3650      +			%ACCUMDENOM(suf=S_A_R_04);
3651      +			%ACCUMDENOM(suf=S_A_R_05);
3652      +			%ACCUMDENOM(suf=S_A_R_06);
3653      +			%ACCUMDENOM(suf=S_A_R_07);
3654      +			%ACCUMDENOM(suf=S_A_R_UN);
3655      +			%ACCUMDENOM(suf=S_A_R_OT);
3656      +			%ACCUMDENOM(suf=S_A_R_NI);
3657      +			%ACCUMDENOM(suf=S_A_R_XX);
3658      +			%ACCUMDENOM(suf=S_XX_R_01);
3659      +			%ACCUMDENOM(suf=S_XX_R_02);
3660      +			%ACCUMDENOM(suf=S_XX_R_03);
3661      +			%ACCUMDENOM(suf=S_XX_R_04);
3662      +			%ACCUMDENOM(suf=S_XX_R_05);
3663      +			%ACCUMDENOM(suf=S_XX_R_06);
79                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3664      +			%ACCUMDENOM(suf=S_XX_R_07);
3665      +			%ACCUMDENOM(suf=S_XX_R_UN);
3666      +			%ACCUMDENOM(suf=S_XX_R_OT);
3667      +			%ACCUMDENOM(suf=S_XX_R_NI);
3668      +			%ACCUMDENOM(suf=S_XX_R_XX);
3669      +		%end;
3670      +
3671      +		%if %index(&DENSTRAT.,'SH') > 0 %then %do;
3672      +			%ACCUMDENOM(suf=S_M_H_Y);
3673      +			%ACCUMDENOM(suf=S_M_H_N);
3674      +			%ACCUMDENOM(suf=S_M_H_R);
3675      +			%ACCUMDENOM(suf=S_M_H_UN);
3676      +			%ACCUMDENOM(suf=S_M_H_OT);
3677      +			%ACCUMDENOM(suf=S_M_H_NI);
3678      +			%ACCUMDENOM(suf=S_M_H_XX);
3679      +			%ACCUMDENOM(suf=S_F_H_Y);
3680      +			%ACCUMDENOM(suf=S_F_H_N);
3681      +			%ACCUMDENOM(suf=S_F_H_R);
3682      +			%ACCUMDENOM(suf=S_F_H_UN);
3683      +			%ACCUMDENOM(suf=S_F_H_OT);
3684      +			%ACCUMDENOM(suf=S_F_H_NI);
3685      +			%ACCUMDENOM(suf=S_F_H_XX);
3686      +			%ACCUMDENOM(suf=S_A_H_Y);
3687      +			%ACCUMDENOM(suf=S_A_H_N);
3688      +			%ACCUMDENOM(suf=S_A_H_R);
3689      +			%ACCUMDENOM(suf=S_A_H_UN);
3690      +			%ACCUMDENOM(suf=S_A_H_OT);
3691      +			%ACCUMDENOM(suf=S_A_H_NI);
3692      +			%ACCUMDENOM(suf=S_A_H_XX);
3693      +			%ACCUMDENOM(suf=S_XX_H_Y);
3694      +			%ACCUMDENOM(suf=S_XX_H_N);
3695      +			%ACCUMDENOM(suf=S_XX_H_R);
3696      +			%ACCUMDENOM(suf=S_XX_H_UN);
3697      +			%ACCUMDENOM(suf=S_XX_H_OT);
3698      +			%ACCUMDENOM(suf=S_XX_H_NI);
3699      +			%ACCUMDENOM(suf=S_XX_H_XX);
3700      +		%end;
3701      +
3702      +		%if %index(&DENSTRAT.,'HR') > 0 %then %do;
3703      +			%ACCUMDENOM(suf=H_Y_R_01);
3704      +			%ACCUMDENOM(suf=H_Y_R_02);
3705      +			%ACCUMDENOM(suf=H_Y_R_03);
3706      +			%ACCUMDENOM(suf=H_Y_R_04);
3707      +			%ACCUMDENOM(suf=H_Y_R_05);
3708      +			%ACCUMDENOM(suf=H_Y_R_06);
3709      +			%ACCUMDENOM(suf=H_Y_R_07);
3710      +			%ACCUMDENOM(suf=H_Y_R_UN);
3711      +			%ACCUMDENOM(suf=H_Y_R_OT);
80                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3712      +			%ACCUMDENOM(suf=H_Y_R_NI);
3713      +			%ACCUMDENOM(suf=H_Y_R_XX);
3714      +			%ACCUMDENOM(suf=H_N_R_01);
3715      +			%ACCUMDENOM(suf=H_N_R_02);
3716      +			%ACCUMDENOM(suf=H_N_R_03);
3717      +			%ACCUMDENOM(suf=H_N_R_04);
3718      +			%ACCUMDENOM(suf=H_N_R_05);
3719      +			%ACCUMDENOM(suf=H_N_R_06);
3720      +			%ACCUMDENOM(suf=H_N_R_07);
3721      +			%ACCUMDENOM(suf=H_N_R_UN);
3722      +			%ACCUMDENOM(suf=H_N_R_OT);
3723      +			%ACCUMDENOM(suf=H_N_R_NI);
3724      +			%ACCUMDENOM(suf=H_N_R_XX);
3725      +			%ACCUMDENOM(suf=H_R_R_01);
3726      +			%ACCUMDENOM(suf=H_R_R_02);
3727      +			%ACCUMDENOM(suf=H_R_R_03);
3728      +			%ACCUMDENOM(suf=H_R_R_04);
3729      +			%ACCUMDENOM(suf=H_R_R_05);
3730      +			%ACCUMDENOM(suf=H_R_R_06);
3731      +			%ACCUMDENOM(suf=H_R_R_07);
3732      +			%ACCUMDENOM(suf=H_R_R_UN);
3733      +			%ACCUMDENOM(suf=H_R_R_OT);
3734      +			%ACCUMDENOM(suf=H_R_R_NI);
3735      +			%ACCUMDENOM(suf=H_R_R_XX);
3736      +			%ACCUMDENOM(suf=H_UN_R_01);
3737      +			%ACCUMDENOM(suf=H_UN_R_02);
3738      +			%ACCUMDENOM(suf=H_UN_R_03);
3739      +			%ACCUMDENOM(suf=H_UN_R_04);
3740      +			%ACCUMDENOM(suf=H_UN_R_05);
3741      +			%ACCUMDENOM(suf=H_UN_R_06);
3742      +			%ACCUMDENOM(suf=H_UN_R_07);
3743      +			%ACCUMDENOM(suf=H_UN_R_UN);
3744      +			%ACCUMDENOM(suf=H_UN_R_OT);
3745      +			%ACCUMDENOM(suf=H_UN_R_NI);
3746      +			%ACCUMDENOM(suf=H_UN_R_XX);
3747      +			%ACCUMDENOM(suf=H_OT_R_01);
3748      +			%ACCUMDENOM(suf=H_OT_R_02);
3749      +			%ACCUMDENOM(suf=H_OT_R_03);
3750      +			%ACCUMDENOM(suf=H_OT_R_04);
3751      +			%ACCUMDENOM(suf=H_OT_R_05);
3752      +			%ACCUMDENOM(suf=H_OT_R_06);
3753      +			%ACCUMDENOM(suf=H_OT_R_07);
3754      +			%ACCUMDENOM(suf=H_OT_R_UN);
3755      +			%ACCUMDENOM(suf=H_OT_R_OT);
3756      +			%ACCUMDENOM(suf=H_OT_R_NI);
3757      +			%ACCUMDENOM(suf=H_OT_R_XX);
3758      +			%ACCUMDENOM(suf=H_NI_R_01);
3759      +			%ACCUMDENOM(suf=H_NI_R_02);
81                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3760      +			%ACCUMDENOM(suf=H_NI_R_03);
3761      +			%ACCUMDENOM(suf=H_NI_R_04);
3762      +			%ACCUMDENOM(suf=H_NI_R_05);
3763      +			%ACCUMDENOM(suf=H_NI_R_06);
3764      +			%ACCUMDENOM(suf=H_NI_R_07);
3765      +			%ACCUMDENOM(suf=H_NI_R_UN);
3766      +			%ACCUMDENOM(suf=H_NI_R_OT);
3767      +			%ACCUMDENOM(suf=H_NI_R_NI);
3768      +			%ACCUMDENOM(suf=H_NI_R_XX);
3769      +			%ACCUMDENOM(suf=H_XX_R_01);
3770      +			%ACCUMDENOM(suf=H_XX_R_02);
3771      +			%ACCUMDENOM(suf=H_XX_R_03);
3772      +			%ACCUMDENOM(suf=H_XX_R_04);
3773      +			%ACCUMDENOM(suf=H_XX_R_05);
3774      +			%ACCUMDENOM(suf=H_XX_R_06);
3775      +			%ACCUMDENOM(suf=H_XX_R_07);
3776      +			%ACCUMDENOM(suf=H_XX_R_UN);
3777      +			%ACCUMDENOM(suf=H_XX_R_OT);
3778      +			%ACCUMDENOM(suf=H_XX_R_NI);
3779      +			%ACCUMDENOM(suf=H_XX_R_XX);
3780      +		%end;
3781      +
3782      +		%MACRO SQUARE(Suf=,Var=,Val=);
3783      +		    proc contents data=_Patient_days_&suf. noprint out=_tilt_;
3784      +			data _null_;
3785      +			set _tilt_;
3786      +			call symputx('nobs',trim(left(put(nobs,15.))));
3787      +			run;
3788      +
3789      +			%put &pnobs.;
3790      +
3791      +			%IF %EVAL(&nobs.=0) %THEN %DO;
3792      +		        proc sql noprint;
3793      +		            insert into _Patient_days_&suf. (&Var.) values("&Val.");
3794      +				quit;
3795      +			%END;
3796      +		%MEND SQUARE;
3797      +
3798      +		%if %index(&DENSTRAT.,'S') > 0 %then %do;
3799      +			%SQUARE(suf=M,Var=Sex,Val=M);
3800      +			%SQUARE(suf=F,Var=Sex,Val=F);
3801      +			%SQUARE(suf=A,Var=Sex,Val=A);
3802      +			%SQUARE(suf=XX,Var=Sex,Val=XX);
3803      +		%end;
3804      +
3805      +		%if %index(&DENSTRAT.,'H') > 0 %then %do;
3806      +			%SQUARE(suf=H_Y,Var=Hispanic,Val=Y);
3807      +			%SQUARE(suf=H_N,Var=Hispanic,Val=N);
82                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3808      +			%SQUARE(suf=H_R,Var=Hispanic,Val=R);
3809      +			%SQUARE(suf=H_UN,Var=Hispanic,Val=UN);
3810      +			%SQUARE(suf=H_OT,Var=Hispanic,Val=OT);
3811      +			%SQUARE(suf=H_NI,Var=Hispanic,Val=NI);
3812      +			%SQUARE(suf=H_XX,Var=Hispanic,Val=XX);
3813      +		%end;
3814      +
3815      +		%if %index(&DENSTRAT.,'R') > 0 %then %do;
3816      +			%SQUARE(suf=R_01,Var=Race,Val=01);
3817      +			%SQUARE(suf=R_02,Var=Race,Val=02);
3818      +			%SQUARE(suf=R_03,Var=Race,Val=03);
3819      +			%SQUARE(suf=R_04,Var=Race,Val=04);
3820      +			%SQUARE(suf=R_05,Var=Race,Val=05);
3821      +			%SQUARE(suf=R_06,Var=Race,Val=06);
3822      +			%SQUARE(suf=R_07,Var=Race,Val=07);
3823      +			%SQUARE(suf=R_UN,Var=Race,Val=UN);
3824      +			%SQUARE(suf=R_OT,Var=Race,Val=OT);
3825      +			%SQUARE(suf=R_NI,Var=Race,Val=NI);
3826      +			%SQUARE(suf=R_XX,Var=Race,Val=XX);
3827      +		%end;
3828      +
3829      +		%if %index(&DENSTRAT.,'S') > 0 %then %do;
3830      +			data _MasterDenomTable_Sex;
3831      +			set _Patient_days_F
3832      +			    _Patient_days_M
3833      +				_Patient_days_A
3834      +				_Patient_days_XX;
3835      +
3836      +			PrevDaysALL=sum(of PrevDaysY:,.);
3837      +			IncDaysALL=sum(of IncDaysY:,.);
3838      +			*If enrollment based on encounter, override days with counts;
3839      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3840      +	       		PrevDaysALL=PrevALL;
3841      +				IncDaysALL=IncALL;
3842      +			%end;
3843      +
3844      +			keep sex prev: inc:;
3845      +			run;
3846      +
3847      +			proc sort data = _MasterDenomTable_Sex;
3848      +			by sex;
3849      +			run;
3850      +			proc transpose data = _MasterDenomTable_Sex
3851      +			               out = _MasterDenomTable_Sex(rename=(_NAME_ = Segment COL1=count));
3852      +			by sex;
3853      +			run;
3854      +			proc sort data = _MasterDenomTable_Sex;
3855      +			by Segment sex;
83                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3856      +			run;
3857      +		%end;
3858      +
3859      +		%if %index(&DENSTRAT.,'H') > 0 %then %do;
3860      +			data _MasterDenomTable_Hisp;
3861      +			set _Patient_days_H_Y
3862      +			   _Patient_days_H_N
3863      +			   _Patient_days_H_R
3864      +			   _Patient_days_H_UN
3865      +			   _Patient_days_H_OT
3866      +			   _Patient_days_H_NI
3867      +			   _Patient_days_H_XX;
3868      +
3869      +			PrevDaysALL=sum(of PrevDaysY:,.);
3870      +			IncDaysALL=sum(of IncDaysY:,.);
3871      +			*If enrollment based on encounter, override days with counts;
3872      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3873      +	       		PrevDaysALL=PrevALL;
3874      +				IncDaysALL=IncALL;
3875      +			%end;
3876      +
3877      +			keep Hispanic prev: inc:;
3878      +			run;
3879      +
3880      +			proc sort data = _MasterDenomTable_Hisp;
3881      +			by Hispanic;
3882      +			run;
3883      +			proc transpose data = _MasterDenomTable_Hisp
3884      +			               out = _MasterDenomTable_Hisp(rename=(_NAME_ = Segment COL1=count));
3885      +			by Hispanic;
3886      +			run;
3887      +			proc sort data = _MasterDenomTable_Hisp;
3888      +			by Segment Hispanic;
3889      +			run;
3890      +		%end;
3891      +
3892      +		%if %index(&DENSTRAT.,'R') > 0 %then %do;
3893      +			data _MasterDenomTable_Race;
3894      +			set _Patient_days_R_01
3895      +			   _Patient_days_R_02
3896      +			   _Patient_days_R_03
3897      +			   _Patient_days_R_04
3898      +			   _Patient_days_R_05
3899      +			   _Patient_days_R_06
3900      +			   _Patient_days_R_07
3901      +			   _Patient_days_R_UN
3902      +			   _Patient_days_R_OT
3903      +			   _Patient_days_R_NI
84                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3904      +			   _Patient_days_R_XX;
3905      +
3906      +			PrevDaysALL=sum(of PrevDaysY:,.);
3907      +			IncDaysALL=sum(of IncDaysY:,.);
3908      +			*If enrollment based on encounter, override days with counts;
3909      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3910      +	       		PrevDaysALL=PrevALL;
3911      +				IncDaysALL=IncALL;
3912      +			%end;
3913      +
3914      +			keep Race prev: inc:;
3915      +			run;
3916      +
3917      +			proc sort data = _MasterDenomTable_Race;
3918      +			by Race;
3919      +			run;
3920      +			proc transpose data = _MasterDenomTable_Race
3921      +			               out = _MasterDenomTable_Race(rename=(_NAME_ = Segment COL1=count));
3922      +			by Race;
3923      +			run;
3924      +			proc sort data = _MasterDenomTable_Race;
3925      +			by Segment Race;
3926      +			run;
3927      +		%end;
3928      +
3929      +		%if %index(&DENSTRAT.,'SR') > 0 %then %do;
3930      +			data _MasterDenomTable_Sex_Race;
3931      +			set _Patient_days_S_M_R_01
3932      +			 _Patient_days_S_M_R_02
3933      +			 _Patient_days_S_M_R_03
3934      +			 _Patient_days_S_M_R_04
3935      +			 _Patient_days_S_M_R_05
3936      +			 _Patient_days_S_M_R_06
3937      +			 _Patient_days_S_M_R_07
3938      +			 _Patient_days_S_M_R_UN
3939      +			 _Patient_days_S_M_R_OT
3940      +			 _Patient_days_S_M_R_NI
3941      +			 _Patient_days_S_M_R_XX
3942      +			 _Patient_days_S_F_R_01
3943      +			 _Patient_days_S_F_R_02
3944      +			 _Patient_days_S_F_R_03
3945      +			 _Patient_days_S_F_R_04
3946      +			 _Patient_days_S_F_R_05
3947      +			 _Patient_days_S_F_R_06
3948      +			 _Patient_days_S_F_R_07
3949      +			 _Patient_days_S_F_R_UN
3950      +			 _Patient_days_S_F_R_OT
3951      +			 _Patient_days_S_F_R_NI
85                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

3952      +			 _Patient_days_S_F_R_XX
3953      +			 _Patient_days_S_A_R_01
3954      +			 _Patient_days_S_A_R_02
3955      +			 _Patient_days_S_A_R_03
3956      +			 _Patient_days_S_A_R_04
3957      +			 _Patient_days_S_A_R_05
3958      +			 _Patient_days_S_A_R_06
3959      +			 _Patient_days_S_A_R_07
3960      +			 _Patient_days_S_A_R_UN
3961      +			 _Patient_days_S_A_R_OT
3962      +			 _Patient_days_S_A_R_NI
3963      +			 _Patient_days_S_A_R_XX
3964      +			 _Patient_days_S_XX_R_01
3965      +			 _Patient_days_S_XX_R_02
3966      +			 _Patient_days_S_XX_R_03
3967      +			 _Patient_days_S_XX_R_04
3968      +			 _Patient_days_S_XX_R_05
3969      +			 _Patient_days_S_XX_R_06
3970      +			 _Patient_days_S_XX_R_07
3971      +			 _Patient_days_S_XX_R_UN
3972      +			 _Patient_days_S_XX_R_OT
3973      +			 _Patient_days_S_XX_R_NI
3974      +			 _Patient_days_S_XX_R_XX;
3975      +
3976      +			PrevDaysALL=sum(of PrevDaysY:,.);
3977      +			IncDaysALL=sum(of IncDaysY:,.);
3978      +			*If enrollment based on encounter, override days with counts;
3979      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
3980      +	       		PrevDaysALL=PrevALL;
3981      +				IncDaysALL=IncALL;
3982      +			%end;
3983      +
3984      +			keep Sex Race prev: inc:;
3985      +			run;
3986      +
3987      +			proc sort data = _MasterDenomTable_Sex_Race;
3988      +			by sex race;
3989      +			run;
3990      +			proc transpose data = _MasterDenomTable_Sex_Race
3991      +			               out = _MasterDenomTable_Sex_Race(rename=(_NAME_ = Segment COL1=count));
3992      +			by sex race;
3993      +			run;
3994      +			proc sort data = _MasterDenomTable_Sex_Race;
3995      +			by Segment sex race;
3996      +			run;
3997      +		%end;
3998      +		
3999      +		%if %index(&DENSTRAT.,'SH') > 0 %then %do;
86                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4000      +			data _MasterDenomTable_Sex_Hispanic;
4001      +			set _Patient_days_S_M_H_Y
4002      +			 _Patient_days_S_M_H_N
4003      +			 _Patient_days_S_M_H_R
4004      +			 _Patient_days_S_M_H_UN
4005      +			 _Patient_days_S_M_H_OT
4006      +			 _Patient_days_S_M_H_NI
4007      +			 _Patient_days_S_M_H_XX		
4008      +			 _Patient_days_S_F_H_Y
4009      +			 _Patient_days_S_F_H_N
4010      +			 _Patient_days_S_F_H_R
4011      +			 _Patient_days_S_F_H_UN
4012      +			 _Patient_days_S_F_H_OT
4013      +			 _Patient_days_S_F_H_NI
4014      +			 _Patient_days_S_F_H_XX		
4015      +			 _Patient_days_S_A_H_Y
4016      +			 _Patient_days_S_A_H_N
4017      +			 _Patient_days_S_A_H_R
4018      +			 _Patient_days_S_A_H_UN
4019      +			 _Patient_days_S_A_H_OT
4020      +			 _Patient_days_S_A_H_NI
4021      +			 _Patient_days_S_A_H_XX		
4022      +			 _Patient_days_S_XX_H_Y
4023      +			 _Patient_days_S_XX_H_N
4024      +			 _Patient_days_S_XX_H_R
4025      +			 _Patient_days_S_XX_H_UN
4026      +			 _Patient_days_S_XX_H_OT
4027      +			 _Patient_days_S_XX_H_NI
4028      +			 _Patient_days_S_XX_H_XX;
4029      +
4030      +			PrevDaysALL=sum(of PrevDaysY:,.);
4031      +			IncDaysALL=sum(of IncDaysY:,.);
4032      +			*If enrollment based on encounter, override days with counts;
4033      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
4034      +	       		PrevDaysALL=PrevALL;
4035      +				IncDaysALL=IncALL;
4036      +			%end;
4037      +
4038      +			keep Sex Hispanic prev: inc:;
4039      +			run;
4040      +
4041      +			proc sort data = _MasterDenomTable_Sex_Hispanic;
4042      +			by sex hispanic;
4043      +			run;
4044      +			proc transpose data = _MasterDenomTable_Sex_Hispanic
4045      +			               out = _MasterDenomTable_Sex_Hispanic(rename=(_NAME_ = Segment COL1=count));
4046      +			by sex hispanic;
4047      +			run;
87                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4048      +			proc sort data = _MasterDenomTable_Sex_Hispanic;
4049      +			by Segment sex hispanic;
4050      +			run;
4051      +		%end;
4052      +
4053      +		%if %index(&DENSTRAT.,'HR') > 0 %then %do;
4054      +			data _MasterDenomTable_Hispanic_Race;
4055      +			set _Patient_days_H_Y_R_01
4056      +			 _Patient_days_H_Y_R_02
4057      +			 _Patient_days_H_Y_R_03
4058      +			 _Patient_days_H_Y_R_04
4059      +			 _Patient_days_H_Y_R_05
4060      +			 _Patient_days_H_Y_R_06
4061      +			 _Patient_days_H_Y_R_07
4062      +			 _Patient_days_H_Y_R_UN
4063      +			 _Patient_days_H_Y_R_OT
4064      +			 _Patient_days_H_Y_R_NI
4065      +			 _Patient_days_H_Y_R_XX
4066      +			 _Patient_days_H_N_R_01
4067      +			 _Patient_days_H_N_R_02
4068      +			 _Patient_days_H_N_R_03
4069      +			 _Patient_days_H_N_R_04
4070      +			 _Patient_days_H_N_R_05
4071      +			 _Patient_days_H_N_R_06
4072      +			 _Patient_days_H_N_R_07
4073      +			 _Patient_days_H_N_R_UN
4074      +			 _Patient_days_H_N_R_OT
4075      +			 _Patient_days_H_N_R_NI
4076      +			 _Patient_days_H_N_R_XX
4077      +			 _Patient_days_H_R_R_01
4078      +			 _Patient_days_H_R_R_02
4079      +			 _Patient_days_H_R_R_03
4080      +			 _Patient_days_H_R_R_04
4081      +			 _Patient_days_H_R_R_05
4082      +			 _Patient_days_H_R_R_06
4083      +			 _Patient_days_H_R_R_07
4084      +			 _Patient_days_H_R_R_UN
4085      +			 _Patient_days_H_R_R_OT
4086      +			 _Patient_days_H_R_R_NI
4087      +			 _Patient_days_H_R_R_XX
4088      +			 _Patient_days_H_UN_R_01
4089      +			 _Patient_days_H_UN_R_02
4090      +			 _Patient_days_H_UN_R_03
4091      +			 _Patient_days_H_UN_R_04
4092      +			 _Patient_days_H_UN_R_05
4093      +			 _Patient_days_H_UN_R_06
4094      +			 _Patient_days_H_UN_R_07
4095      +			 _Patient_days_H_UN_R_UN
88                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4096      +			 _Patient_days_H_UN_R_OT
4097      +			 _Patient_days_H_UN_R_NI
4098      +			 _Patient_days_H_UN_R_XX
4099      +			 _Patient_days_H_OT_R_01
4100      +			 _Patient_days_H_OT_R_02
4101      +			 _Patient_days_H_OT_R_03
4102      +			 _Patient_days_H_OT_R_04
4103      +			 _Patient_days_H_OT_R_05
4104      +			 _Patient_days_H_OT_R_06
4105      +			 _Patient_days_H_OT_R_07
4106      +			 _Patient_days_H_OT_R_UN
4107      +			 _Patient_days_H_OT_R_OT
4108      +			 _Patient_days_H_OT_R_NI
4109      +			 _Patient_days_H_OT_R_XX
4110      +			 _Patient_days_H_NI_R_01
4111      +			 _Patient_days_H_NI_R_02
4112      +			 _Patient_days_H_NI_R_03
4113      +			 _Patient_days_H_NI_R_04
4114      +			 _Patient_days_H_NI_R_05
4115      +			 _Patient_days_H_NI_R_06
4116      +			 _Patient_days_H_NI_R_07
4117      +			 _Patient_days_H_NI_R_UN
4118      +			 _Patient_days_H_NI_R_OT
4119      +			 _Patient_days_H_NI_R_NI
4120      +			 _Patient_days_H_NI_R_XX
4121      +			 _Patient_days_H_XX_R_01
4122      +			 _Patient_days_H_XX_R_02
4123      +			 _Patient_days_H_XX_R_03
4124      +			 _Patient_days_H_XX_R_04
4125      +			 _Patient_days_H_XX_R_05
4126      +			 _Patient_days_H_XX_R_06
4127      +			 _Patient_days_H_XX_R_07
4128      +			 _Patient_days_H_XX_R_UN
4129      +			 _Patient_days_H_XX_R_OT
4130      +			 _Patient_days_H_XX_R_NI
4131      +			 _Patient_days_H_XX_R_XX;
4132      +
4133      +			PrevDaysALL=sum(of PrevDaysY:,.);
4134      +			IncDaysALL=sum(of IncDaysY:,.);
4135      +			*If enrollment based on encounter, override days with counts;
4136      +			%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
4137      +	       		PrevDaysALL=PrevALL;
4138      +				IncDaysALL=IncALL;
4139      +			%end;
4140      +
4141      +			keep Hispanic Race prev: inc:;
4142      +			run;
4143      +
89                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4144      +			proc sort data = _MasterDenomTable_Hispanic_Race;
4145      +			by hispanic race;
4146      +			run;
4147      +			proc transpose data = _MasterDenomTable_Hispanic_Race
4148      +			               out = _MasterDenomTable_Hispanic_Race(rename=(_NAME_ = Segment COL1=count));
4149      +			by hispanic race;
4150      +			run;
4151      +			proc sort data = _MasterDenomTable_Hispanic_Race;
4152      +			by Segment hispanic race;
4153      +			run;
4154      +		%end;
4155      +
4156      +		data _MasterDenomTable;
4157      +		format Segment $16. Group $32. Demog $20. DemogVal $10. count best12.;
4158      +		set  %if %index(&DENSTRAT.,'S') > 0 %then %do; _MasterDenomTable_Sex(in=a) %end;
4159      +			 %if %index(&DENSTRAT.,'H') > 0 %then %do; _MasterDenomTable_Hisp(in=b) %end;
4160      +			 %if %index(&DENSTRAT.,'R') > 0 %then %do; _MasterDenomTable_Race(in=c) %end;
4161      +			 %if %index(&DENSTRAT.,'SR') > 0 %then %do; _MasterDenomTable_Sex_Race(in=d) %end;
4162      +			 %if %index(&DENSTRAT.,'SH') > 0 %then %do; _MasterDenomTable_Sex_Hispanic(in=e) %end;
4163      +			 %if %index(&DENSTRAT.,'HR') > 0 %then %do; _MasterDenomTable_Hispanic_Race(in=f) %end;
4164      +		;
4165      +		
4166      +		%if %index(&DENSTRAT.,'S') > 0 %then %do;
4167      +			if a then do;
4168      +			Demog = "Sex";
4169      +			DemogVal = Sex;
4170      +			end;
4171      +		%end;
4172      +
4173      +		%if %index(&DENSTRAT.,'H') > 0 %then %do;
4174      +			if b then do;
4175      +			Demog = "Hispanic";
4176      +			DemogVal = Hispanic;
4177      +			end;
4178      +		%end;
4179      +
4180      +		%if %index(&DENSTRAT.,'R') > 0 %then %do;
4181      +			if c then do;
4182      +			Demog = "Race";
4183      +			DemogVal = Race;
4184      +			end;
4185      +		%end;
4186      +
4187      +		%if %index(&DENSTRAT.,'SR') > 0 %then %do;
4188      +			if d then do;
4189      +			Demog = "Sex-Race";
4190      +			DemogVal = Cats(Sex,'-',Race);
4191      +			end;
90                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4192      +		%end;
4193      +
4194      +		%if %index(&DENSTRAT.,'SH') > 0 %then %do;
4195      +			if e then do;
4196      +			Demog = "Sex-Hispanic";
4197      +			DemogVal = Cats(Sex,'-',Hispanic);
4198      +			end;
4199      +		%end;
4200      +
4201      +		%if %index(&DENSTRAT.,'HR') > 0 %then %do;
4202      +			if f then do;
4203      +			Demog = "Hispanic-Race";
4204      +			DemogVal = Cats(Hispanic,'-',Race);
4205      +			end;
4206      +		%end;
4207      +
4208      +		Group = "&ITGROUP.";
4209      +		label Segment='Segment';
4210      +		if missing(count) then count=0;
4211      +
4212      +		*drop Sex Hispanic Race;
4213      +		run;
4214      +
4215      +		*List of patients in denominators for table counts output;
4216      +		data _DenomPtsList;
4217      +		set
4218      +			%if %index(&DENSTRAT.,'S') > 0 %then %do;
4219      +				_Patient_days_F_list
4220      +			    _Patient_days_M_list
4221      +				_Patient_days_A_list
4222      +				_Patient_days_XX_list
4223      +			%end;
4224      +			%if %index(&DENSTRAT.,'H') > 0 %then %do;
4225      +			_Patient_days_H_Y_list
4226      +		   	_Patient_days_H_N_list
4227      +		   	_Patient_days_H_R_list
4228      +		   	_Patient_days_H_UN_list
4229      +		   	_Patient_days_H_OT_list
4230      +		   	_Patient_days_H_NI_list
4231      +		   	_Patient_days_H_XX_list
4232      +			%end;
4233      +			%if %index(&DENSTRAT.,'R') > 0 %then %do;
4234      +		   	_Patient_days_R_01_list
4235      +		   	_Patient_days_R_02_list
4236      +		   	_Patient_days_R_03_list
4237      +		   	_Patient_days_R_04_list
4238      +		   	_Patient_days_R_05_list
4239      +		   	_Patient_days_R_06_list
91                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4240      +		   	_Patient_days_R_07_list
4241      +		   	_Patient_days_R_UN_list
4242      +		   	_Patient_days_R_OT_list
4243      +		   	_Patient_days_R_NI_list
4244      +		   	_Patient_days_R_XX_list
4245      +			%end;
4246      +		;
4247      +		format Group $32.;
4248      +		Group = "&ITGROUP.";
4249      +		run;
4250      +
4251      +		proc means data=_DenomPtsList nway noprint;
4252      +		var incident;
4253      +		class PatId Group;
4254      +		output out=_DenomPtsList(drop=_:) max=;
4255      +		run;
4256      +
4257      +      	%IF &I.=1 %THEN %DO;
4258      +			data DMLocal.&REQUESTID.&RUNID._MasterDenomTable;
4259      +			set _MasterDenomTable;
4260      +			run;
4261      +			data DMLocal.&REQUESTID.&RUNID._DenomPtsList;
4262      +			set _DenomPtsList;
4263      +			run;
4264      +      	%END;
4265      +      	%ELSE %DO;
4266      +			proc append base = DMLocal.&REQUESTID.&RUNID._MasterDenomTable
4267      +			            data = _MasterDenomTable force;
4268      +			run;
4269      +			proc append base = DMLocal.&REQUESTID.&RUNID._DenomPtsList
4270      +			            data = _DenomPtsList force;
4271      +			run;
4272      +      	%END;
4273      +	%END;
4274      +%MEND DENOMLOOP;
4275      +%DENOMLOOP();
4276      +/*---------------------------------------------------------------------------------------------------*/
4277      +/*  7.0  Denomloop post processing -- Modular Program specific                                       */
4278      +/*---------------------------------------------------------------------------------------------------*/
4279      +option spool;
4280      +proc sort data= DMLocal.&REQUESTID.&RUNID._MasterDenomTable;
4281      +by Group segment Demog DemogVal count;
4282      +run;
4283      +
4284      +data _denom;
4285      +set DMLocal.&REQUESTID.&RUNID._MasterDenomTable;
4286      +
4287      +if upcase(segment)=:'INC' then do;
92                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4288      +  	segment=upcase(substr(segment,4,12));
4289      +  	Inc=1;
4290      +end;
4291      +else do;  /*Prev*/
4292      +  	segment=upcase(substr(segment,5,11));
4293      +  	inc=0;
4294      +end;
4295      +
4296      +time=0;
4297      +if upcase(segment)=:'DAYS' then   do;
4298      +  	segment=upcase(substr(segment,5,11));
4299      +  	time=1;
4300      +end;
4301      +
4302      +/*Assign Age Groupings for merging and create year month variables*/
4303      +if upcase(Segment)=:"AG" then do;
4304      +  	i=compress(upcase(Segment),"AG");
4305      +  	format AgeGroup $13.;
4306      +  	AgeGroup = scan("&AGESTRAT.",i,' ');
4307      +end;
4308      +if upcase(Segment)=:"PER" then do;
4309      +  	StrataStart=intnx("Months",&QUERYFROM.,compress(upcase(Segment),"PER")-1,'sameday');
4310      +  	RxYear=year(StrataStart);
4311      +  	RxMonth=month(StrataStart);
4312      +end;
4313      +if upcase(Segment)=:"Y" then RxYear=compress(upcase(Segment),"Y");
4314      +
4315      +keep segment inc Group count Demog DemogVal RxYear Rxmonth AgeGroup time;
4316      +run;
4317      +
4318      +proc sort data=_denom;
4319      +by Group segment Demog DemogVal inc time count;
4320      +run;
4321      +
4322      +data _denom;
4323      +   	format DMID SiteId $6.;
4324      +   	merge _denom(where=(inc=0 and time=0) rename=count=PrevDenCount)
4325      +          _denom(where=(inc=1 and time=0) rename=count=IncDenCount)
4326      +          _denom(where=(inc=0 and time=1) rename=count=PrevDaysCount)
4327      +          _denom(where=(inc=1 and time=1) rename=count=IncDaysCount);
4328      +   	by Group segment Demog DemogVal;
4329      +  	DMID="&DMID.";
4330      +   	SITEID="&SITEID.";
4331      +   	drop inc;
4332      +run;
4333      +
4334      +%macro wrapper;
4335      +	proc sql noprint;
93                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4336      +	create table DRNOC.&REQUESTID.&RUNID._DenTable0 as
4337      +	Select DMID,
4338      +	       SITEID,
4339      +	       Group,	
4340      +		   Demog,
4341      +		   DemogVal,
4342      +	       AgeGroup,
4343      +	       RxYear,
4344      +	       RxMonth,
4345      +	%if %UPCASE("&ENROPTION.") eq %str("EB1") | %UPCASE("&ENROPTION.") eq %str("EB2")  %then %do;
4346      +	       IncDenCount,
4347      +	       IncDenCount as IncDaysCount,
4348      +	       PrevDenCount,
4349      +	       PrevDenCount as PrevDaysCount
4350      +	%end;
4351      +	%else %do;
4352      +	       IncDenCount,
4353      +	       IncDaysCount,
4354      +	       PrevDenCount,
4355      +	       PrevDaysCount
4356      +	%end;
4357      +	from _denom;
4358      +	quit;
4359      +%mend wrapper;
4360      +%wrapper;
4361      +
4362      +*Apply Threshold;
4363      +options nosymbolgen nomprint;
4364      +data DRNOC.&REQUESTID.&RUNID._DenTable0;
4365      +set DRNOC.&REQUESTID.&RUNID._DenTable0;
4366      +if 0 < IncDenCount < &THRESHOLD. or 0 < PrevDenCount < &THRESHOLD. then do;
4367      +	IncDenCount=.T;
4368      +	IncDaysCount=.T;
4369      +	PrevDenCount=.T;
4370      +	PrevDaysCount=.T;	
4371      +end;
4372      +
4373      +if upcase(Demog)="SEX" and DemogVal not in (&SEX. 'XX') then delete;
4374      +if upcase(Demog)="HISPANIC" and DemogVal not in (&HISPANIC. 'XX') then delete;
4375      +if upcase(Demog)="RACE" and DemogVal not in (&RACE. 'XX') then delete;	
4376      +run;
4377      +options symbolgen mprint;
4378      +/*---------------------------------------------------------------------------------------------------*/
4379      +/*  8.0  Add demographics information to master dispensing table                                     */
4380      +/*---------------------------------------------------------------------------------------------------*/
4381      +
4382      +proc sort nodupkey data = _Enrollment(keep=PatId Birth_Date Sex Hispanic Race);
4383      +by PatId;
94                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4384      +run;
4385      +
4386      +%macro wrapper;
4387      +	data DMLocal.&REQUESTID.&RUNID._QueryGroup(keep=PatID Sex Hispanic Race Admit_Date AgeGroup Group Dispense_Sup Dispense_Amt
4388      +	                                                NumDipensing RxYear RxMonth NewStart Incident FIncDt);
4389      +	if 0 then set _Enrollment;
4390      +	declare hash ht (hashexp:16, dataset:"_Enrollment");
4391      +	ht.definekey('PatId');
4392      +	ht.definedata(ALL: 'YES');
4393      +	ht.definedone();
4394      +
4395      +	do until(eof1);
4396      +		set DMLocal.&REQUESTID.&RUNID._MasterTable end=eof1;
4397      +		format AgeGroup $9.;
4398      +		if ht.find()=0 then do;
4399      +			if Incident = 1 then do;
4400      +				NewStart = 1;
4401      +			end;
4402      +			else do;
4403      +				NewStart = 0;
4404      +			IndexDt = .;
4405      +			end;
4406      +
4407      +		%if %UPCASE("&AGECALC.") eq %Str("I") %then %do;
4408      +			do i=&NUMAGECAT. to 1 by -1;
4409      +				if Admit_Date >= intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday') then do;
4410      +				   	AgeGroup = scan("&AGESTRAT.",i,' ');
4411      +				   	leave;
4412      +				end;
4413      +			end;
4414      +
4415      +			MinAgeDate = intnx(scan("&AGETYP.",1),birth_date,&MINAGE.,'sameday');
4416      +
4417      +			if &MAXAGE.=99999 then MaxAgeDate=intnx('Years',birth_date,110,'sameday');
4418      +			else MaxAgeDate=intnx(scan("&AGETYP.",&NUMAGECAT.),birth_date,&MAXAGE.+1,'sameday')-1;
4419      +
4420      +			if MinAgeDate <= Admit_Date <= MaxAgeDate then output DMLocal.&REQUESTID.&RUNID._QueryGroup;
4421      +		%end;
4422      +		%if %UPCASE("&AGECALC.") eq %Str("F") %then %do;
4423      +			do i=&NUMAGECAT. to 1 by -1;
4424      +				if &QUERYTO. >= intnx(scan("&AGETYP.",i),birth_date,scan("&AGETHRESH.",i),'sameday') then do;
4425      +				   	AgeGroup = scan("&AGESTRAT.",i,' ');
4426      +				   	leave;
4427      +				end;
4428      +			end;
4429      +		
4430      +			if &MINAGE. <= QToAge <= &MAXAGE. then output DMLocal.&REQUESTID.&RUNID._QueryGroup;
4431      +		%end;
95                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4432      +		end;
4433      +	end;
4434      +
4435      +	stop;
4436      +	run;
4437      +%mend wrapper;
4438      +%wrapper;
4439      +
4440      +proc sql noprint;
4441      +	create table _Table0 as
4442      +	Select  PatId,
4443      +       		Group,
4444      +       		Admit_Date,
4445      +       		FIncDt,
4446      +       		Sex,
4447      +	   		Race,
4448      +	   		Hispanic,
4449      +       		AgeGroup,
4450      +       		RxYear,
4451      +       		RxMonth,
4452      +       		incident,
4453      +       		NewStart,
4454      +       		Dispense_Sup,
4455      +	   		Dispense_Amt,
4456      +       		NumDipensing
4457      +   	from DMLocal.&REQUESTID.&RUNID._QueryGroup
4458      +   	order by PatId, Group;
4459      +quit;
4460      +
4461      +/*For Prevalent*/
4462      +proc means data=_Table0 noprint;
4463      +var Dispense_Sup Dispense_Amt NumDipensing;
4464      +class Patid Group Sex Race Hispanic AgeGroup RxYear RxMonth;
4465      +output out=_PTable0(drop=_freq_ where=(PatId ne "") rename=_type_=seg) sum(NumDipensing)=Dispensings
4466      +                                                                       sum(Dispense_Sup)=DaySupp
4467      +																	   sum(Dispense_Amt)=AmtSupp;
4468      +run;
4469      +
4470      +proc means data=_PTable0 noprint nway missing;
4471      +var Dispensings DaySupp AmtSupp;
4472      +class Group Sex Race Hispanic AgeGroup RxYear RxMonth seg;
4473      +output out=_PTable0(drop=_type_ rename=_freq_=Npts where=(Group ne "")) sum = ;
4474      +run;
4475      +
4476      +/*For Incident*/
4477      +proc means data=_Table0 noprint;
4478      +var NewStart Dispense_Sup Dispense_Amt NumDipensing Incident;
4479      +class Patid Group Sex Race Hispanic AgeGroup RxYear RxMonth;
96                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4480      +where incident = 1;
4481      +output out=_ITable0(drop=_freq_ where=(PatId ne "") rename=_type_=seg) max(incident)=incident
4482      +                                                                       sum(NewStart)=NewStarts
4483      +                                                                       sum(NumDipensing)=Dispensings
4484      +                                                                       sum(Dispense_Sup)=DaySupp
4485      +																	   sum(Dispense_Amt)=AmtSupp;
4486      +run;
4487      +
4488      +proc means data=_ITable0 noprint nway missing;
4489      +var NewStarts Dispensings DaySupp AmtSupp;
4490      +class Group Sex Race Hispanic AgeGroup RxYear RxMonth seg;
4491      +where incident = 1;
4492      +output out=_ITable0(drop=_type_ rename=_freq_=Npts where=(Group ne "")) sum =;
4493      +run;
4494      +options nosymbolgen nomprint;
4495      +data DRNOC.&REQUESTID.&RUNID._NumTab0;
4496      +set _ITable0(in=a)
4497      +   _PTable0;
4498      +Incident = 0;
4499      +if a then Incident = 1;
4500      +if 0 < NPts < &THRESHOLD. then do;
4501      +	Npts=.T;
4502      +	NewStarts=.T;
4503      +	Dispensings=.T;
4504      +	DaySupp=.T;	
4505      +	AmtSupp=.T;
4506      +end;
4507      +
4508      +if not missing(Sex) and Sex not in (&SEX. 'XX') then delete;
4509      +if not missing(Hispanic) and Hispanic not in (&HISPANIC. 'XX') then delete;
4510      +if not missing(Race) and Race not in (&RACE. 'XX') then delete;	
4511      +run;
4512      +options symbolgen mprint;
4513      +
4514      +/*---------------------------------------------------------------------------------------------------*/
4515      +/* 9.0 Freeze cdm data with eligible patient and applicable input files codes                        */
4516      +/*---------------------------------------------------------------------------------------------------*/
4517      +proc contents data=_diag noprint out=_tilt_ ;
4518      +
4519      +data _null_ ;
4520      +set _tilt_ ;
4521      +call symputx('dnobs',trim(left(put(nobs,15.)))) ;
4522      +run;
4523      +
4524      +%PUT &dnobs.;
4525      +%IF %EVAL(&dnobs.>0) %THEN %DO;
4526      +	data data DMLocal.&REQUESTID.&RUNID._PatIdList;
4527      +	set _DenomInt;
97                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4528      +	keep PatId;
4529      +	run;
4530      +
4531      +	proc sort nodupkey data=_diag out=_diagcodes;
4532      +	by Origcode;
4533      +	run;
4534      +
4535      +	%put &prefilename.;
4536      +
4537      +	proc sql noprint;
4538      +		create table DMLocal.&REQUESTID.&RUNID._Diagnosis as
4539      +		select diagtb.*
4540      +		from &prefilename. as diagtb,
4541      +		     DMLocal.&REQUESTID.&RUNID._PatIdList as ptsList,
4542      +			 _diagcodes as diaglist
4543      +		where diagtb.patId = ptsList.patId and
4544      +		(
4545      +		(diaglist.exact=-2) or
4546      +		(diagtb.DX_type = diaglist.codetype and diaglist.exact=-1 and substr(compress(diagtb.DX,'.'),1,diaglist.length) = diaglist.code and
4547      +		 substr(compress(diagtb.DX,'.'),diaglist.WildcardIndex+1,diaglist.LengthCodeEnd) = diaglist.CodeEnd) or
4548      +		(diagtb.DX_type = diaglist.codetype and diaglist.exact=0  and substr(compress(diagtb.DX,'.'),1,diaglist.length) = diaglist.Code) or
4549      +		(diagtb.DX_type = diaglist.codetype and diaglist.exact=1  and compress(diagtb.DX,'.')=diaglist.code)
4550      +		)
4551      +		;	
4552      +	quit;
4553      +
4554      +	proc sort nodupkey data=DMLocal.&REQUESTID.&RUNID._Diagnosis;
4555      +	by _ALL_;
4556      +	run;
4557      +%END;
4558      +
4559      +options mergenoby=NOWARN;
4560      +%pc_tablecount;
4561      +%pc_report;
4562      +
4563      +/*---------------------------------------------------------------------------------------------------*/
4564      +/* 10.0 Create signature file                                                                        */
4565      +/*---------------------------------------------------------------------------------------------------*/
4566      +
4567      +data _NULL_;
4568      +   temp=DATETIME();
4569      +   call symputx('STOP',temp);
4570      +   seconds=temp-&start.;
4571      +   hours=int(seconds/3600);
4572      +   minutes=int((seconds-hours*3600)/60);
4573      +   seconds2=int((seconds-hours*3600-minutes*60));
4574      +   call symputx('totalseconds',put(seconds,best.));
4575      +   call symputx('hours',put(hours,4.0));
98                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4576      +   call symputx('minutes',put(minutes,2.0));
4577      +   call symputx('seconds',put(seconds2,2.0));
4578      +run;
4579      +
4580      +%PUT TOTAL RUN TIME was &hours. h &minutes. m &seconds. s;
4581      +
4582      +data signature;
4583      +   MPNum="&MPNum.";
4584      +   MPVer="&MPVer.";
4585      +   DMID="&DMID.";
4586      +   SITEID="&SITEID.";
4587      +   RequestID="&RequestID.";
4588      +   RunID="&RunID.";
4589      +   format StartTime StopTime datetime21.2;
4590      +   StartTime=trim(left(&START.));
4591      +   StopTime=trim(left(&STOP.));
4592      +   format RunTime Seconds $20.;
4593      +   RunTime="&hours. h &minutes. m &seconds. s";
4594      +   Seconds="&totalseconds. s";
4595      +   ScenarioCnt=strip("&NQUERYGROUP.");
4596      +   ENROLGAP="&ENROLGAP.";
4597      +   COVERAGE="&COVERAGE.";
4598      +   QUERYFROM="&QUERYFROMc.";
4599      +   QUERYTO="&QUERYTOc.";
4600      +   QUERYFILE="&QUERYFILE.";
4601      +   INCQUERYFILE="&INCQUERYFILE.";
4602      +   CONDFILE="&CONDFILE.";
4603      +   OUTTABLESFILE="&OUTTABLESFILE.";
4604      +   AGESTRAT="&AGESTRAT.";
4605      +   output;
4606      +run;
4607      +
4608      +proc transpose data=signature out=signature(rename=_NAME_=Var rename=COL1=VALUE);
4609      +   var _ALL_;
4610      +run;
4611      +
4612      +
4613      +data DRNOC.&REQUESTID.&RUNID._signature;
4614      +   set  signature;
4615      +run;
4616      +
4617      +proc printto log=log;* print=print;
4618      +run;
4619      +
4620      +%if %str(&KeepDMLocal.) = %str(N) %then %do;
4621      +	proc datasets library=DMLOCAL kill nolist nowarn;
4622      +	quit;
4623      +%end;
99                                                                  The SAS System                                       13:55 Tuesday, March 13, 2018

4624      +
4625      +/*---------------------------------------------------------------------------------------------------*/
4626      +/* 11.0 Rewrite log to mask low cell count                                                                        */
4627      +/*---------------------------------------------------------------------------------------------------*/
4628      +
4629      +*Determine threshold category;
4630      +%let THRESHOLDCAT=?;
4631      +%macro createThreshOldCat();
4632      +	%if %eval(&THRESHOLD.=0) %then %do;
4633      +		%let THRESHOLDCAT=0;
4634      +	%end;
4635      +	%if %eval(0<&THRESHOLD. & &THRESHOLD.<11) %then %do;
4636      +		%let THRESHOLDCAT=1-10;
4637      +	%end;
4638      +	%if %eval(10<&THRESHOLD. & &THRESHOLD.<21) %then %do;
4639      +		%let THRESHOLDCAT=11-20;
4640      +	%end;
4641      +	%if %eval(21<&THRESHOLD. & &THRESHOLD.<50) %then %do;
4642      +		%let THRESHOLDCAT=21-50;
4643      +	%end;
4644      +	%if %eval(51<&THRESHOLD. & &THRESHOLD.<100) %then %do;
4645      +		%let THRESHOLDCAT=51-100;
4646      +	%end;
4647      +	%if %eval(&THRESHOLD.>100) %then %do;
4648      +		%let THRESHOLDCAT=100+;
4649      +	%end;
4650      +%mend createThreshOldCat;
4651      +%createThreshOldCat();
4652      +
4653      +%put &THRESHOLDCAT.;
4654      +
4655      +/*
4656      +*Create a copy of the log to DPlocal;
4657      +%sysExec xcopy "&DRNOC.&REQUESTID.&RUNID..log" "&dmlocal." /Y;
4658      +*/
4659      +
4660      +*Load log file into dataset;
4661      +data _log;
4662      +infile "&DRNOC.&REQUESTID.&RUNID..log" truncover;
4663      +input var1 $1000.;
4664      +run;
4665      +
4666      +*copy log to dmlocal;
4667      +data _null_ ;          							*No SAS data set is created;
4668      +    set _log;
4669      +    FILE  "&DMLOCAL.&REQUESTID.&RUNID..log" ;     *Output Text File;
4670      +    PUT var1;
4671      +run ;
100                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4672      +
4673      +*Add a header to the log;
4674      +data _header;
4675      +format var1 $1000.;
4676      +var1="Note: This SAS log has all numbers less than the low cell count threshold entered in the master.sas file masked.";
4677      +output;
4678      +var1="";
4679      +output;
4680      +run;
4681      +
4682      +*Find OBSERVATIONS keyword to replace low cell counts;
4683      +data _log;
4684      +set _header _log;
4685      +format num $10. var2 $1030.;
4686      +pos=indexw(var1,"observations");
4687      +pos1=indexw(var1,"rows");
4688      +pos2=indexw(var1,"THRESHOLD resolves to");
4689      +pos3=indexw(var1,"< CritCnt <");
4690      +pos4=indexw(var1,"< Excluded <");
4691      +var2=var1;
4692      +if pos>0 then do;
4693      +	num=scan(var1,countw(substr(var1,1,pos-1)));
4694      +	if strip(upcase(num) ne "NO") then do;
4695      +		if 0 < input(num,best.) < &threshold. then do;
4696      +			var2=TRANWRD(var1,compress(num),"[number is masked (&thresholdcat.)]");
4697      +		end;
4698      +	end;
4699      +end;
4700      +if pos1>0 then do;	
4701      +	num=scan(var1,countw(substr(var1,1,pos1-1)));
4702      +	if strip(upcase(num) ne "NO") then do;
4703      +		if 0 < input(num,best.) < &threshold. then do;
4704      +			var2=TRANWRD(var1,compress(num),"[number is masked (&thresholdcat.)]");
4705      +		end;
4706      +	end;
4707      +end;
4708      +if pos2>0 then do;
4709      +	num=scan(var1,countw(substr(var1,1,pos2+22)));	
4710      +	var2=TRANWRD(var1,compress(num),"[number is masked (&thresholdcat.)]");
4711      +end;
4712      +if pos3>0 then do;
4713      +	num=scan(var1,countw(substr(var1,1,pos3+12)));	
4714      +	var2=TRANWRD(var1,compress(num),"[number is masked (&thresholdcat.)]");
4715      +end;
4716      +if pos4>0 then do;
4717      +	num=scan(var1,countw(substr(var1,1,pos4+13)));	
4718      +	var2=TRANWRD(var1,compress(num),"[number is masked (&thresholdcat.)]");
4719      +end;
101                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4720      +run;
4721      +
4722      +*Output altered log;
4723      +data _null_ ;          							*No SAS data set is created;
4724      +    set _log;
4725      +    FILE  "&DRNOC.&REQUESTID.&RUNID..log" ;     *Output Text File;
4726      +    PUT var2;
4727      +run ;
4728      +
4729      +proc datasets library=work nolist nowarn;
4730      +   delete _:;
4731      +quit;
4732      +
4733      +%MEND MODULARPROGRAM1;
NOTE: %INCLUDE (level 1) ending.
SYMBOLGEN:  Macro variable SASMACR resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/
4734       %include "&sasmacr.pc_tablecount.sas" / source2;
NOTE: %INCLUDE (level 1) file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pc_tablecount.sa
      s is file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pc_tablecount.sa
      s.
4735      +***************************************************************************************************
4736      +*                                           PROGRAM OVERVIEW
4737      +****************************************************************************************************
4738      +*
4739      +* PROGRAM: pc_tablecount.sas
4740      +*
4741      +* Created (mm/dd/yyyy): 12/20/2016
4742      +* Last modified:
4743      +* Version: 1.0
4744      +*
4745      +*--------------------------------------------------------------------------------------------------
4746      +* PURPOSE:
4747      +*   Create CDM tables counts
4748      +*
4749      +*  Program inputs:
4750      +*	-
4751      +*
4752      +*  Program outputs:
4753      +*   -drnoc.&RUNID._tablecount;
4754      +*
4755      +*  PARAMETERS:
4756      +*
4757      +*  Programming Notes:
4758      +*
4759      +*--------------------------------------------------------------------------------------------------
102                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4760      +* CONTACT INFO:
4761      +*  PCORnet Distributed Research Network Operations Center (DRN OC)
4762      +*  jessica_sturtevant@harvardpilgrim.org
4763      +*
4764      +*--------------------------------------------------------------------------------------------------
4765      +*  CHANGE LOG:
4766      +*
4767      +*   Version   Date       Initials      Comment (reference external documentation when available)
4768      +*   -------   --------   --------   ---------------------------------------------------------------
4769      +*
4770      +***************************************************************************************************;
4771      +
4772      +
4773      +%macro pc_tablecount;
4774      +
4775      +*Create lists of num and denom patids by group (for square);
4776      +
4777      +	proc sort nodupkey data=infolder.&QUERYFILE.(keep=Group) out=_grouplist;
4778      +	by Group;
4779      +	run;
4780      +
4781      +*creating empty format file;
4782      +	data _grouplist;
4783      +	set dmlocal.&REQUESTID.&RUNID._mastertable(in=a obs=1 keep=Patid)
4784      +	    _grouplist;
4785      +	if a then delete;
4786      +	one=.;
4787      +	call missing(Patid);
4788      +	run;
4789      +	proc transpose data=_grouplist out=_numgrouplist prefix=num_;
4790      +	var one;
4791      +	by Patid;
4792      +	id group;
4793      +	run;
4794      +	proc transpose data=_grouplist out=_dengrouplist prefix=den_;
4795      +	var one;
4796      +	by Patid;
4797      +	id group;
4798      +	run;
4799      +
4800      +	data headers;
4801      +	merge _numgrouplist _dengrouplist;
4802      +	by Patid;
4803      +	drop _:;
4804      +	run;
4805      +
4806      +*create macro variables to contain the numerator and denominator group selectors;
4807      +	proc sql noprint;
103                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4808      +		select distinct compress("num_"||strip(group)) into :num separated by ' '
4809      +	from _grouplist;
4810      +	quit;
4811      +	%put &num.;
4812      +	proc sql noprint;
4813      +		select distinct compress("den_"||strip(group)) into :den separated by ' '
4814      +	from _grouplist;
4815      +	quit;
4816      +	%put &den.;
4817      +
4818      +*Get member listings for each group in numerator;
4819      +	proc sort nodupkey data=dmlocal.&REQUESTID.&RUNID._mastertable(keep=Patid Group incident) out=_num(drop=incident);
4820      +	by Patid Group;
4821      +	where incident=1;
4822      +	run;
4823      +
4824      +	data _num;
4825      +	set _num;
4826      +	one=1;
4827      +	run;
4828      +
4829      +	proc transpose data=_num out=_numT prefix=num_;
4830      +	var one;
4831      +	by Patid;
4832      +	id Group;
4833      +	run;
4834      +
4835      +*Get member listings for each group in denominator;
4836      +	proc sort nodupkey data=dmlocal.&REQUESTID.&RUNID._denomptslist(keep=Patid Group incident) out=_den(drop=incident);
4837      +	by Patid Group;
4838      +	where incident=1;
4839      +	run;
4840      +
4841      +	data _den;
4842      +	set _den;
4843      +	one=1;
4844      +	run;
4845      +
4846      +	proc transpose data=_den out=_denT prefix=den_;
4847      +	var one;
4848      +	by Patid;
4849      +	id Group;
4850      +	run;
4851      +
4852      +	data combine;
4853      +	merge _numT
4854      +	      _denT;
4855      +	by Patid;
104                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4856      +	run;
4857      +
4858      +	data combine;
4859      +	merge headers(in=a)
4860      +	      combine;
4861      +	by Patid;
4862      +	if a then delete;
4863      +	rename patid=patid2;
4864      +	drop _:;
4865      +	run;
4866      +
4867      +*cleaning up;
4868      +	proc datasets library=work nowarn noprint;
4869      +	delete _:;
4870      +	quit;
4871      +
4872      +%MACRO ADDVAR(DS,VAR);
4873      +
4874      +%GLOBAL VAREXIST;
4875      +%LET VAREXIST=0;
4876      +%LET DSID = %SYSFUNC(OPEN(&DS));
4877      +%IF (&DSID) %THEN %DO;
4878      +    %IF %SYSFUNC(VARNUM(&DSID,&VAR)) %THEN %LET VAREXIST=1;
4879      +    %LET RC = %SYSFUNC(CLOSE(&DSID));
4880      +%END;
4881      +
4882      +%if %eval(&VAREXIST.=0) %then %do;
4883      +data &DS.;set &DS.;col1=.;run;
4884      +%end;
4885      +
4886      +%MEND ADDVAR;
4887      +
4888      +%macro CreateTableEntry(filein=,EncounterID=,seq=);
4889      +
4890      +%if %length(&filein.)>0 %then %do;
4891      +*Select data;
4892      +	%macro wrapper;
4893      +		data _thisTable;
4894      +		set indata.&filein.;
4895      +		AllData=1;
4896      +		row=1;
4897      +		*if lengthn("&EncounterID.") then call symputx("EncounterIDSQL",Strip(",d."||"&EncounterID."));
4898      +		if missing(Patid)=0 then allPatid=1;
4899      +		allEncounterId=.;
4900      +		%if %length(&EncounterID.) %then %do;
4901      +		if missing(&EncounterID.)=0 then allEncounterId=1;
4902      +		%end;
4903      +		keep Patid &EncounterID. allPatid allEncounterId row AllData;
105                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4904      +		run;
4905      +	%mend;
4906      +	%wrapper;
4907      +
4908      +	proc sql noprint undo_policy=none;
4909      +	create table _thisTable(drop=patid2) as
4910      +	select d.* ,
4911      +           e.* /*&EncounterIDSQL.*/
4912      +	from _thisTable as d left join
4913      +	     combine as e
4914      +		 on d.Patid = e.patid2;
4915      +	quit;
4916      +		
4917      +*rows;
4918      +	proc means data=_thisTable noprint nway;
4919      +    var AllData &num. &den. ;
4920      +	where row=1;
4921      +	output out=_row sum=;
4922      +	run;
4923      +
4924      +	proc transpose data=_row out=_rowT;
4925      +	var AllData &num. &den. ;
4926      +	run;
4927      +
4928      +	%ADDVAR(_rowT,col1);
4929      +
4930      +
4931      +*allPatid;
4932      +	proc means data=_thisTable noprint nway;
4933      +    var AllData &num. &den. ;
4934      +	where allPatid=1;
4935      +	output out=_AllPatid sum=;
4936      +	run;
4937      +	
4938      +	proc transpose data=_AllPatid out=_AllPatidT;
4939      +	var AllData &num. &den. ;
4940      +	run;
4941      +
4942      +	%ADDVAR(_AllPatidT,col1);
4943      +
4944      +*unique PatIds;
4945      +	proc means data=_thisTable noprint nway;
4946      +    var AllData &num. &den. ;
4947      +	where allPatid=1;
4948      +	class patid;
4949      +	output out=_distinctPatid max=;
4950      +	run;
4951      +
106                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

4952      +
4953      +	proc means data=_distinctPatid noprint nway;
4954      +    var AllData &num. &den.;
4955      +	output out=_distinctPatid sum=;
4956      +	run;
4957      +
4958      +	proc transpose data=_distinctPatid out=_distinctPatidT;
4959      +	var AllData &num. &den. ;
4960      +	run;
4961      +
4962      +	%ADDVAR(_distinctPatidT,col1);
4963      +
4964      +
4965      +%macro UniqueEncounterIDs;
4966      +%if %length(&EncounterId.) %then %do;
4967      +
4968      +*all EncounterIDs;
4969      +	proc means data=_thisTable noprint nway;
4970      +    var AllData &num. &den. ;
4971      +	where allEncounterId=1;
4972      +	output out=_allEncounterID sum=;
4973      +	run;
4974      +	
4975      +	proc transpose data=_allEncounterID out=_allEncounterIDT;
4976      +	var AllData &num. &den. ;
4977      +	run;
4978      +
4979      +	%ADDVAR(_allEncounterIDT,col1);
4980      +
4981      +*unique EncounterIDs;
4982      +
4983      +	*Prepare loop parameters;
4984      +	data _null;
4985      +	call symput("fullVarListForLoop", "AllData "||"&num. "||"&den");
4986      +	numw=countw("&num.")*2+1;
4987      +	call symput("numVarListForLoop", numw);
4988      +	run;
4989      +	%put &fullVarListForLoop. &numVarListForLoop.;
4990      +
4991      +	proc datasets library=work nolist nowarn;
4992      +	delete _distinctEncounterId;
4993      +	quit;
4994      +
4995      +
4996      +	%do i=1 %to &numVarListForLoop.;
4997      +
4998      +		*two threaded procedures;
4999      +		proc sort nodupkey data=_thisTable out=_forLoop(keep=patid &EncounterId. %scan(&fullVarListForLoop.,&i.));
107                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5000      +		by patid &EncounterId.;
5001      +		where allEncounterId=1 and %scan(&fullVarListForLoop.,&i.)=1;
5002      +		run;
5003      +
5004      +		proc means data=_forLoop noprint nway;
5005      +	    var %scan(&fullVarListForLoop.,&i.);
5006      +		output out=_forLoop(drop=_:) sum=;
5007      +		run;
5008      +
5009      +		data _forLoop;
5010      +		set _forLoop;
5011      +		row=_N_;
5012      +		run;
5013      +		%if %eval(&i.=1) %then %do;
5014      +			data _distinctEncounterId;
5015      +			set _forLoop;
5016      +			run;
5017      +		%end;
5018      +		%else %do;
5019      +			data _distinctEncounterId;
5020      +			merge _distinctEncounterId _forLoop ;
5021      +			by row;*no by;
5022      +			run;
5023      +		%end;
5024      +		proc datasets library=work nolist nowarn;
5025      +		delete _forLoop;
5026      +		quit;
5027      +
5028      +	%end;
5029      +
5030      +
5031      +/*	proc means data=_thisTable noprint nway;
5032      +    var AllData &num. &den. ;
5033      +	where allEncounterId=1;
5034      +	class patid &EncounterId.;
5035      +	output out=_distinctEncounterId max=;
5036      +	run;
5037      +
5038      +
5039      +	proc means data=_distinctEncounterId noprint nway;
5040      +    var AllData &num. &den. ;
5041      +	output out=_distinctEncounterId sum=;
5042      +	run; */
5043      +
5044      +	proc transpose data=_distinctEncounterId out=_distinctEncounterIdT;
5045      +	var AllData &num. &den. ;
5046      +	run;
5047      +
108                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5048      +	%ADDVAR(_distinctEncounterIdT,col1);
5049      +
5050      +%end;
5051      +%else %do;
5052      +
5053      +	data _allEncounterIDT
5054      +		 _distinctEncounterIdT;
5055      +	set _rowT;
5056      +	col1=.;
5057      +	run;
5058      +
5059      +%end;
5060      +%mend;
5061      +%UniqueEncounterIDs;
5062      +
5063      +options nosymbolgen nomprint;
5064      +	data Report;
5065      +	format seq best. table $20.;
5066      +	merge _AllPatidT(rename=col1=AllPatid)
5067      +	      _distinctPatidT(keep=col1 rename=col1=distinctPatid)
5068      +	      _allEncounterIdT(keep=col1 rename=col1=allEncounterId)
5069      +	      _distinctEncounterIdT(keep=col1 rename=col1=distinctEncounterId)
5070      +	      _rowT(keep=col1 rename=col1=row)
5071      +	;
5072      +	*no by;
5073      +	seq=&seq.;
5074      +	table = "&filein.";
5075      +	if 0 < AllPatid < &THRESHOLD. then AllPatid=.t;
5076      +	if 0 < distinctPatid < &THRESHOLD. then distinctPatid=.t;
5077      +	if 0 < allEncounterId < &THRESHOLD. then allEncounterId=.t;
5078      +	if 0 < distinctEncounterId < &THRESHOLD.  then distinctEncounterId=.t;
5079      +	if 0 < row < &THRESHOLD.  then row=.t;
5080      +	run;
5081      +	options symbolgen mprint;
5082      +
5083      +	proc append base=drnoc.&REQUESTID.&RUNID._tablecount data=Report force;
5084      +	run;
5085      +
5086      +	proc datasets library=work nolist nowarn;
5087      +	delete Report _:;
5088      +	quit;
5089      +
5090      +%end;
5091      +
5092      +%mend;
5093      +
5094      +proc datasets library=drnoc nolist nowarn;
5095      +delete &REQUESTID.&RUNID._tablecount;
109                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5096      +quit;
5097      +
5098      +%CreateTableEntry(filein=&DEMTABLE.,EncounterID=,seq=1);
5099      +%CreateTableEntry(filein=&DIATABLE.,EncounterID=EncounterID,seq=2);
5100      +%CreateTableEntry(filein=&ENCTABLE.,EncounterID=EncounterID,seq=3);
5101      +%CreateTableEntry(filein=&PROCTABLE.,EncounterID=EncounterID,seq=4);
5102      +%CreateTableEntry(filein=&VITTABLE.,EncounterID=EncounterID,seq=5);
5103      +%CreateTableEntry(filein=&PRESCTABLE.,EncounterID=EncounterID,seq=6);
5104      +%CreateTableEntry(filein=&DISTABLE.,EncounterID=,seq=7);
5105      +%CreateTableEntry(filein=&LABTABLE.,EncounterID=EncounterID,seq=8);
5106      +%CreateTableEntry(filein=&DEATHTABLE.,EncounterID=EncounterID,seq=9);
5107      +
5108      +%mend;
NOTE: %INCLUDE (level 1) ending.
SYMBOLGEN:  Macro variable SASMACR resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/
5109       %include "&sasmacr.pc_report.sas" / source2;
NOTE: %INCLUDE (level 1) file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pc_report.sas 
      is file 
      /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/infolder/macros/pc_report.sas.
5110      +***************************************************************************************************
5111      +*                                           PROGRAM OVERVIEW
5112      +****************************************************************************************************
5113      +*
5114      +* PROGRAM: pc_report.sas
5115      +*
5116      +* Created (mm/dd/yyyy): 01/26/2017
5117      +* Last modified:
5118      +* Version: 1.0
5119      +*
5120      +*--------------------------------------------------------------------------------------------------
5121      +* PURPOSE:
5122      +*   Create PMP1 RTF Report
5123      +*
5124      +*  Program inputs:
5125      +*	-
5126      +*
5127      +*  Program outputs:
5128      +*   -drnoc.&RUNID._tpmp1_report.rtf;
5129      +*
5130      +*  PARAMETERS:
5131      +*
5132      +*  Programming Notes:
5133      +*
5134      +*--------------------------------------------------------------------------------------------------
5135      +* CONTACT INFO:
5136      +*  PCORnet Distributed Research Network Operations Center (DRN OC)
110                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5137      +*  jessica_sturtevant@harvardpilgrim.org
5138      +*
5139      +*--------------------------------------------------------------------------------------------------
5140      +*  CHANGE LOG:
5141      +*
5142      +*   Version   Date       Initials      Comment (reference external documentation when available)
5143      +*   -------   --------   --------   ---------------------------------------------------------------
5144      +*
5145      +***************************************************************************************************;
5146      +
5147      +
5148      +%macro pc_report;
5149      +/****************************/
5150      +/* Setup General Parameters */
5151      +/****************************/
5152      +
5153      +    %let maxls=95 ;
5154      +    %let ps=50;
5155      +    %let ls=110;
5156      +
5157      +    options ls=&ls ps=&ps nodate nonumber mprint mlogic
5158      +            mtrace symbolgen missing=' ' formchar="|_ _ ||||||" /*noxwait noxsync*/
5159      +            noquotelenmax;
5160      +
5161      +
5162      +    title1; title2;title3;
5163      +    options orientation=portrait;
5164      +    options bottommargin = .5in
5165      +               topmargin = .5in
5166      +             rightmargin = .5in
5167      +              leftmargin = .5in;
5168      +
5169      +    ods listing close;
5170      +
5171      +    %global section protocol draft;
5172      +    %let section=;
5173      +
5174      +    %let draft=%str(Confidential);
5175      +    %let pgmnum=;
5176      +    %let pgm=;
5177      +
5178      +    %global tl1 tl2 ft99;
5179      +
5180      +
5181      +/*****************************/
5182      +/* Define Special Characters */
5183      +/*****************************/
5184      +    data _null_;
111                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5185      +    call symput("line",repeat("_",&ls));
5186      +    call symput("file","PCORnet Modular Program 1 v&MPVer. - &DMID.&SITEID. - &RequestID._&runid.");
5187      +    call symput("dtstamp","DATE: " || put(date(),date9.) ||' '|| put(time(),time5.));
5188      +    call symput('s1','B9'x); ** superscript 1 ;
5189      +    call symput('s2','B2'x); ** superscript 2 ;
5190      +    call symput('s3','B3'x); ** superscript 3 ;
5191      +    run;
5192      +
5193      +/************************/
5194      +/* Setup RTF parameters */
5195      +/************************/
5196      +
5197      +/*http://support.sas.com/techsup/notes/v8/4/739.html*/
5198      +ods path(prepend) work.templat(update);
5199      +
5200      +    proc template;
5201      +    define style style1;
5202      +    parent = styles.rtf;
5203      +    replace fonts/
5204      +    'TitleFont2' = ("Courier New",8.0pt)
5205      +    'TitleFont' = ("Courier New",8.0pt)
5206      +    'StrongFont' = ("Courier New",8.0pt)
5207      +    'EmphasisFont' = ("Courier New",8.0pt)
5208      +    'FixedEmphasisFont' = ("Courier New",8.0pt)
5209      +    'FixedStrongFont' = ("Courier New",8.0pt)
5210      +    'FixedHeadingFont' = ("Courier New",8.0pt)
5211      +    'BatchFixedFont' = ("Courier New",8.0pt)
5212      +    'headingEmphasisFont'= ("Courier New",8.0pt)
5213      +    'headingFont' = ("Courier New",8.0pt)
5214      +    'FixedFont' = ("Courier New",8.0pt)
5215      +    'docFont' = ("Courier New",8.0pt);
5216      +    style systemfooter from titlesandfooters / asis=on just=left;
5217      +    style header from header / asis=on background=white  borderbottomcolor=black  borderbottomwidth=1;
5218      +    style table from output / asis=on protectspecialchars=off rules=groups frame=void  borderbottomcolor=white
5219      +    cellspacing=0 cellpadding=1;
5220      +    style data from cell / asis=on protectspecialchars=off;
5221      +    end;
5222      +    run;
5223      +
5224      +    ods path(prepend) work.template(update);
5225      +    %let rtfpage = {\field{\*\fldinst {PAGE }}};
5226      +    %let rtfnumpages = {\field{\*\fldinst {NUMPAGES }}};
5227      +    %let rtfcommand = {Page }&rtfpage. {of }&rtfnumpages;
5228      +    %let _ol = \pard\brdrt\brdrs\brdrw10\brsp\par;
5229      +
5230      +    data _null_;
5231      +    space = floor(&ls/2 - length("&draft")/2);
5232      +    space2 = space - length("&section");
112                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5233      +    call symput("tl1",trim("&section") || repeat(' ',space2) || trim("&draft") || repeat(' ',&ls));
5234      +    call symput("tl2","" || repeat(' ',&ls));
5235      +    space = &ls - length("&file") - length("&dtstamp") - 1;
5236      +    call symput("ft99",trim("&file") || repeat(' ',space) || trim("&dtstamp"));
5237      +    run;
5238      +
5239      +
5240      +ods rtf  style=style1 file="&drnoc./&runid._pmp1_report.rtf"  startpage = no notoc_data;
5241      +
5242      +	ODS ESCAPECHAR='^';
5243      +/********************/
5244      +/* TABLE OF CONTENT */
5245      +/********************/
5246      +
5247      +	*list and and count the number of unique groups;
5248      +	data _groups;
5249      +	set infolder.&QUERYFILE.;
5250      +	keep group;
5251      +	run;
5252      +	proc sort nodupkey;
5253      +	by group;
5254      +	run;
5255      +	%put &GROUPVECT;
5256      +	proc sql noprint;
5257      +		select Group
5258      +	   	into :GROUPS separated by ' '
5259      +	   	from _groups;
5260      +	quit;
5261      +	proc sql noprint;
5262      +		select count(distinct Group)
5263      +	   	into :NGROUPS
5264      +	   	from _groups;
5265      +	quit;
5266      +	%put &GROUPS. &NGROUPS.;
5267      +
5268      +	*total number of clusters of 4 groups;
5269      +	data _null;
5270      +	NumPageCharacteritics=ceil(&ngroups./4);
5271      +	call symput("NumPageChar",put(NumPageCharacteritics,best.));
5272      +	run;
5273      +	%put &NumPageChar.;
5274      +
5275      +    ods rtf prepage = '^S={LEFTMARGIN=0in just=c font_weight=bold}Table of Contents';
5276      +	data _toc;
5277      +	format val $50.;
5278      +%if %UPCASE("&ATTRITIONTABLE.") eq %STR("N") %then %do;
5279      +	section="1";val="Query Overview";pg=2;pgc=strip(put(pg,best.));output;
5280      +	/*section="2";val="Attrition Table";pg=pg+1;pgc=strip(put(pg,best.));output;*/
113                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5281      +	section="2";val="Patient Counts by Characteristics";pg=pg+1/*+&ngroups.*/;pgc=strip(put(pg,best.));output;
5282      +	section="3";val="Base Population Characteristics";pg=pg+&NumPageChar.;pgc=strip(put(pg,best.));output;
5283      +	section="4";val="Glossary of PCORnet Modular Program 1 (PMP1) Terms";pg=pg+1;pgc=strip(put(pg,best.));output;
5284      +	run;
5285      +%end;
5286      +%else %do;
5287      +	section="1";val="Query Overview";pg=2;pgc=strip(put(pg,best.));output;
5288      +	section="2";val="Attrition Table";pg=pg+1;pgc=strip(put(pg,best.));output;
5289      +	section="3";val="Patient Counts by Characteristics";pg=pg+&ngroups.;pgc=strip(put(pg,best.));output;
5290      +	section="4";val="Base Population Characteristics";pg=pg+&NumPageChar.;pgc=strip(put(pg,best.));output;
5291      +	section="5";val="Glossary of PCORnet Modular Program 1 (PMP1) Terms";pg=pg+1;pgc=strip(put(pg,best.));output;
5292      +	run;	
5293      +%end;
5294      +
5295      +    %let section="^S={just=l font_weight=bold}PCORnet Modular Program 1 (PMP1): [&RequestName.  &QueryName.]";
5296      +
5297      +	PROC REPORT DATA=_toc NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=75%  rules=groups frame=below };
5298      +	column (("^S={just=c font_weight=bold}Section" section)
5299      +            ("^S={just=l font_weight=bold}Topic" val)
5300      +			("^S={just=c font_weight=bold}Page #" pgc)
5301      +	);
5302      +
5303      +	    DEFINE section / display WIDTH=20 FLOW " " STYLE(COLUMN)=[CELLWIDTH=5%  just=c VJUST=TOP];
5304      +	    DEFINE val     / display WIDTH=20 FLOW " " STYLE(COLUMN)=[CELLWIDTH=15% just=l VJUST=TOP];
5305      +	    DEFINE pgc     / display WIDTH=20 FLOW " " STYLE(COLUMN)=[CELLWIDTH=5%  just=c VJUST=TOP];
5306      +
5307      +		compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
5308      +			line ' ';
5309      +		endcomp;
5310      +
5311      +	    title1 j=l &section. j=c "&draft" j=r "&rtfcommand";
5312      +		title2 j=l "&tl2";
5313      +		title3 j=l " ";
5314      +		title4 j=l " ";
5315      +
5316      +		footnote10 "&ft99";
5317      +
5318      +	run;
5319      +
5320      +/***********************************/
5321      +/* Query Overview and Table Counts */
5322      +/***********************************/
5323      +
5324      +     %let section='^S={just=l font_weight=bold}Section 1: Query Overview';
5325      +	 ods rtf startpage=yes;
5326      +
5327      +	*convert Race to their CDM values;
5328      +	data _null;
114                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5329      +	format formattedRace $200.;
5330      +	formattedRace=compress("&RACE.", "'");
5331      +	formattedRace=translate(strip(formattedRace), "," , " ");
5332      +	formattedRace = tranwrd(formattedRace, '01',' American Indian or Alaska Native');
5333      +	formattedRace = tranwrd(formattedRace, '02',' Asian');
5334      +	formattedRace = tranwrd(formattedRace, '03',' Black or African American');
5335      +	formattedRace = tranwrd(formattedRace, '04',' Native Hawaiian or Other Pacific Islander');
5336      +	formattedRace = tranwrd(formattedRace, '05',' White');
5337      +	formattedRace = tranwrd(formattedRace, '06',' Multiple race');
5338      +	formattedRace = tranwrd(formattedRace, '07',' Refuse to answer');
5339      +	formattedRace = tranwrd(formattedRace, 'NI',' No information');
5340      +	formattedRace = tranwrd(formattedRace, 'UN',' Unknown');
5341      +	formattedRace = tranwrd(formattedRace, 'OT',' Other');
5342      +	call symputx("RACEFORMATTED",strip(formattedRace));
5343      +
5344      +	formattedSEX=compress("&SEX.", "'");
5345      +	formattedSEX=translate(strip(formattedSEX), "," , " ");
5346      +	call symputx("SEXFORMATTED",strip(formattedSEX));
5347      +
5348      +	formattedHispanic=compress("&HISPANIC.", "'");
5349      +	formattedHispanic=translate(strip(formattedHispanic), "," , " ");
5350      +	call symputx("HISPFORMATTED",strip(formattedHispanic));
5351      +
5352      +	run;
5353      +
5354      +	*Determine threshold category;
5355      +	%let THRESHOLDCAT=?;
5356      +	%macro createThreshOldCat();
5357      +		%if %eval(&THRESHOLD.=0) %then %do;
5358      +			%let THRESHOLDCAT=0;
5359      +		%end;
5360      +		%if %eval(0<&THRESHOLD. & &THRESHOLD.<11) %then %do;
5361      +			%let THRESHOLDCAT=1-10;
5362      +		%end;
5363      +		%if %eval(10<&THRESHOLD. & &THRESHOLD.<21) %then %do;
5364      +			%let THRESHOLDCAT=11-20;
5365      +		%end;
5366      +		%if %eval(21<&THRESHOLD. & &THRESHOLD.<50) %then %do;
5367      +			%let THRESHOLDCAT=21-50;
5368      +		%end;
5369      +		%if %eval(51<&THRESHOLD. & &THRESHOLD.<100) %then %do;
5370      +			%let THRESHOLDCAT=51-100;
5371      +		%end;
5372      +		%if %eval(&THRESHOLD.>100) %then %do;
5373      +			%let THRESHOLDCAT=100+;
5374      +		%end;
5375      +	%mend createThreshOldCat;
5376      +	%createThreshOldCat();
115                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5377      +
5378      +	%put &THRESHOLDCAT.;
5379      +
5380      +	data _summary;
5381      +	format item $22. col1 $400. col2 $1.;
5382      +	col2=" ";
5383      +	item="Query Period";col1="&QUERYFROMc.-&QUERYTOc.";output;
5384      +	item="Enrollment Requirement";col1="&ENROPTION.";output;
5385      +	item="Age Group";col1="&AGESTRAT.";output;
5386      +	item="Age Calculation";col1="&AGECALC.";output;
5387      +	item="Sex";col1="&SEXFORMATTED., XX";output;
5388      +	item="Race";col1="&RACEFORMATTED., XX";output;
5389      +	item="Hispanic";col1="&HISPFORMATTED., XX";output;
5390      +	item="Low-Cell Count Masking";col1="&THRESHOLDCAT.";output;
5391      +	run;
5392      +
5393      +	PROC REPORT DATA=_summary NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=100% just=l rules=groups frame=below }
5393     !+;
5394      +	column ((" " item)
5395      +			(" " col2)
5396      +			(" " col1)
5397      +	);
5398      +
5399      +	    DEFINE item / right display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=15% VJUST=TOP];
5400      +	    DEFINE col2 / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=1% VJUST=TOP];
5401      +	    DEFINE col1 / left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=50%  VJUST=TOP];
5402      +
5403      +	    title1 j=l &section. j=c "&draft" j=r "&rtfcommand";
5404      +		title2 j=l "&tl2";
5405      +		title3 j=l " ";
5406      +		title4 j=l " ";
5407      +
5408      +		footnote10 "&ft99";
5409      +
5410      +	run;
5411      +
5412      +/*	ODS TEXT='';
5413      +	ODS TEXT='';*/
5414      +*		ods rtf startpage=no;
5415      +/*********************************/
5416      +/* Create the table Count Report */
5417      +/*********************************/
5418      +	*Squaring of table;
5419      +	data _square;
5420      +	format table $20.;
5421      +	seq=1;table="Demographic";output;
5422      +	seq=2;table="Diagnosis";output;
5423      +	seq=3;table="Encounter";output;
116                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5424      +	seq=4;table="Procedure";output;
5425      +	seq=5;table="Vitals";output;
5426      +	seq=6;table="Prescribing";output;
5427      +	seq=7;table="Dispensing";output;
5428      +	seq=8;table="Labs";output;
5429      +	seq=9;table="Death";output;
5430      +	run;
5431      +
5432      +	data _combine;
5433      +	merge _square drnoc.&REQUESTID.&RUNID._tablecount(in=a where=(_NAME_="AllData"));
5434      +	by seq;
5435      +	format AllPatidc distinctPatidc allEncounterIdc distinctEncounterIdc rowc $15.;
5436      +
5437      +	AllPatidc = strip(put(AllPatid,comma10.0));
5438      +	distinctPatidc = strip(put(distinctPatid,comma10.0));
5439      +	allEncounterIdc = strip(put(allEncounterId,comma10.0));
5440      +	distinctEncounterIdc = strip(put(distinctEncounterId,comma10.0));
5441      +	rowc = strip(put(row,comma10.0));
5442      +
5443      +	if seq in (1,7) then do;allEncounterIdc="NA";distinctEncounterIdc="NA";end;
5444      +	run;
5445      +
5446      +	 ods rtf startpage=no;
5447      +
5448      +	ODS TEXT='  ';
5449      +	ODS TEXT='  ';
5450      +	ODS TEXT='^S={just=l font_weight=bold}Counts from Tables:';
5451      +
5452      +
5453      +
5454      +	PROC REPORT DATA=_combine NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=100% rules=groups frame=below };
5455      +	column (("^S={just=l font_weight=bold}Table" table)
5456      +			("^S={just=c font_weight=bold}All Patient ID" AllPatidc)
5457      +	        ("^S={just=c font_weight=bold}Distinct Patient ID" distinctPatidc)
5458      +	        ("^S={just=c font_weight=bold}All Encounter ID" allEncounterIdc)
5459      +	        ("^S={just=c font_weight=bold}Distinct Encounter ID" distinctEncounterIdc)
5460      +	        ("^S={just=c font_weight=bold}Rows" rowc)
5461      +	);
5462      +
5463      +
5464      +	    DEFINE table                / left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=10%  VJUST=TOP];
5465      +	    DEFINE AllPatidc            / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=17%  VJUST=TOP];
5466      +	    DEFINE distinctPatidc       / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=17%  VJUST=TOP];
5467      +	    DEFINE allEncounterIdc      / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=17%  VJUST=TOP];
5468      +	    DEFINE distinctEncounterIdc / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=18%  VJUST=TOP];
5469      +	    DEFINE rowc                 / center display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=17%  VJUST=TOP];
5470      +
5471      +		compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
117                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5472      +			line ' ';
5473      +		endcomp;
5474      +
5475      +	    title1 j=l &section j=c "&draft" j=r "&rtfcommand";
5476      +		title2 j=l "&tl2";
5477      +		title3 j=l " ";
5478      +		title4 j=l " ";
5479      +
5480      +		footnote10 "&ft99";
5481      +
5482      +	run;
5483      +/*
5484      +	 ods rtf startpage=yes;
5485      +*/
5486      +/***************************/
5487      +/* Create Attrition Report */
5488      +/***************************/
5489      +%if %UPCASE("&ATTRITIONTABLE.") eq %STR("Y") %then %do;
5490      +	%let section='^S={just=l font_weight=bold}Section 2: Attrition Table';
5491      +
5492      +	%macro ByGroupAttrition;
5493      +	%do i=1 %to &NGROUPS.;
5494      +
5495      +		data _forReport;
5496      +		set drnoc.&REQUESTID.&RUNID._attritiontable;
5497      +		where group="%scan(&GROUPS.,&i.)";
5498      +		CritDesc=compbl(compress(CritDesc,,"h"));
5499      +		CritNum2=strip(put(CritNum,best.));
5500      +		gr=_N_;
5501      +		Remainingc = strip(put(Remaining,comma10.0));
5502      +		Excludedc = strip(put(Excluded,comma10.0));
5503      +		rename Group = StudyGroup;
5504      +		keep Group CritNum: CritDesc Remaining: Excluded: gr;
5505      +		run;
5506      +
5507      +		ods rtf startpage=now;
5508      +
5509      +		PROC REPORT DATA=_forReport NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=95% rules=groups frame=below };
5510      +		column (gr ("^S={just=l font_weight=bold}Prevalent Event of Interest" StudyGroup)
5511      +		        ("^S={font_weight=bold}Order of Exclusions" CritNum2)
5512      +		        ("^S={font_weight=bold}Criteria" CritDesc)
5513      +		        ("^S={font_weight=bold}Remaining Patient Counts" Remainingc)
5514      +		        ("^S={font_weight=bold}Excluded Patient Counts" Excludedc)
5515      +		);
5516      +
5517      +			DEFINE gr/group "" noprint;
5518      +		    DEFINE StudyGroup / LEFT display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=15% VJUST=TOP];
5519      +		    DEFINE CritNum2 / center display WIDTH=10 FLOW " " STYLE(COLUMN)=[CELLWIDTH=10%  JUST=center  VJUST=TOP];
118                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5520      +		    DEFINE CritDesc / left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=25%  VJUST=TOP];
5521      +		    DEFINE Remainingc / center display WIDTH=10 FLOW " " STYLE(COLUMN)=[CELLWIDTH=10% JUST=Center VJUST=TOP];
5522      +		    DEFINE Excludedc / center display WIDTH=10 FLOW " " STYLE(COLUMN)=[CELLWIDTH=10%  JUST=Center VJUST=TOP];
5523      +
5524      +			compute after gr;
5525      +				line ' ';
5526      +			endcomp;
5527      +
5528      +	*break after gr /page;
5529      +
5530      +			compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
5531      +				line ' ';
5532      +			    line "&s1.A value of 'T' (Threshold)  indicates a masked count below the Network Partner's required threshold.";
5533      +
5534      +			endcomp;
5535      +
5536      +		    title1 j=l &section j=c "&draft" j=r "&rtfcommand";
5537      +			title2 j=l "&tl2";
5538      +			title3 j=l " ";
5539      +			title4 j=l " ";
5540      +			footnote10 "&ft99";
5541      +
5542      +		run;
5543      +	%end;
5544      +	%mend;
5545      +	%ByGroupAttrition;
5546      +%end;
5547      +
5548      +/*********************************************************/
5549      +/* Create squared empty table  based on input parameters */
5550      +/*********************************************************/
5551      +
5552      +	*overall;
5553      +	data _overall;
5554      +	format cat $45.;
5555      +	catnum=0;
5556      +	cat="";
5557      +	i=1;
5558      +	output;
5559      +	run;
5560      +
5561      +	*AgeGroup;
5562      +	%macro AgeGroup;
5563      +		%IF %STR("&AGESTRAT.")=%STR("") %THEN %DO;
5564      +			%LET AGESTRAT=00-01 02-04 05-09 10-14 15-18 19-21 22-44 45-64 65-74 75+;
5565      +		%END;
5566      +
5567      +		data _AgeGroup;
119                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5568      +		format cat $45.;
5569      +		catnum=1;
5570      +		do i=1 to &NUMAGECAT.;
5571      +		    cat = scan("&AGESTRAT.",i,' ');
5572      +			output;
5573      +		end;
5574      +		run;
5575      +	%mend;
5576      +	%AgeGroup;
5577      +
5578      +	*sex;
5579      +	data _sex;
5580      +	format cat $45.;
5581      +	catnum=2;
5582      +	numwords=countw(compress("&SEX.","'")," ");
5583      +	do i=1 to numwords;
5584      +		cat=scan(compress("&SEX.","'"),i,' ');
5585      +	output;
5586      +	end;
5587      +	cat="XX";output;
5588      +	run;
5589      +
5590      +
5591      +	*race;
5592      +	data _race;
5593      +	format cat $45.;
5594      +	catnum=3;
5595      +	numwords=countw(compress("&RACE.","'")," ");
5596      +	do i=1 to numwords;
5597      +		cat=scan(compress("&RACE.","'"),i,' ');
5598      +	output;
5599      +	end;
5600      +	cat="XX";output;
5601      +	run;
5602      +
5603      +	*hispanic;
5604      +	data _hispanic;
5605      +	format cat $45.;
5606      +	catnum=4;
5607      +	numwords=countw(compress("&HISPANIC.","'")," ");
5608      +	do i=1 to numwords;
5609      +		cat=scan(compress("&HISPANIC.","'"),i,' ');
5610      +	output;
5611      +	end;
5612      +	cat="XX";output;
5613      +	run;
5614      +
5615      +	data _square0;
120                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5616      +	set _overall
5617      +        _AgeGroup(in=a)
5618      +	    _sex(in=b)
5619      +	    _race(in=c)
5620      +	    _hispanic(in=d);
5621      +	if a then i=i+100;
5622      +	if b then i=i+200;
5623      +	if c then i=i+300;
5624      +	if d then i=i+400;
5625      +	rename i=forsort;
5626      +	drop numwords;
5627      +	run;
5628      +
5629      +	proc sql noprint;
5630      +	create table _square as
5631      +    select a.*,
5632      +	       b.*
5633      +	from _groups as a,
5634      +	     _square0 as b
5635      +	Order by group,forsort;
5636      +	quit;
5637      +
5638      +/**************************************/
5639      +/* Create Report Patient Cts by Char. */
5640      +/**************************************/
5641      +
5642      +	data _NumIntForReport;
5643      +	set  DRNOC.&REQUESTID.&RUNID._NumTab0;
5644      +	format cat $45.;
5645      +	*192 = Overall,
5646      +	 196 = AgeGroup
5647      +	 200 = Hispanic
5648      +	 208 = Race
5649      +	 224 = sex;
5650      +	where Incident and seg in(192,196,200,208,224);
5651      +	if seg=192 then catnum=0;
5652      +	if seg=196 then catnum=1;
5653      +	if seg=224 then catnum=2;
5654      +	if seg=208 then catnum=3;
5655      +	if seg=200 then catnum=4;
5656      +	cat=coalescec(AgeGroup,Hispanic,Race,sex);
5657      +	if Sex not in (&SEX. 'XX') then Sex="XX";
5658      +	if Hispanic not in (&HISPANIC. 'XX') then Hispanic="XX";
5659      +	if Race not in (&RACE. 'XX') then Race="XX";
5660      +	keep group cat catnum Npts;
5661      +	run;
5662      +
5663      +	*defensive coding (aggregate into XX);
121                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5664      +	proc means data=_NumIntForReport nway noprint missing;
5665      +	var Npts;
5666      +	class group cat catnum;
5667      +	output out=_NumIntForReport2(drop=_:) sum=;
5668      +	run;
5669      +
5670      +	*set the .T again when missing;
5671      +	data _NumIntForReport;
5672      +	set _NumIntForReport;
5673      +	if missing(Npts) then Npts=.T;
5674      +	run;
5675      +
5676      +	*create table;
5677      +	proc sql noprint;
5678      +	create table _numReport as
5679      +	select a.*,
5680      +		   b.Npts
5681      +	from _square as a left join
5682      + 	     _NumIntForReport as b
5683      +	on a.group = b.group and
5684      +       a.cat = b.cat and
5685      +	   a.catnum = b.catnum
5686      +    Order by group, forsort;
5687      +	quit;
5688      +
5689      +
5690      +options nosymbolgen nomprint;
5691      +
5692      +	data _postAdjustnumReport;
5693      +	set _numReport;
5694      +	by group catnum;
5695      +	format NPTSc $13.;
5696      +	if npts = . and npts ne .T then npts=0;
5697      +	if 0 < npts < &THRESHOLD. then npts = .T;
5698      +
5699      +	NPTSc=strip(put(npts,comma10.0));
5700      +	if catnum=0 then cat="Overall (N)";
5701      +	if catnum=1 then cat="  "||cat;
5702      +	if catnum=2 then do;
5703      +		if cat="A" then cat="  Ambiguous";
5704      +		if cat="F" then cat="  Female";
5705      +		if cat="M" then cat="  Male";
5706      +		if cat="XX" then cat="  Other/Missing";
5707      +	end;
5708      +	if catnum=3 then do;
5709      +		if cat="01" then cat="  American Indian or Alaska Native";
5710      +		if cat="02" then cat="  Asian";
5711      +		if cat="03" then cat="  Black or African American";
122                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5712      +		if cat="04" then cat="  Native Hawaiian or Other Pacific Islander";
5713      +		if cat="05" then cat="  White";
5714      +		if cat="06" then cat="  Multiple race";
5715      +		if cat="07" then cat="  Refuse to answer";
5716      +		if cat="UN" then cat="  Unknown";
5717      +		if cat="OT" then cat="  Other";
5718      +		if cat="NI" then cat="  No information";
5719      +		if cat="XX" then cat="  Other/Missing";
5720      +	end;
5721      +	if catnum=4 then do;
5722      +		if cat="Y" then cat="  Yes";
5723      +		if cat="N" then cat="  No";
5724      +		if cat="R" then cat="  Refuse to answer";
5725      +		if cat="UN" then cat="  Unknown";
5726      +		if cat="OT" then cat="  Other";
5727      +		if cat="NI" then cat="  No information";
5728      +		if cat="XX" then cat="  Other/Missing";
5729      +	end;	
5730      +	output;
5731      +	if last.catnum and catnum=0 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Age Group&s2.";output;end;
5732      +	if last.catnum and catnum=1 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Sex&s2.";      output;end;
5733      +	if last.catnum and catnum=2 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Race&s2.";     output;end;
5734      +	if last.catnum and catnum=3 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Hispanic&s2."; output;end;
5735      +	run;
5736      +
5737      +	*Creating new ForSort;
5738      +	data _postAdjustnumReport;
5739      +	set _postAdjustnumReport;
5740      +	by group;
5741      +	if first.group then row=0;
5742      +	row=row+1;
5743      +	retain row;
5744      +	run;
5745      +
5746      +options symbolgen mprint;
5747      +
5748      +	%let section='^S={just=l font_weight=bold}Section 2: Patient Counts by Characteristics';
5749      +
5750      +
5751      +	*number of times table needs to be created;
5752      +	%macro  ColHeaders;
5753      +
5754      +	%let pg=1;
5755      +	%do pg=0 %to &NumPageChar.-1;
5756      +
5757      +		data _null_;
5758      +		call symputx("to", min(4,&ngroups.-&pg.*4));
5759      +		run;
123                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5760      +		%put &to.;
5761      +
5762      +		*load group names;
5763      +		%do i=1 %to &to.;
5764      +		%global Col&i.;
5765      +		%let Col&i.=%scan(%quote(&GROUPVECT),&i+&pg.*4,',');
5766      +		%end;
5767      +
5768      +		data _combine;
5769      +		merge %do i=1 %to &to.;
5770      +			  _postAdjustnumReport(rename=Nptsc=col&i. where=(group="%scan(%quote(&GROUPVECT),&i+(&pg.*4),',')"))	
5771      +		      %end;;
5772      +		by row;* forsort;
5773      +		run;
5774      +
5775      +		ods rtf style=style1  startpage = now;
5776      +
5777      +		PROC REPORT DATA=_combine NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=100% rules=groups frame=below };
5778      +		column (("^S={just=l font_weight=bold}Patient Counts by Characteristics&s1." cat)
5779      +				%do i=1 %to &to.;("^S={font_weight=bold}&&col&i.." Col&i.) %end;
5780      +		);
5781      +
5782      +		    DEFINE cat /  left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=25%  JUST=l VJUST=TOP];
5783      +		    %do i=1 %to &to.;DEFINE col&i. / left display WIDTH=13 FLOW " " STYLE(COLUMN)=[CELLWIDTH=10% JUST=center   VJUST=TOP]
5783     !+/*FORMAT=comma10.0*/;  %end;
5784      +
5785      +			compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
5786      +				line ' ';
5787      +				line "&s1.Counts are patients with any of the listed codes (included in query package) for a health event of interest during the
5787     !+specified query period. These counts should not be interpreted as epidemiological estimates of the listed events, but instead are
5787     !+reflective of the distinct number of patients with a defined event of interest during the specified query period.  Coding procedures may
5787     !+vary from site to site. Duplicate data may exist. The period of time during which data were available may vary between Network Partners.";
5788      +				line "&s2.Some stratified counts may not equal the total N counts because of low cell count masking.";
5789      +			    line "&s3.A value of 'T' (Threshold)  indicates a masked count below the Network Partner's required threshold.";
5790      +			endcomp;
5791      +
5792      +		    title1 j=l &section. j=c "&draft" j=r "&rtfcommand";
5793      +			title2 j=l "&tl2";
5794      +			title3 j=l " ";
5795      +			title4 j=l " ";
5796      +			footnote10 "&ft99";
5797      +		run;
5798      +
5799      +	%end;
5800      +	%mend;
5801      +	%ColHeaders;
5802      +
5803      +	ods rtf style=style1  startpage = now;
124                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5804      +
5805      +
5806      +/***************************************/
5807      +/* Create Report Base Population Char. */
5808      +/***************************************/
5809      +
5810      +	%macro baseAge;
5811      +	data _Denomintforreport;
5812      +	set Denomintforreport;
5813      +		%if %UPCASE("&AGECALC.") eq %STR("F") %then %do;
5814      +			if &MINAGE. <= QToAge <= &MAXAGE.;
5815      +		%end;
5816      +	    format AgeGroup $9.;
5817      +	    AgeGroup = scan("&AGESTRAT.",QToAgeGroup,' ');
5818      +
5819      +		if Sex not in (&SEX. 'XX') then Sex="XX";
5820      +		if Hispanic not in (&HISPANIC. 'XX') then Hispanic="XX";
5821      +		if Race not in (&RACE. 'XX') then Race="XX";
5822      +
5823      +	one=1;
5824      +	keep  one AgeGroup race sex hispanic;
5825      +	run;
5826      +	%mend;
5827      +	%baseAge;
5828      +
5829      +	*defensive coding;
5830      +	proc means data=_Denomintforreport noprint;
5831      +	var one;
5832      +	output out=_DenomNpts(drop=_:) sum=Npts;
5833      +	run;
5834      +	proc means data=_Denomintforreport nway noprint missing;
5835      +	var one;
5836      +	class AgeGroup;
5837      +	output out=_DenomAgeGroup(drop=_:) sum=Npts;
5838      +	run;
5839      +	proc means data=_Denomintforreport nway noprint missing;
5840      +	var one;
5841      +	class race;
5842      +	output out=_Denomrace(drop=_:) sum=Npts;
5843      +	run;
5844      +	proc means data=_Denomintforreport nway noprint missing;
5845      +	var one;
5846      +	class sex;
5847      +	output out=_Denomsex(drop=_:) sum=Npts;
5848      +	run;
5849      +	proc means data=_Denomintforreport nway noprint missing;
5850      +	var one;
5851      +	class hispanic;
125                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5852      +	output out=_Denomhispanic(drop=_:) sum=Npts;
5853      +	run;
5854      +
5855      +	data _DenomIntForReport;
5856      +	set _DenomNpts(in=a)
5857      +	    _DenomAgeGroup(in=b)
5858      +	    _Denomsex(in=c)
5859      +	    _Denomrace(in=d)
5860      +	    _Denomhispanic(in=e);
5861      +		if a then catnum=0;
5862      +		if b then catnum=1;
5863      +		if c then catnum=2;
5864      +		if d then catnum=3;
5865      +		if e then catnum=4;
5866      +		cat=coalescec(AgeGroup,Hispanic,Race,sex);
5867      +		*keep group cat catnum Npts;
5868      +	run;
5869      +
5870      +	*create table;
5871      +	proc sql noprint;
5872      +	create table _DenomReport as
5873      +	select a.*,
5874      +		   b.Npts
5875      +	from _square0 as a left join
5876      + 	     _DenomIntForReport as b
5877      +	on a.cat = b.cat and
5878      +	   a.catnum = b.catnum
5879      +    Order by forsort;
5880      +	quit;
5881      +
5882      +options nosymbolgen nomprint;
5883      +
5884      +	data _postAdjustDenomReport;
5885      +	set _DenomReport;
5886      +	by catnum;
5887      +	format NPTSc $13.;
5888      +	if npts = . then npts=0;
5889      +	if 0 < npts < &THRESHOLD. then npts = .T;
5890      +
5891      +	NPTSc=strip(put(npts,comma10.0));
5892      +	if catnum=0 then cat="Overall (N)";
5893      +	if catnum=1 then cat="  "||cat;
5894      +
5895      +	if catnum=2 then do;
5896      +		if cat="A" then cat="  Ambiguous";
5897      +		if cat="F" then cat="  Female";
5898      +		if cat="M" then cat="  Male";
5899      +		if cat="XX" then cat="  Other/Missing";
126                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5900      +	end;
5901      +	if catnum=3 then do;
5902      +		if cat="01" then cat="  American Indian or Alaska Native";
5903      +		if cat="02" then cat="  Asian";
5904      +		if cat="03" then cat="  Black or African American";
5905      +		if cat="04" then cat="  Native Hawaiian or Other Pacific Islander";
5906      +		if cat="05" then cat="  White";
5907      +		if cat="06" then cat="  Multiple race";
5908      +		if cat="07" then cat="  Refuse to answer";
5909      +		if cat="UN" then cat="  Unknown";
5910      +		if cat="OT" then cat="  Other";
5911      +		if cat="NI" then cat="  No information";
5912      +		if cat="XX" then cat="  Other/Missing";
5913      +	end;
5914      +	if catnum=4 then do;
5915      +		if cat="Y" then cat="  Yes";
5916      +		if cat="N" then cat="  No";
5917      +		if cat="R" then cat="  Refuse to answer";
5918      +		if cat="UN" then cat="  Unknown";
5919      +		if cat="OT" then cat="  Other";
5920      +		if cat="NI" then cat="  No information";
5921      +		if cat="XX" then cat="  Other/Missing";
5922      +	end;
5923      +
5924      +	output;
5925      +	if last.catnum and catnum=0 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Age Group&s2.";output;end;
5926      +	if last.catnum and catnum=1 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Sex&s2.";      output;end;
5927      +	if last.catnum and catnum=2 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Race&s2.";     output;end;
5928      +	if last.catnum and catnum=3 then do;cat="";call missing(NPTs,NPTSc);output;cat="By Hispanic&s2."; output;end;
5929      +	run;
5930      +options symbolgen mprint;
5931      +
5932      +	%let section='^S={just=l font_weight=bold}Section 3: Base Population Characteristics';
5933      +
5934      +	PROC REPORT DATA=_postAdjustDenomReport NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=60% rules=groups
5934     !+frame=below };
5935      +	column (("^S={just=l font_weight=bold}Base Population Characteristics&s1." cat)
5936      +			("^S={font_weight=bold}&DMID&SITEID" Nptsc)
5937      +	);
5938      +
5939      +	    DEFINE cat /  left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=25% JUST=l VJUST=TOP];
5940      +	    DEFINE Nptsc / left display WIDTH=13 FLOW " " STYLE(COLUMN)=[CELLWIDTH=15% JUST=center   VJUST=TOP]  /*FORMAT=comma10.0*/;
5941      +
5942      +		compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
5943      +			line ' ';
5944      +			line "&s1.The base population is defined by the enrollment definition: &ENROPTION.; See glossary.";
5945      +			line "&s2.Some stratified counts may not equal the total N counts because of low cell count masking.";
5946      +			line "&s3.A value of 'T' (Threshold)  indicates a masked count below the Network Partner's required threshold.";
127                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5947      +		endcomp;
5948      +
5949      +
5950      +	    title1 j=l &section j=c "&draft" j=r "&rtfcommand";
5951      +		title2 j=l "&tl2";
5952      +		title3 j=l " ";
5953      +		title4 j=l " ";
5954      +		footnote10 "&ft99";
5955      +
5956      +RUN;
5957      +
5958      + ods rtf startpage=now;
5959      +
5960      +/************/
5961      +/* Glossary */
5962      +/************/
5963      +
5964      +	%let section='^S={just=l font_weight=bold}Section 4: Glossary of  PCORnet Modular Program 1 (PMP1) Terms';
5965      +
5966      +	data _null_;
5967      +	temp="&EB2ENCLIST.";
5968      +	call symputx('EB2ENCLISTFMT',TRANWRD(temp,' ', ' or '));
5969      +	run;
5970      +
5971      +	data glossary;
5972      +	format line $4000.;
5973      +	line="^S={font_weight=bold}Query Period: ^S={font_weight=medium}the time range from the start of the query identification period to the
5973     !+end of the query identification period. Format expressed as mm/dd/yyyy.";output;line="";output;
5974      +	line="^S={font_weight=bold}Enrollment Requirement: ^S={font_weight=medium}indicated to PMP1 which table (encounter vs. enrollment) to use
5974     !+for enrollment and the specific criteria involved. The following are viable values:";output;
5975      +%if %str("&ENROPTION.") = %str("EB1") %then %do;line="^S={font_weight=bold LEFTMARGIN=0.25in }EB1= ^S={font_weight=medium}Patients must
5975     !+have at least 1 encounter in the query period to meet enrollment criteria.";output;%end;
5976      +%if %str("&ENROPTION.") = %str("EB2") %then %do;line="^S={font_weight=bold LEFTMARGIN=0.25in }EB2= ^S={font_weight=medium}Patients must
5976     !+have at least &EB2ENCNUMS. &EB2ENCLISTFMT. encounters within the query period and &EB2DAYS. days between first and last encounter to meet
5976     !+enrollment criteria.";output;%end;line="";output;
5977      +	line="^S={font_weight=bold}Age Group: ^S={font_weight=medium}age categories for reporting. This parameter set in the 'master.sas' file (1)
5977     !+ restricted the cohort of interest to certain age groups and (2) specified how age groups were stratified in the result tables. ";output;
5977     !+line="";output;
5978      +	line="^S={font_weight=bold}Sex: ^S={font_weight=medium}sex categories for reporting. This parameter set in the 'master.sas' file specified
5978     !+ how sex categories were stratified in the result tables. The 'xx' category describes all sex categories that were not specified in the
5978     !+'Master.sas' file and subsequently bucketed into a single group. The following are viable values:";output;
5979      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}A=^S={font_weight=medium}Ambiguous";output;
5980      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}F=^S={font_weight=medium}Female";output;
5981      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}M=^S={font_weight=medium}Male";output;
5982      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}NI=^S={font_weight=medium}No Information";output;
5983      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}UN=^S={font_weight=medium}Unknown";output;
5984      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}OT=^S={font_weight=medium}Other";output;line="";output;
5985      +	line="^S={font_weight=bold}Race: ^S={font_weight=medium}race categories for reporting. This parameter set in the 'master.sas' file
128                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

5985     !+specified how race categories were stratified in the result tables. The 'xx' category describes all race categories that were not specified
5985     !+ in the 'master.sas' file and subsequently bucketed into a single group. The following are viable values:";output;
5986      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}01=^S={font_weight=medium}American Indian or Alaska Native";output;
5987      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}02=^S={font_weight=medium}Asian";output;
5988      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}03=^S={font_weight=medium}Black or African American ";output;
5989      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}04=^S={font_weight=medium}Native Hawaiian or Other Pacific Islander";output;
5990      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}05=^S={font_weight=medium}White";output;
5991      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}06=^S={font_weight=medium}Multiple Race";output;
5992      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}07=^S={font_weight=medium}Refuse to answer";output;
5993      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}NI=^S={font_weight=medium}No Information";output;
5994      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}UN=^S={font_weight=medium}Unknown";output;
5995      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}OT=^S={font_weight=medium}Other";output;line="";output;
5996      +	line="^S={font_weight=bold}Hispanic: ^S={font_weight=medium}Hispanic categories for reporting. This parameter set in the 'master.sas' file
5996     !+ specified how Hispanic categories were stratified in the result tables. The 'xx' category describes all Hispanic categories that were not
5996     !+specified in the 'master.sas' file and subsequently bucketed into a single group. The following are viable values:";output;
5997      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}Y=^S={font_weight=medium}Yes";output;
5998      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}N=^S={font_weight=medium}No";output;
5999      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}R=^S={font_weight=medium}Refuse to answer";output;
6000      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}NI=^S={font_weight=medium}No Information";output;
6001      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}UN=^S={font_weight=medium}Unknown";output;
6002      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}OT=^S={font_weight=medium}Other";output;line="";output;
6003      +	line="^S={font_weight=bold}Age Calculation: ^S={font_weight=medium}method by which age was calculated.";output;
6004      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}F=^S={font_weight=medium}Fixed, age groups were calculated using the end of the query period"
6004     !+;output;
6005      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}I=^S={font_weight=medium}Index, age groups were calculated using the index date of exposure";
6005     !+output;line="";output;
6006      +	line="^S={font_weight=bold}Low-Cell Count Masking: ^S={font_weight=medium}Level by which the threshold value applied (set in the
6006     !+Master.sas file) fell under.";output;
6007      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}0";output;
6008      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}01-10";output;
6009      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}11-20";output;
6010      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}21-50";output;
6011      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}51-100";output;
6012      +	line="^S={font_weight=bold LEFTMARGIN=0.25in}100+";output;line="";output;
6013      +	run;
6014      +
6015      +	PROC REPORT DATA=glossary NOWD HEADSKIP HEADLINE MISSING SPLIT = '~' SPACING=1 style(report)={width=100% rules=groups frame=below };
6016      +	column (("^S={font_weight=bold JUST=l}Glossary Terms" line)
6017      +	);
6018      +
6019      +	    DEFINE line /  left display WIDTH=47 FLOW " " STYLE(COLUMN)=[CELLWIDTH=100% JUST=l VJUST=TOP];
6020      +
6021      +		compute after/style=[just=l bordertopcolor=black bordertopwidth=1];
6022      +			line "*all terms may not be used in this report";
6023      +		endcomp;
6024      +
6025      +
6026      +	    title1 j=l &section j=c "&draft" j=r "&rtfcommand";
129                                                                 The SAS System                                       13:55 Tuesday, March 13, 2018

6027      +		title2 j=l "&tl2";
6028      +		title3 j=l " ";
6029      +		title4 j=l " ";
6030      +		footnote10 "&ft99";
6031      +	run;
6032      +ods rtf close;	
6033      +
6034      +%mend;
6035      +
NOTE: %INCLUDE (level 1) ending.
6036       
6037       *Modular program calls;
6038       /*Program execution run 1*/
6039       %MODULARPROGRAM1(REQUESTID=rcrwp001,
6040       				 RUNID=r1,
6041                        ENROLGAP=45,
6042       				 COVERAGE=MD,
6043                        QUERYFROM=01/01/2015,
6044                        QUERYTO=12/31/2017,
6045                        QUERYFILE=cancer001_queryfile.sas7bdat,
6046                        INCQUERYFILE=,
6047                        CONDFILE=cancer001_condfile.sas7bdat,
6048                        OUTTABLESFILE=,
6049                        AGESTRAT=21-44 45-64 65-84 85+,
6050       				 SEX='M' 'F',
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
6051       				 HISPANIC='Y' 'N',
6052       				 RACE='01' '02' '03' '04' '05',
6053       				 ENROPTION=EB1,
6054       				 AGECALC=I,
6055       				 THRESHOLD=&THRESHOLD.,
6056       				 EB2DAYS=,
6057       				 EB2ENCNUMS=,
6058       				 EB2ENCLIST=,
6059        				 RequestName=%quote(RCR cancer query),
6060       				 QueryName=%quote(rcr_pmp1_wp001),
6061       				 KeepDMLocal=Y,
6062       				 DENSTRAT='S' 'R' 'H'   /*option are: 'S' 'R' 'H' 'SR' 'SH' 'HR'*/
6063       );
SYMBOLGEN:  Macro variable DRNOC resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/drnoc/
SYMBOLGEN:  Macro variable REQUESTID resolves to rcrwp001
SYMBOLGEN:  Macro variable RUNID resolves to r1
MPRINT(MODULARPROGRAM1):   proc printto 
log="/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v01/drnoc/rcrwp001r1.log" new;
MPRINT(MODULARPROGRAM1):   run;

NOTE: PROCEDURE PRINTTO used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
      

SYMBOLGEN:  Macro variable KEEPDMLOCAL resolves to Y
MLOGIC(MODULARPROGRAM1):  %IF condition &KeepDMLocal. = N is FALSE
MPRINT(MODULARPROGRAM1):   *Determine threshold category;
MLOGIC(MODULARPROGRAM1):  %LET (variable name is THRESHOLDCAT)
MLOGIC(CREATETHRESHOLDCAT):  Beginning execution.
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(&THRESHOLD.=0) is FALSE
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(0<&THRESHOLD. & &THRESHOLD.<11) is FALSE
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(10<&THRESHOLD. & &THRESHOLD.<21) is TRUE
MLOGIC(CREATETHRESHOLDCAT):  %LET (variable name is THRESHOLDCAT)
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(21<&THRESHOLD. & &THRESHOLD.<50) is FALSE
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(51<&THRESHOLD. & &THRESHOLD.<100) is FALSE
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MLOGIC(CREATETHRESHOLDCAT):  %IF condition %eval(&THRESHOLD.>100) is FALSE
                                                The SAS System

MLOGIC(CREATETHRESHOLDCAT):  Ending execution.
MPRINT(MODULARPROGRAM1):  ;
MLOGIC(MODULARPROGRAM1):  %PUT &THRESHOLDCAT.
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
11-20
MPRINT(MODULARPROGRAM1):   *Load log file into dataset;
MPRINT(MODULARPROGRAM1):   data _log;
SYMBOLGEN:  Macro variable DRNOC resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_w
            p001_nsd2_v01/drnoc/
SYMBOLGEN:  Macro variable REQUESTID resolves to rcrwp001
SYMBOLGEN:  Macro variable RUNID resolves to r1
MPRINT(MODULARPROGRAM1):   infile 
"/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v
01/drnoc/rcrwp001r1.log" truncover;
MPRINT(MODULARPROGRAM1):   input var1 $1000.;
MPRINT(MODULARPROGRAM1):   run;

NOTE: The infile 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/drnoc/rcrwp001r1.log" is:
      
      Filename=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp
      1_wp001_nsd2_v01/drnoc/rcrwp001r1.log,
      Owner Name=stephiwang,Group Name=pscanner,
      Access Permission=-rw-r--r--,
      Last Modified=13Mar2018:14:33:55,
      File Size (bytes)=7201295

NOTE: 135524 records were read from the infile 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/drnoc/rcrwp001r1.log".
      The minimum record length was 0.
      The maximum record length was 151.
NOTE: The data set WORK._LOG has 135524 observations and 1 variables.
NOTE: Compressing data set WORK._LOG decreased size by 92.43 percent. 
      Compressed is 158 pages; un-compressed would require 2086 pages.
NOTE: DATA statement used (Total process time):
      real time           0.30 seconds
      cpu time            0.17 seconds
      

MPRINT(MODULARPROGRAM1):   *copy log to dmlocal;
MPRINT(MODULARPROGRAM1):   data _null_ ;
MPRINT(MODULARPROGRAM1):   *No SAS data set is created;
MPRINT(MODULARPROGRAM1):   set _log;
SYMBOLGEN:  Macro variable DMLOCAL resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_w
                                                The SAS System

            p001_nsd2_v01/dmlocal/
SYMBOLGEN:  Macro variable REQUESTID resolves to rcrwp001
SYMBOLGEN:  Macro variable RUNID resolves to r1
MPRINT(MODULARPROGRAM1):   FILE 
"/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v
01/dmlocal/rcrwp001r1.log" ;
MPRINT(MODULARPROGRAM1):   *Output Text File;
MPRINT(MODULARPROGRAM1):   PUT var1;
MPRINT(MODULARPROGRAM1):   run ;

NOTE: The file 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/dmlocal/rcrwp001r1.log" is:
      
      Filename=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp
      1_wp001_nsd2_v01/dmlocal/rcrwp001r1.log,
      Owner Name=stephiwang,Group Name=pscanner,
      Access Permission=-rw-r--r--,
      Last Modified=13Mar2018:14:33:56

NOTE: 135524 records were written to the file 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/dmlocal/rcrwp001r1.log".
      The minimum record length was 1.
      The maximum record length was 151.
NOTE: There were 135524 observations read from the data set WORK._LOG.
NOTE: DATA statement used (Total process time):
      real time           0.26 seconds
      cpu time            0.15 seconds
      

MPRINT(MODULARPROGRAM1):   *Add a header to the log;
MPRINT(MODULARPROGRAM1):   data _header;
MPRINT(MODULARPROGRAM1):   format var1 $1000.;
MPRINT(MODULARPROGRAM1):   var1="Note: This SAS log has all numbers less than the low cell count threshold 
entered in the master.sas file masked.";
MPRINT(MODULARPROGRAM1):   output;
MPRINT(MODULARPROGRAM1):   var1="";
MPRINT(MODULARPROGRAM1):   output;
MPRINT(MODULARPROGRAM1):   run;

NOTE: The data set WORK._HEADER has 2 observations and 1 variables.
NOTE: Compressing data set WORK._HEADER increased size by 100.00 percent. 
      Compressed is 2 pages; un-compressed would require 1 pages.
NOTE: DATA statement used (Total process time):
      real time           0.02 seconds
      cpu time            0.01 seconds
      
                                                The SAS System


MPRINT(MODULARPROGRAM1):   *Find OBSERVATIONS keyword to replace low cell counts;
MPRINT(MODULARPROGRAM1):   data _log;
MPRINT(MODULARPROGRAM1):   set _header _log;
MPRINT(MODULARPROGRAM1):   format num $10. var2 $1030.;
MPRINT(MODULARPROGRAM1):   pos=indexw(var1,"observations");
MPRINT(MODULARPROGRAM1):   pos1=indexw(var1,"rows");
MPRINT(MODULARPROGRAM1):   pos2=indexw(var1,"THRESHOLD resolves to");
MPRINT(MODULARPROGRAM1):   pos3=indexw(var1,"< CritCnt <");
MPRINT(MODULARPROGRAM1):   pos4=indexw(var1,"< Excluded <");
MPRINT(MODULARPROGRAM1):   var2=var1;
MPRINT(MODULARPROGRAM1):   if pos>0 then do;
MPRINT(MODULARPROGRAM1):   num=scan(var1,countw(substr(var1,1,pos-1)));
MPRINT(MODULARPROGRAM1):   if strip(upcase(num) ne "NO") then do;
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MPRINT(MODULARPROGRAM1):   if 0 < input(num,best.) < 11 then do;
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
MPRINT(MODULARPROGRAM1):   var2=TRANWRD(var1,compress(num),"[number is masked (11-20)]");
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   if pos1>0 then do;
MPRINT(MODULARPROGRAM1):   num=scan(var1,countw(substr(var1,1,pos1-1)));
MPRINT(MODULARPROGRAM1):   if strip(upcase(num) ne "NO") then do;
SYMBOLGEN:  Macro variable THRESHOLD resolves to 11
MPRINT(MODULARPROGRAM1):   if 0 < input(num,best.) < 11 then do;
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
MPRINT(MODULARPROGRAM1):   var2=TRANWRD(var1,compress(num),"[number is masked (11-20)]");
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   if pos2>0 then do;
MPRINT(MODULARPROGRAM1):   num=scan(var1,countw(substr(var1,1,pos2+22)));
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
MPRINT(MODULARPROGRAM1):   var2=TRANWRD(var1,compress(num),"[number is masked (11-20)]");
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   if pos3>0 then do;
MPRINT(MODULARPROGRAM1):   num=scan(var1,countw(substr(var1,1,pos3+12)));
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
MPRINT(MODULARPROGRAM1):   var2=TRANWRD(var1,compress(num),"[number is masked (11-20)]");
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   if pos4>0 then do;
MPRINT(MODULARPROGRAM1):   num=scan(var1,countw(substr(var1,1,pos4+13)));
SYMBOLGEN:  Macro variable THRESHOLDCAT resolves to 11-20
MPRINT(MODULARPROGRAM1):   var2=TRANWRD(var1,compress(num),"[number is masked (11-20)]");
MPRINT(MODULARPROGRAM1):   end;
MPRINT(MODULARPROGRAM1):   run;

                                                The SAS System

NOTE: Numeric values have been converted to character values at the places given by: (Line):(Column).
      6063:15   6063:12   
NOTE: Character values have been converted to numeric values at the places given by: (Line):(Column).
      6063:9   6063:6   
NOTE: There were 2 observations read from the data set WORK._HEADER.
NOTE: There were 135524 observations read from the data set WORK._LOG.
NOTE: The data set WORK._LOG has 135526 observations and 8 variables.
NOTE: Compressing data set WORK._LOG decreased size by 93.75 percent. 
      Compressed is 197 pages; un-compressed would require 3152 pages.
NOTE: DATA statement used (Total process time):
      real time           1.10 seconds
      cpu time            0.89 seconds
      

MPRINT(MODULARPROGRAM1):   *Output altered log;
MPRINT(MODULARPROGRAM1):   data _null_ ;
MPRINT(MODULARPROGRAM1):   *No SAS data set is created;
MPRINT(MODULARPROGRAM1):   set _log;
SYMBOLGEN:  Macro variable DRNOC resolves to 
            /schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_w
            p001_nsd2_v01/drnoc/
SYMBOLGEN:  Macro variable REQUESTID resolves to rcrwp001
SYMBOLGEN:  Macro variable RUNID resolves to r1
MPRINT(MODULARPROGRAM1):   FILE 
"/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_nsd2_v
01/drnoc/rcrwp001r1.log" ;
MPRINT(MODULARPROGRAM1):   *Output Text File;
MPRINT(MODULARPROGRAM1):   PUT var2;
MPRINT(MODULARPROGRAM1):   run ;

NOTE: The file 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/drnoc/rcrwp001r1.log" is:
      
      Filename=/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp
      1_wp001_nsd2_v01/drnoc/rcrwp001r1.log,
      Owner Name=stephiwang,Group Name=pscanner,
      Access Permission=-rw-r--r--,
      Last Modified=13Mar2018:14:33:57

NOTE: 135526 records were written to the file 
      "/schaeffer-a/sch-projects/dua-data-projects/PSCANNER/svnfiles/pcori_trunk/pcori_reports/rcr_pmp1_wp001_
      nsd2_v01/drnoc/rcrwp001r1.log".
      The minimum record length was 1.
      The maximum record length was 161.
NOTE: There were 135526 observations read from the data set WORK._LOG.
NOTE: DATA statement used (Total process time):
      real time           0.30 seconds
                                                The SAS System

      cpu time            0.17 seconds
      

MPRINT(MODULARPROGRAM1):   proc datasets library=work nolist nowarn;
MPRINT(MODULARPROGRAM1):   delete _:;
MPRINT(MODULARPROGRAM1):   quit;

NOTE: Deleting WORK._AGEGROUP (memtype=DATA).
NOTE: Deleting WORK._COMBINE (memtype=DATA).
NOTE: Deleting WORK._DENOMAGEGROUP (memtype=DATA).
NOTE: Deleting WORK._DENOMHISPANIC (memtype=DATA).
NOTE: Deleting WORK._DENOMINTFORREPORT (memtype=DATA).
NOTE: Deleting WORK._DENOMNPTS (memtype=DATA).
NOTE: Deleting WORK._DENOMRACE (memtype=DATA).
NOTE: Deleting WORK._DENOMREPORT (memtype=DATA).
NOTE: Deleting WORK._DENOMSEX (memtype=DATA).
NOTE: Deleting WORK._FORREPORT (memtype=DATA).
NOTE: Deleting WORK._GROUPS (memtype=DATA).
NOTE: Deleting WORK._HEADER (memtype=DATA).
NOTE: Deleting WORK._HISPANIC (memtype=DATA).
NOTE: Deleting WORK._LOG (memtype=DATA).
NOTE: Deleting WORK._NULL (memtype=DATA).
NOTE: Deleting WORK._NUMINTFORREPORT (memtype=DATA).
NOTE: Deleting WORK._NUMINTFORREPORT2 (memtype=DATA).
NOTE: Deleting WORK._NUMREPORT (memtype=DATA).
NOTE: Deleting WORK._OVERALL (memtype=DATA).
NOTE: Deleting WORK._POSTADJUSTDENOMREPORT (memtype=DATA).
NOTE: Deleting WORK._POSTADJUSTNUMREPORT (memtype=DATA).
NOTE: Deleting WORK._RACE (memtype=DATA).
NOTE: Deleting WORK._SEX (memtype=DATA).
NOTE: Deleting WORK._SQUARE (memtype=DATA).
NOTE: Deleting WORK._SQUARE0 (memtype=DATA).
NOTE: Deleting WORK._SUMMARY (memtype=DATA).
NOTE: Deleting WORK._TOC (memtype=DATA).
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           1.03 seconds
      cpu time            0.01 seconds
      

MLOGIC(MODULARPROGRAM1):  Ending execution.

NOTE: SAS Institute Inc., SAS Campus Drive, Cary, NC USA 27513-2414
NOTE: The SAS System used:
      real time           38:36.80
      cpu time            19:33.52
      
